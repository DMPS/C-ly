/**
 *  Copyright (c) 2015 Alcatel-Lucent
 *
 *  Licensed under the Apache License, Version 2.0 (the "License");
 *  you may not use this file except in compliance with the License.
 *  You may obtain a copy of the License at
 *
 *  http://www.apache.org/licenses/LICENSE-2.0
 *
 *  Unless required by applicable law or agreed to in writing, software
 *  distributed under the License is distributed on an "AS IS" BASIS,
 *  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 *  See the License for the specific language governing permissions and
 *  limitations under the License.
 */

// orca/msrp-stack/src/ChunkReceiver.js
var CrocMSRP=(function(a){a.ChunkReceiver=function(c,d){if(!c||!c instanceof a.Message.Request){throw new TypeError("Missing or unexpected parameter")}this.firstChunk=c;this.totalBytes=c.byteRange.total;this.bufferedChunks=[];this.bufferedBytes=0;this.bufferSize=d;this.blob=new Blob();this.size=0;this.receivedBytes=0;this.aborted=false;this.remoteAbort=false;this.incontiguousChunks={};this.isFile=c.contentDisposition&&(c.contentDisposition.type==="attachment"||c.contentDisposition.type==="render");this.processChunk(c)};a.ChunkReceiver.prototype.processChunk=function(d){var e,h,f=this.size+this.bufferedBytes+1;if(this.aborted){return false}if(d.messageId!==this.firstChunk.messageId){console.error("Chunk has wrong message ID!");return false}this.lastReceive=new Date().getTime();console.log("Chunk receiver's processChunk() lastReceive: "+this.lastReceive);if(d.body instanceof ArrayBuffer){e=new Uint8Array(d.body);h=e.byteLength}else{if(d.isBase64){e=d.body;h=e.length}else{e=d.body;h=e.length}}this.receivedBytes+=h;switch(d.continuationFlag){case a.Message.Flag.continued:break;case a.Message.Flag.end:this.totalBytes=d.byteRange.start+h-1;break;case a.Message.Flag.abort:this.abort();this.remoteAbort=true;return false}if(d.byteRange.start===f){console.debug("contigous chunk : "+f);this.bufferedChunks.push(e);this.bufferedBytes+=h;f+=h;while(!a.util.isEmpty(this.incontiguousChunks)){var c=this.incontiguousChunks[f];if(!c){break}delete this.incontiguousChunks[f];this.bufferedChunks.push(c);if(c instanceof ArrayBuffer){h=c.byteLength}else{h=c.size;if(h===undefined){h=c.length}}this.bufferedBytes+=h;f+=h}if(this.bufferedBytes>=this.bufferSize||this.size+this.bufferedBytes===this.totalBytes){console.debug("Buffer full or end reached");b(this)}}else{if(d.byteRange.start>f){console.debug("incontiguousChunks chunk start "+d.byteRange.start+", nextStart: "+f);this.incontiguousChunks[d.byteRange.start]=e}else{var g=[];console.debug("duplicate chunk received start "+d.byteRange.start+", nextStart: "+f);b(this);if(d.byteRange.start>1){g.push(this.blob.slice(0,d.byteRange.start-1))}g.push(e);if(d.byteRange.start+h<=this.size){g.push(this.blob.slice(d.byteRange.start+h-1))}if(d.isBase64){this.blob=g.join("");this.size=this.blob.length}else{this.blob=new Blob(g,{type:this.firstChunk.contentType});this.size=this.blob.size}}}return true};a.ChunkReceiver.prototype.isComplete=function(){return this.aborted||(this.size===this.totalBytes)};a.ChunkReceiver.prototype.abort=function(){this.aborted=true};function b(j){var h,c,g,f,e,d,k;if(j.firstChunk.isBase64){h=j.bufferedChunks.join("");console.log("data: "+h+"; type: "+typeof h);stringArray=h.split(",");if(stringArray.length===2){k=stringArray[1]}else{k=stringArray[0]}base64StringLen=k.length;base64String4NextChunkLen=base64StringLen%4;completeBase64StringLen=base64StringLen-base64String4NextChunkLen;base64StringToParse=k.slice(0,completeBase64StringLen);base64String4NextChunk=k.slice(completeBase64StringLen);c=atob(base64StringToParse);g=h.slice(h.indexOf(":")+1,h.indexOf(";"));f=new ArrayBuffer(c.length);e=new Uint8Array(f);for(d=0;d<c.length;d++){e[d]=c.charCodeAt(d)}newBlob=new Blob([f],{type:g||j.firstChunk.contentType});mergedBlob=new Blob([j.blob,newBlob]);j.blob=mergedBlob;j.size+=h.length-base64String4NextChunkLen;j.bufferedChunks=[];j.bufferedChunks.push(base64String4NextChunk);j.bufferedBytes=base64String4NextChunkLen}else{h=j.bufferedChunks.join("");console.log("Writing received chunks to Blob. receiver.firstChunk.contentType "+j.firstChunk.contentType+", size "+h.length);f=new ArrayBuffer(h.length);e=new Uint8Array(f);for(d=0;d<h.length;d++){e[d]=h.charCodeAt(d)}j.blob=new Blob([j.blob,f],{type:j.firstChunk.contentType});j.size=j.blob.size;console.log("Writing received chunks to Blob. size: "+j.size);j.bufferedChunks=[];j.bufferedBytes=0}}return a}(CrocMSRP||{}));

// orca/msrp-stack/src/ChunkSender.js
var CrocMSRP=(function(a){a.ChunkSender=function(d,b,f,e,c){if(!d){throw new TypeError("Missing mandatory parameter")}if(!b){this.blob=new Blob();this.contentType=null;this.disposition=null}else{if(b instanceof File){console.log(" ChunkSender Body is of type File");this.blob=b;this.contentType=f||b.type;this.disposition=e||"attachment; filename="+b.name}else{if(b instanceof Blob){console.log("ChunkSender Body is of type Blob");this.blob=b;this.contentType=f||b.type;this.disposition=e}else{if(b instanceof String||typeof b==="string"){console.log("ChunkSender Body is of type String");this.blob=new Blob([b]);this.contentType=f||"text/plain";this.disposition=e;this.bodyText=b}else{if(b instanceof ArrayBuffer){console.log("ChunkSender Body is of type ArrayBuffer... keeping blob as ArrayBuffer ");this.arraybuffer=new Uint8Array(b);this.contentType=f||"application/octet-stream";this.disposition=e}else{if(b instanceof ArrayBufferView){console.log("ChunkSender Body is of type ArrayBufferView ");this.blob=new Blob([b]);this.contentType=f||"application/octet-stream";this.disposition=e}else{throw new TypeError("Body has unexpected type:",b)}}}}}}if(this.arraybuffer){this.size=this.arraybuffer.length}else{this.size=this.blob.size}console.debug("Total size of the file to send: "+this.size);this.session=d;this.config=d.config;this.messageId=a.util.newMID();if(this.contentType===""){this.contentType="application/octet-stream"}this.description=c;this.sentBytes=0;this.ackedBytes=0;this.incontiguousReports={};this.incontiguousReportCount=0;this.reportTimer=null;this.onReportTimeout=null;this.aborted=false;this.remoteAbort=false};a.ChunkSender.prototype.getNextChunk=function(){var c;console.debug("getNextChunk. ");c=new a.Message.OutgoingRequest(this.session,"SEND");c.sender=this;c.addHeader("message-id",this.messageId);c.addHeader("success-report","yes");c.addHeader("failure-report","yes");if(this.aborted){c.continuationFlag=a.Message.Flag.abort}else{var e=this.sentBytes+1,b=Math.min(this.sentBytes+this.config.chunkSize,this.size);c.byteRange={start:e,end:b,total:this.size};if(this.size>0){if(this.sentBytes===0){if(this.disposition){c.addHeader("content-disposition",this.disposition)}else{c.addHeader("content-disposition","inline")}if(this.description){c.addHeader("content-description",this.description)}}c.contentType=this.contentType;if(this.arraybuffer){c.body=this.arraybuffer.subarray(this.sentBytes,b);console.debug("Slicing the ArrayBuffer for next chunk from "+this.sentBytes+"-"+b+", chunk.body.length: "+c.body.length)}else{c.body=this.blob.slice(this.sentBytes,b);console.debug("Slicing the blob for next chunk from "+this.sentBytes+"-"+b+"chunk.body.size: "+c.body.size)}}if(b<this.size){c.continuationFlag=a.Message.Flag.continued}else{if(this.onReportTimeout){var d=this;this.reportTimer=setTimeout(function(){d.onReportTimeout();d.reportTimer=null},this.config.reportTimeout)}}this.sentBytes=b}return c};a.ChunkSender.prototype.processReport=function(b){var d,c=true;if(b.messageId!==this.messageId){console.error("REPORT has wrong message ID!");return}if(b.status!==a.Status.OK){this.abort();this.remoteAbort=true}else{if(b.byteRange.start<=this.ackedBytes+1){if(b.byteRange.end>this.ackedBytes){this.ackedBytes=b.byteRange.end}}else{if(this.incontiguousReportCount>16){this.resume();return}else{this.incontiguousReports[b.byteRange.start]=b.byteRange.end;this.incontiguousReportCount++;return}}while(c){c=false;for(d in this.incontiguousReports){if(d<=this.ackedBytes+1){if(this.incontiguousReports[d]>this.ackedBytes){this.ackedBytes=this.incontiguousReports[d]}delete this.incontiguousReports[d];this.incontiguousReportCount--;c=true}}}}if(this.isComplete()&&this.reportTimer){clearTimeout(this.reportTimer);this.reportTimer=null}return};a.ChunkSender.prototype.isSendComplete=function(){return this.aborted||(this.sentBytes>=this.size)};a.ChunkSender.prototype.isComplete=function(){return this.aborted||(this.ackedBytes>=this.size)};a.ChunkSender.prototype.resume=function(){this.sentBytes=this.ackedBytes;this.incontiguousReports={};this.incontiguousReportCount=0;console.log("Resuming at offset "+this.sentBytes)};a.ChunkSender.prototype.abort=function(){this.aborted=true;if(this.reportTimer){clearTimeout(this.reportTimer);var b=this;this.reportTimer=setTimeout(function(){b.onReportTimeout();b.reportTimer=null},0)}};return a}(CrocMSRP||{}));

// orca/msrp-stack/src/ConnectionConfig.js
var CrocMSRP=(function(a){a.ConnectionConfig=function(){this.authority=a.util.newUriAuthority();this.username="anonymous";this.password="";this.digestMethod=null;this.authExpires=null;this.reportTimeout=120000;this.acceptTypes=["*"];this.acceptWrappedTypes=null;this.chunkSize=2048;this.maxOutstandingSends=(32*1024/this.chunkSize);this.chunkTimeout=30*1000;this.recvBuffer=1024*1024};return a}(CrocMSRP||{}));

// orca/msrp-stack/src/ContentType.js
var CrocMSRP=(function(a){a.ContentType=function(){this.type="";this.subtype="";this.params={}};a.ContentType.prototype.parseSdpTypeSelector=function(c){var b=0,e,f,d;e=c.indexOf("/",b);if(e===-1){return}this.type=c.slice(b,e);b=e+1;e=b;while(e<c.length){if(c.charAt(e)===";"){break}e++}this.subtype=c.slice(b,e);b=e+1;this.params={};while(c.charAt(e)===";"){e=c.indexOf("=",b);if(e===-1){b=c.length;return}f=c.slice(b,e);b=e+1;if(c.charAt(b)!=='"'){b=c.length;return}b++;e=c.indexOf('"',b);if(e===-1){b=c.length;return}d=c.slice(b,e);b=e+1;this.params[f]=a.util.decodeSdpFileName(d)}};a.ContentType.prototype.toSdpTypeSelector=function(){var b="",c;b=b.concat(this.type,"/",this.subtype);for(c in this.params){b=b.concat(";",c,'="',a.util.encodeSdpFileName(this.params[c]),'"')}return b};a.ContentType.prototype.parseContentTypeHeader=function(f){var b=0,d,e,c;d=f.indexOf("/",b);if(d===-1){return}this.type=f.slice(b,d);b=d+1;d=b;while(d<f.length){if(f.charAt(d)===";"){break}d++}this.subtype=f.slice(b,d);b=d+1;this.params={};while(f.charAt(d)===";"){d=f.indexOf("=",b);if(d===-1){b=f.length;return}e=f.slice(b,d);b=d+1;if(f.charAt(b)==='"'){b++;d=f.indexOf('"',b);if(d===-1){b=f.length;return}while(f.charAt(d-1)==="\\"){d=f.indexOf('"',d+1);if(d===-1){b=f.length;return}}}else{d=f.indexOf(" ",b);if(d===-1){d=f.length}}c=f.slice(b,d);b=d+1;this.params[e]=a.util.decodeQuotedString(c)}};a.ContentType.prototype.toContentTypeHeader=function(){var c="",b;c=c.concat(this.type,"/",this.subtype);for(b in this.params){c=c.concat(";",b,'="',a.util.encodeQuotedString(this.params[b]),'"')}return c};return a}(CrocMSRP||{}));

// orca/msrp-stack/src/CPIMParser.js
var CrocMSRP=(function(d){var f="\r\n";d.CPIMMessage=function(){this.contentType=null;this.from=null;this.to=null;this.cc=null;this.dateTime=null;this.contentDisposition=null;this.subject=null;this.ns=null;this.require=null;this.headers={}};d.CPIMMessage.prototype.addHeader=function(p,q){switch(p){case"To":this.to=q;return;case"From":this.from=q;return;case"cc":this.cc=q;return;case"Content-Type":this.contentType=q;return;case"DateTime":this.dateTime=q;return;case"Subject":this.subject=q;return;case"NS":this.ns=q;return;case"Require":this.require=q;return;case"Content-Disposition":this.contentDisposition=q;return;default:break}console.log("add cpim header, name: "+p+", value: "+q);if(this.headers[p]){this.headers[p].push(q)}else{this.headers[p]=[q]}};d.parseCPIMMessage=function(q){console.log("Enter parseCPIMMessage().");var v,u=0,s,t,r;var p=new d.CPIMMessage();r=q.body;if(r instanceof ArrayBuffer){console.debug("data is ArrayBuffer");v=String.fromCharCode.apply(null,new Uint8Array(r))}else{if(r instanceof String||typeof r==="string"){console.debug("data is String");v=r}else{console.log("Unexpected parameter type");return null}}console.log("CPIM message: "+v);while(true){t=h(v,u,p);if(t>0){u=t}else{if(t===0){break}else{return null}}}if(!p.parseKnownHeaders(p)){console.log("Error parsing message: parseKnownHeaders failed");return null}u+=f.length;if(p.contentType.match(/application\/octet-stream/)){console.log("parseCPIMMessage. Body startIndex "+u+", endIndex "+s);q.body=r.slice(u,s)}else{console.log("parseCPIMMessage(): Incoming chunk: NOT ArrayBuffer. startIndex "+u+", endIndex "+s);q.body=v.substring(u,s);console.log("parseCPIMMessage msrpReq.body:"+q.body)}};function k(p){return p.replace(/^\s+/,"").replace(/\s+$/,"")}function c(p){return p.replace(/^"/,"").replace(/"$/,"")}function h(v,u,r){var t,q,p,s;if(v.substr(u,2)==="\r\n"){u+=2;if(v.indexOf(":",u)===-1){return 0}}t=v.indexOf("\r\n",u);if(t===-1){console.log("Error parsing header: no CRLF");return -1}q=v.indexOf(":",u);if(q===-1){console.log("Error parsing header: no colon");return -1}p=k(v.substring(u,q));if(p.length===0){console.log("Error parsing header: no name");return -1}s=k(v.substring(q+1,t));if(p.length===0){console.log("Error parsing header: no value");return -1}console.log("getNextHeader(). Got header: "+p+": "+s);r.addHeader(p,s);return t+2}function m(q,p){if(q.length!==1){console.log("Multiple From headers");return false}p.from=q[0];return true}function i(q,p){if(q.length!==1){console.log("Multiple From headers");return false}p.to=q[0];return true}function o(q,p){if(q.length!==1){console.log("Multiple From headers");return false}p.cc=q[0];return true}function j(q,p){if(q.length!==1){console.log("Multiple Subject headers");return false}p.subject=q[0];return true}function e(q,p){if(q.length!==1){console.log("Multiple DateTime headers");return false}p.dateTime=q[0];return true}function n(q,p){if(q.length!==1){console.log("Multiple NS headers");return false}p.ns=q[0];return true}function a(q,p){if(q.length!==1){console.log("Multiple Subject headers");return false}p.require=q[0];return true}function b(s,q){var r,p,t;if(s.length!==1){console.log("Multiple Content-Disposition headers");return false}r=s[0].split(";");if(r.length<1){console.log("Unexpected Content-Disposition header: "+s[0]);return false}q.contentDisposition={};q.contentDisposition.type=k(r.shift());q.contentDisposition.param={};for(p in r){t=r[p].split("=");if(t.length!==2){console.log("Unexpected Content-Disposition param: "+r[p]);return false}q.contentDisposition.param[k(t[0])]=c(k(t[1]))}return true}function l(q,p){if(q.length>1){console.log("Multiple Content-Type headers");return false}if(q[0]){p.contentType=k(q[0]);if(p.contentType.length<1||p.contentType.match(/text\/plain|application\/octet-stream/)){console.log("parsed content type: "+msgObj.contentType)}else{console.warn("Unknow content type: "+msgObj.contentType);return false}}return true}var g={"Content-Type":l,From:m,To:i,cc:o,DateTime:e,"Content-Disposition":b,Subject:j,NS:n,Require:a};d.CPIMMessage.prototype.parseKnownHeaders=function(p){var r,q;for(r in p.headers){q=g[r];if(!q){continue}if(!q(p.headers[r],p)){console.log("Parsing failed for header "+r);return false}}return true};return d}(CrocMSRP||{}));

// orca/msrp-stack/src/Exceptions.js
var CrocMSRP=(function(a){a.Exceptions={};a.Exceptions.UnsupportedMedia=function(){};a.Exceptions.UnsupportedMedia.prototype=new Error();a.Exceptions.UnsupportedMedia.prototype.constructor=a.Exceptions.UnsupportedMedia;a.Exceptions.AbortTransfer=function(){};a.Exceptions.AbortTransfer.prototype=new Error();a.Exceptions.AbortTransfer.prototype.constructor=a.Exceptions.AbortTransfer;return a}(CrocMSRP||{}));

// orca/msrp-stack/src/Message.js
var CrocMSRP=(function(a){var b="\r\n";a.Message={};a.Message.Flag={continued:"+",end:"$",abort:"#"};a.Message.Message=function(){};a.Message.Message.prototype.initMessage=function(){this.tid=null;this.toPath=[];this.fromPath=[];this.headers={};this.continuationFlag=a.Message.Flag.end};a.Message.Message.prototype.addHeader=function(c,d){c=a.util.normaliseHeader(c);switch(c){case"To-Path":this.toPath=d.split(" ");return;case"From-Path":this.fromPath=d.split(" ");return;case"Content-Type":this.contentType=d;return;default:break}if(this.headers[c]){this.headers[c].push(d)}else{this.headers[c]=[d]}};a.Message.Message.prototype.getHeader=function(c){c=a.util.normaliseHeader(c);if(c in this.headers){if(this.headers[c].length>1){return this.headers[c]}return this.headers[c][0]}return null};a.Message.Message.prototype.getEndLineNoFlag=function(){return"-------"+this.tid};a.Message.Message.prototype.getEndLine=function(){return this.getEndLineNoFlag().concat(this.continuationFlag,b)};a.Message.Request=function(){};a.Message.Request.prototype=new a.Message.Message();a.Message.Request.prototype.constructor=a.Message.Request;a.Message.Request.prototype.initRequest=function(){this.initMessage();this.method=null;this.contentType=null;this.body=null};a.Message.Request.prototype.addBody=function(d,c){this.contentType=d;this.body=c};a.Message.Request.prototype.addTextBody=function(c){this.addBody("text/plain",c)};a.Message.Response=function(){};a.Message.Response.prototype=new a.Message.Message();a.Message.Response.prototype.constructor=a.Message.Response;a.Message.Response.prototype.initResponse=function(){this.initMessage();this.status=null;this.comment=null};a.Message.OutgoingRequest=function(c,d){if(!c||!d){throw new TypeError("Required parameter is missing")}this.initRequest();this.tid=a.util.newTID();this.method=d;this.toPath=c.toPath;this.fromPath=[c.localUri];this.session=c;this.byteRange=null};a.Message.OutgoingRequest.prototype=new a.Message.Request();a.Message.OutgoingRequest.prototype.constructor=a.Message.OutgoingRequest;a.Message.OutgoingRequest.prototype.encode=function(){var k="",d,e=this.contentType,c=this.getEndLine();if(this.body&&(this.body instanceof String||typeof this.body==="string")){while(this.body.indexOf(c)!==-1){this.tid=a.util.newTID();c=this.getEndLine()}}k=k.concat("MSRP ",this.tid," ",this.method,b);k=k.concat("To-Path: ",this.toPath.join(" "),b);k=k.concat("From-Path: ",this.fromPath.join(" "),b);if(this.byteRange){var g=this.byteRange,f=(g.total<0?"*":g.total);this.addHeader("byte-range",g.start+"-"+g.end+"/"+f)}for(d in this.headers){k=k.concat(d,": ",this.headers[d].join(" "),b)}if(e&&this.body){if(e instanceof a.ContentType){e=e.toContentTypeHeader()}k=k.concat("Content-Type: ",e,b,b);if(this.body instanceof String||typeof this.body==="string"){console.log("Sending String");k=k.concat(this.body,b,c)}else{if(this.body instanceof Uint8Array){console.log("Sending ArrayBuffer/Uint8Array");if(this.body instanceof File){console.log("this.body is File")}else{if(this.body instanceof Blob){console.log("this.body is Blob")}else{if(this.body instanceof ArrayBuffer){console.log("this.body is ArrayBuffer")}else{console.log("this.body is other")}}}totallen=k.length+this.body.length+b.length+c.length;console.log("Using ArrayBuffer instead of Blob. length: "+totallen+",this.body.length:"+this.body.length);ab=new ArrayBuffer(totallen);uia=new Uint8Array(ab);for(i=0,j=0;i<k.length;i++,j++){uia[i]=k.charCodeAt(j)}for(j=0;j<this.body.length;j++,i++){uia[i]=this.body[j]}for(j=0;j<b.length;j++,i++){uia[i]=b.charCodeAt(j)}for(j=0;j<c.length;j++,i++){uia[i]=c.charCodeAt(j)}k=ab;console.log("Sending chunk of length:"+uia.length);function h(n,o,m){var l=new FileReader();l.onload=function(p){o(p.target.result)};l.onerror=function(p){onFail(p.target.error)};l.readAsBinaryString(new Blob([n],{type:"application/octet-stream"}))}h(uia,function(l){console.log("chunk contents  (length: "+l.length+"): "+l)},function(l){console.log("chunk not sent. error"+l)})}else{console.log("Sending Blob");k=new Blob([k,this.body,b,c])}}}else{k+=c}return k};a.Message.IncomingRequest=function(c,d){if(!c||!d){return null}this.initRequest();this.tid=c;this.method=d;switch(d){case"SEND":this.responseOn={success:true,failure:true};break;case"REPORT":this.responseOn={success:false,failure:false};break}this.byteRange={start:1,end:-1,total:-1}};a.Message.IncomingRequest.prototype=new a.Message.Request();a.Message.IncomingRequest.prototype.constructor=a.Message.IncomingRequest;a.Message.OutgoingResponse=function(e,d,c){if(!e||!d){return null}this.initResponse();this.tid=e.tid;this.status=c||a.Status.OK;this.comment=a.StatusComment[this.status];if(e.method==="SEND"){this.toPath=e.fromPath.slice(0,1)}else{this.toPath=e.fromPath}this.fromPath=[d.toString()]};a.Message.OutgoingResponse.prototype=new a.Message.Response();a.Message.OutgoingResponse.prototype.constructor=a.Message.OutgoingResponse;a.Message.OutgoingResponse.prototype.encode=function(){var d="",c;d=d.concat("MSRP ",this.tid," ",this.status);if(this.comment){d=d.concat(" ",this.comment)}d+=b;d=d.concat("To-Path: ",this.toPath.join(" "),b);d=d.concat("From-Path: ",this.fromPath.join(" "),b);for(c in this.headers){d=d.concat(c,": ",this.headers[c].join(" "),b)}return d+this.getEndLine()};a.Message.IncomingResponse=function(d,c,e){if(!d||!c){return null}this.initResponse();this.tid=d;this.status=c;this.comment=e;this.request=null;this.authenticate=[]};a.Message.IncomingResponse.prototype=new a.Message.Response();a.Message.IncomingResponse.prototype.constructor=a.Message.IncomingResponse;return a}(CrocMSRP||{}));

// orca/msrp-stack/src/parser.js
var CrocMSRP=(function(p){var l="\r\n";p.parseMessage=function(v){var u,C=0,x,B,z,w,s,t,A;if(v instanceof ArrayBuffer){console.debug("data is ArrayBuffer");u=String.fromCharCode.apply(null,new Uint8Array(v))}else{if(v instanceof String||typeof v==="string"){console.debug("data is String");u=v}else{console.log("Unexpected parameter type");return null}}x=u.indexOf(l);if(x===-1){console.log("Error parsing message: no CRLF");return null}B=u.substring(C,x);z=B.split(" ");if(z.length<3||z[0]!=="MSRP"||z[1].length===0||z[2].length===0){console.log("Error parsing message: unexpected first line format: "+B);return null}if(z[2].length===3&&(w=parseInt(z[2],10))){if(z.length>3){var y=z.slice(3).join(" ");s=new p.Message.IncomingResponse(z[1],w,y)}else{s=new p.Message.IncomingResponse(z[1],w)}}else{if(z.length===3){s=new p.Message.IncomingRequest(z[1],z[2])}else{console.log("Error parsing message: unexpected first line format: "+B);return null}}C=x+l.length;while(true){t=g(u,C,s);if(t>0){C=t}else{if(t===0){break}else{return null}}}if(!q(s)){console.log("Error parsing message: parseKnownHeaders failed");return null}A=s.getEndLineNoFlag();if(u.substr(C,l.length)===l){C+=l.length;x=u.indexOf(l+A,C);if(x===-1){console.log("Error parsing message: no end line after body");return null}if(v instanceof ArrayBuffer){console.log("Incoming chunk: ArrayBuffer. startIndex "+C+", endIndex "+x);s.body=v.slice(C,x)}else{console.log("parseMessage(): Incoming chunk: NOT ArrayBuffer. startIndex "+C+", endIndex "+x);s.body=u.substring(C,x);console.log("parseMessage msgObj.body:"+s.body)}s.continuationFlag=u.charAt(x+l.length+A.length)}else{s.continuationFlag=u.charAt(C+A.length)}return s};function k(s){return s.replace(/^\s+/,"").replace(/\s+$/,"")}function m(s){return s.replace(/^"/,"").replace(/"$/,"")}function g(z,y,u){var w,t,s,v,x=u.getEndLineNoFlag();if(z.substr(y,2)==="\r\n"||z.substr(y,x.length)===x){return 0}w=z.indexOf("\r\n",y);if(w===-1){console.log("Error parsing header: no CRLF");return -1}t=z.indexOf(":",y);if(t===-1){console.log("Error parsing header: no colon");return -1}s=k(z.substring(y,t));if(s.length===0){console.log("Error parsing header: no name");return -1}v=k(z.substring(t+1,w));if(s.length===0){console.log("Error parsing header: no value");return -1}u.addHeader(s,v);return w+2}function d(y,x,w){var v,u,s,t;v=y.indexOf("=",x);if(v===-1){return -1}u=v+1;if(y.charAt(u)==='"'){u=y.indexOf('"',u+1);if(u===-1){return -1}}u=y.indexOf(",",u);if(u===-1){u=y.length}s=k(y.substring(x,v));t=m(k(y.substring(v+1,u)));if(s.length===0||t.length===0){return -1}w[s]=t;return u+1}function r(w,t){var x,v,s,u;for(x in w){v=w[x];s={};if(!v.match(/^Digest /)){return false}u=7;while(u!==-1&&u<v.length){u=d(v,u,s)}if(u===-1){return false}t.authenticate.push(s)}return true}function j(x,u){var w,t={},v,s;if(x.length!==1){return false}w=x[0];v=w.indexOf("-");s=w.indexOf("/",v);if(v===-1||s===-1){console.log("Unexpected Byte-Range format: "+w);return false}t.start=parseInt(k(w.substring(0,v)),10);t.end=k(w.substring(v+1,s));if(t.end==="*"){t.end=-1}else{t.end=parseInt(t.end,10)}t.total=k(w.substring(s+1));if(t.total==="*"){t.total=-1}else{t.total=parseInt(t.total,10)}if(isNaN(t.start)||isNaN(t.end)||isNaN(t.total)){console.log("Unexpected Byte-Range values: "+w);return false}u.byteRange=t;return true}function h(t,s){if(t.length!==1){console.log("Multiple Failure-Report headers");return false}switch(t[0].toLowerCase()){case"yes":s.responseOn={success:true,failure:true};break;case"no":s.responseOn={success:false,failure:false};break;case"partial":s.responseOn={success:false,failure:true};break;default:console.log("Unexpected Failure-Report header: "+t[0]);return false}return true}function a(u,s){var t;if(s instanceof p.Message.Response){console.log("Ignoring Status header on response");return true}if(u.length!==1){console.log("Multiple Status headers");return false}t=u[0].split(" ");if(t.length<2||t.shift()!=="000"){console.log("Unexpected Status header: "+u[0]);return false}s.status=parseInt(t.shift(),10);s.comment=t.join(" ");return true}function b(t,s){if(t.length!==1){console.log("Multiple Use-Path headers");return false}s.usePath=t[0].split(" ");if(s.usePath.length<1){console.log("Unexpected Use-Path header: "+t[0]);return false}return true}function o(t,s){if(t.length!==1){console.log("Multiple Expires headers");return false}s.expires=parseInt(t[0],10);if(isNaN(s.expires)){console.log("Unexpected Expires header: "+t[0]);return false}return true}function e(v,t){var u,s,w;if(t instanceof p.Message.Response){console.log("Ignoring Content-Disposition header on response");return true}if(v.length!==1){console.log("Multiple Content-Disposition headers");return false}u=v[0].split(";");if(u.length<1){console.log("Unexpected Content-Disposition header: "+v[0]);return false}t.contentDisposition={};t.contentDisposition.type=k(u.shift());t.contentDisposition.param={};for(s in u){w=u[s].split("=");if(w.length!==2){console.log("Unexpected Content-Disposition param: "+u[s]);return false}t.contentDisposition.param[k(w[0])]=m(k(w[1]))}return true}function f(t,s){if(t.length>1){console.log("Multiple Content-Type headers");return false}if(t[0]){s.contentType=k(t[0]);if(s.contentType.length<1||s.contentType.match(/message\/CPIM|text\/plain|application\/octet-stream/)){console.log("parsed content type: "+s.contentType)}else{console.warn("Unknow content type: "+s.contentType);return false}}return true}function i(t,s){if(t.length>1){console.log("Multiple Content-Transfer-Encoding headers");return false}if(t[0]){s.contentTransferEncoding=k(t[0]);if(s.contentTransferEncoding.length<1){console.log("Unexpected Message-ID header: "+t[0]);return false}}return true}function c(t,s){if(t.length!==1){console.log("Multiple Message-ID headers");return false}s.messageId=k(t[0]);if(s.messageId.length<1){console.log("Unexpected Message-ID header: "+t[0]);return false}return true}var n={"Message-ID":c,"Failure-Report":h,"Byte-Range":j,Status:a,"Content-Disposition":e,"Content-Type":f,"Content-Transfer-Encoding":i,"WWW-Authenticate":r,"Use-Path":b,Expires:o,"Min-Expires":o,"Max-Expires":o};function q(s){var u,t;for(u in s.headers){t=n[u];if(!t){continue}if(!t(s.headers[u],s)){console.log("Parsing failed for header "+u);return false}}return true}return p}(CrocMSRP||{}));

// orca/msrp-stack/src/Status.js
var CrocMSRP=(function(a){a.Status={OK:200,BAD_REQUEST:400,UNAUTHORIZED:401,FORBIDDEN:403,REQUEST_TIMEOUT:408,STOP_SENDING:413,UNSUPPORTED_MEDIA:415,INTERVAL_OUT_OF_BOUNDS:423,SESSION_DOES_NOT_EXIST:481,INTERNAL_SERVER_ERROR:500,NOT_IMPLEMENTED:501,WRONG_CONNECTION:506};a.StatusComment={200:"OK",400:"Bad Request",401:"Unauthorized",403:"Forbidden",408:"Request Timeout",413:"Stop Sending Message",415:"Unsupported Media Type",423:"Interval Out-of-Bounds",481:"Session Does Not Exist",500:"Internal Server Error",501:"Not Implemented",506:"Wrong Connection"};return a}(CrocMSRP||{}));

// orca/msrp-stack/src/Uri.js
var CrocMSRP=(function(a){a.Uri=function(b){this.secure=false;this.user=null;this.authority="";this.port=null;this.sessionId="";this.transport="tcp";if(b){this.uri=b;this.parse(b)}};a.Uri.prototype.parse=function(f){var d=f.indexOf("://"),c,e,h,b,g;if(d===-1){throw new TypeError("Invalid MSRP URI: "+f)}c=f.substring(0,d);switch(c.toLowerCase()){case"msrp":this.secure=false;break;case"msrps":this.secure=true;break;default:throw new TypeError("Invalid MSRP URI (unknown scheme): "+f)}b=f.indexOf("/",d+3);if(b===-1){throw new TypeError("Invalid MSRP URI (no session ID): "+f)}this.authority=f.substring(d+3,b);e=this.authority.indexOf("@");if(e!==-1){this.user=this.authority.substr(0,e);this.authority=this.authority.substr(e+1)}h=this.authority.indexOf(":");if(h!==-1){this.port=this.authority.substr(h+1);this.authority=this.authority.substr(0,h)}g=f.indexOf(";",d+3);if(g===-1){throw new TypeError("Invalid MSRP URI (no transport): "+f)}this.sessionId=f.substring(b+1,g);this.transport=f.substring(g+1);return true};a.Uri.prototype.toString=function(){var b="msrp";if(this.uri){return this.uri}if(this.secure){b+="s"}b+="://";if(this.user){b+=this.user+"@"}b+=this.authority;if(this.port){b+=":"+this.port}b+="/"+this.sessionId+";"+this.transport;this.uri=b;return b};a.Uri.prototype.equals=function(b){if(typeof b==="string"||b instanceof String){b=new a.Uri(b)}if(!b instanceof Object){return false}if(b.secure!==this.secure){return false}if(b.authority.toLowerCase()!==this.authority.toLowerCase()){return false}if(parseInt(b.port,10)!==parseInt(this.port,10)){return false}if(b.sessionId!==this.sessionId){return false}if(b.transport.toLowerCase()!==this.transport.toLowerCase()){return false}return true};return a}(CrocMSRP||{}));

// orca/msrp-stack/src/util.js
var CrocMSRP=(function(b){var a=2208988800;b.util={newUriAuthority:function(){return Math.random().toString(36).substr(2,8)+".invalid"},newSID:function(){return Math.random().toString(36).substr(2,10)},newTID:function(){return Math.random().toString(36).substr(2,8)},newMID:function(){var c=new Date();return b.util.dateToNtpTime(c)+"."+Math.random().toString(36).substr(2,8)},newFileTransferId:function(){var c=new Date();return b.util.dateToNtpTime(c)+"."+Math.random().toString(36).substr(2)},normaliseHeader:function(d){var e=d.toLowerCase().split("-"),c,f="";for(c in e){if(c!=="0"){f+="-"}f+=e[c].charAt(0).toUpperCase()+e[c].substring(1)}switch(f){case"Www-Authenticate":return"WWW-Authenticate";case"Message-Id":return"Message-ID"}return f},isEmpty:function(d){var c;for(c in d){if(d.hasOwnProperty(c)){return false}}return true},ntpTimeToDate:function(c){return new Date((parseInt(c,10)-a)*1000)},dateToNtpTime:function(c){return parseInt(c.getTime()/1000,10)+a},encodeSdpFileName:function(c){return c.replace(/%/g,"%25").replace(/\0/g,"%00").replace(/\n/g,"%0A").replace(/\r/g,"%0D").replace(/"/g,"%22")},decodeSdpFileName:function(c){return c.replace(/%00/g,"\0").replace(/%0A/gi,"\n").replace(/%0D/gi,"\r").replace(/%22/g,'"').replace(/%25/g,"%")},encodeQuotedString:function(e){var d=e.split(""),c;for(c in d){switch(d[c]){case'"':case"\r":case"\\":d[c]="\\"+d[c];break}}return d.join("")},decodeQuotedString:function(f){var d=f.split(""),c,e=false;for(c in d){if(e){continue}if(d[c]==="\\"){e=true;delete d[c]}}return d.join("")}};return b}(CrocMSRP||{}));

// orca/orca_version.js
var orcaVersion = "27.11.00:1441236612 spwl hackathon01";

// orca/orca.js
(function(){var orca,SessionStatus,SessionError,CallStatus,CallError,AddressBookStatus,AddressBookError;function ManagedStream(rtcMediaStream){this.type=function(){var a=rtcMediaStream.getAudioTracks().length>0,v=rtcMediaStream.getVideoTracks().length>0;if(a){if(v){return"audio,video"}return"audio"}if(v){return"video"}return""};this.resume=function(){setTrackListEnabled(rtcMediaStream.getAudioTracks(),true);setTrackListEnabled(rtcMediaStream.getVideoTracks(),true)};this.stop=function(){setTrackListEnabled(rtcMediaStream.getAudioTracks(),false);setTrackListEnabled(rtcMediaStream.getVideoTracks(),false)};this.stream=function(){return rtcMediaStream}}function Session(userid,token,sessionConfig){var sessionImp=sessionConfig.provider.createSession(userid,token,sessionConfig,this);this.connect=function(){return sessionImp.connect()};this.createCall=function(to,mediatypes){return new Call(to,mediatypes,sessionImp)};this.createChat=function(to){return new Chat(to,sessionImp)};this.createFileTransfer=function(to,file){return new FileTransfer(to,file,sessionImp)};this.createImageShare=function(to,file){return new ImageShare(to,file,sessionImp)};this.disconnect=function(){return sessionImp.disconnect()};this.getStatus=function(){return sessionImp.getStatus()};this.sendPageModeChatMessage=function(to,message){return sessionImp.sendPageModeChatMessage(to,message)};this.sendSmsMessage=function(to,message,smsIMDNMessageInfo){return sessionImp.sendSmsMessage(to,message,smsIMDNMessageInfo)};this.sendSmsIMDNMessage=function(to,imdnMessageID,status,dateTime){return sessionImp.sendSmsIMDNMessage(to,imdnMessageID,status,dateTime)};this.subscribePresence=function(presenceResource){return sessionImp.subscribePresence(presenceResource)};this.getPresence=function(presenceResource){return sessionImp.getPresence(presenceResource)};this.updatePresence=function(presenceInfo){return sessionImp.updatePresence(presenceInfo)};this.test=function(testString){return sessionImp.test(testString)};this.onConnected=function(event){};this.onDisconnected=function(event){};this.onError=function(error,event){};this.onIncoming=function(receivedCall,event){};this.onIncomingChat=function(chat,event){};this.onIncomingPageModeChat=function(event){};this.onPageModeChatMessageSent=function(message,event){};this.onPageModeChatMessageFailed=function(message,event){};this.onIncomingSmsMessage=function(event){};this.onSmsMessageSent=function(message,event){};this.onSmsMessageFailed=function(message,event){};this.onIncomingSmsIMDNMessage=function(event){};this.onSmsIMDNMessageSent=function(event){};this.onSmsIMDNMessageFailed=function(event){};this.onIncomingFileTransfer=function(fileTransfer,event){};this.onIncomingImageShare=function(imageShare,event){};this.onPresenceNotify=function(presenceInfo,event){};this.onSubscribePresenceSuccess=function(event){};this.onSubscribePresenceFailed=function(event){};this.onGetPresenceSuccess=function(event){};this.onGetPresenceFailed=function(event){};this.onUpdatePresenceSuccess=function(event){};this.onUpdatePresenceFail=function(event){};this.getMDSPinfo=function(){return sessionImp.mdsp.getContacts()};this.pullCallFromMDSPdialog=function(call,callInfo){sessionImp.mdsp.pullCallFromMDSPdialog(call,callInfo)};this.onMDSPinfoUpdate=function(){};this.onStatus=function(status,event){};this.updateToken=function(tokenKey){return sessionImp.updateToken(tokenKey)};this.sendPingFrame=function(){return sessionImp.sendPingFrame()}}function Call(to,mediatypes,sessionImp){var callImp=sessionImp.createCall(to,mediatypes,sessionImp,this),id=generateCallId(),localStreams=[];this.id=function(){return id};this.remoteIdentities=function(){return callImp.remoteIdentities()};this.getpc=function(){return callImp.getpc()};this.dumpCallInfo=function(){return callImp.dumpCallInfo()};this.addStream=function(stream){var managed=stream;if(stream!==null){if(stream.constructor.name!=="ManagedStream"){managed=orca.createManagedStream(stream)}localStreams.push(managed);if(typeof callImp.addStream==="function"){callImp.addStream(managed)}return managed}};this.removeStream=function(stream){var managed=stream;if(stream!==null){if(typeof callImp.removeStream==="function"){callImp.removeStream(managed)}localStreams.shift()}};this.connect=function(){return callImp.connect()};this.disconnect=function(){return callImp.disconnect()};this.reject=function(){return callImp.reject()};this.streams=function(selector){var result=[],el="",id="",audio=false,video=false;if(selector&&typeof selector==="string"){el=selector.match(/^[0-9a-zA-Z]*/)[0].toLowerCase();id=selector.match(/#[0-9a-zA-Z]*/);if(id){id=id[0].substring(1)}else{id=""}audio=selector.match(/\.audio([#.\s]|$)/)?true:false;video=selector.match(/\.video([#.\s]|$)/)?true:false}if(el!=="local"){selectStreams(callImp.remoteStreams(),result,id,audio,video)}if(el!=="remote"){selectStreams(localStreams,result,id,audio,video)}return result};this.getStatus=function(){return callImp.getStatus()};this.getMediaTypes=function(){return callImp.getMediaTypes()};this.addParticipant=function(target){return callImp.addParticipant(target)};this.removeParticipant=function(target){return callImp.removeParticipant(target)};this.sendDTMF=function(dtmf){return callImp.sendDTMF(dtmf)};this.transfer=function(target){return callImp.transfer(target)};this.mute=function(media_types){var streams=this.streams("local"),i;if(media_types===undefined){for(i=0;i<streams.length;i+=1){streams[i].stop()}return}if(media_types.indexOf("audio")>=0){for(i=0;i<streams.length;i+=1){setTrackListEnabled(streams[i].stream().getAudioTracks(),false)}}if(media_types.indexOf("video")>=0){for(i=0;i<streams.length;i+=1){setTrackListEnabled(streams[i].stream().getVideoTracks(),false)}}};this.unmute=function(media_types){var streams=this.streams("local"),i;if(media_types===undefined){for(i=0;i<streams.length;i+=1){streams[i].resume()}return}if(media_types.indexOf("audio")>=0){for(i=0;i<streams.length;i+=1){setTrackListEnabled(streams[i].stream().getAudioTracks(),true)}}if(media_types.indexOf("video")>=0){for(i=0;i<streams.length;i+=1){setTrackListEnabled(streams[i].stream().getVideoTracks(),true)}}};this.hold=function(type){callImp.hold(type)};this.resume=function(){callImp.resume()};this.createDataChannel=function(){callImp.createDataChannel()};this.sendMessage=function(msg){callImp.sendMessage(msg)};this.sendFile=function(url){callImp.sendFile(url)};this.onAddStream=function(stream,event){};this.onConnected=function(event){};this.onDisconnected=function(event){};this.onError=function(error,event){};this.onStatus=function(status,event){};this.onMessage=function(event){};this.pushCallToMDSPcontact=function(pushToGruu){sessionImp.mdsp.pushCallToContact(callImp,pushToGruu)};this.getCallImp=function(){return callImp}}function Chat(to,sessionImp){var chatImp=sessionImp.createChat(to,sessionImp,this),id=generateCallId();this.getImp=function(){return chatImp};this.id=function(){return id};this.remoteIdentities=function(){return chatImp.remoteIdentities()};this.getStatus=function(){return chatImp.getStatus()};this.connect=function(){return chatImp.connect()};this.disconnect=function(){return chatImp.disconnect()};this.reject=function(){return chatImp.reject()};this.sendMessage=function(message){return chatImp.sendMessage(message)};this.onConnected=function(event){};this.onDisconnected=function(event){};this.onError=function(error,event){};this.onStatus=function(status,event){};this.onReceived=function(message,event){}}function FileTransfer(to,file,sessionImp){var fileTransferImp=sessionImp.createFileTransfer(to,file,sessionImp,this),id=generateCallId();this.getImp=function(){return fileTransferImp};this.id=function(){return id};this.remoteIdentities=function(){return fileTransferImp.remoteIdentities()};this.getStatus=function(){return fileTransferImp.getStatus()};this.connect=function(){return fileTransferImp.connect()};this.disconnect=function(){return fileTransferImp.disconnect()};this.reject=function(){return fileTransferImp.reject()};this.onConnected=function(event){};this.onDisconnected=function(event){};this.onError=function(error,event){};this.onStatus=function(status,event){};this.onReceived=function(message){}}function ImageShare(to,file,sessionImp){var imageShareImp=sessionImp.createImageShare(to,file,sessionImp,this),id=generateCallId();this.getImp=function(){return imageShareImp};this.id=function(){return id};this.remoteIdentities=function(){return imageShareImp.remoteIdentities()};this.getStatus=function(){return imageShareImp.getStatus()};this.connect=function(){return imageShareImp.connect()};this.disconnect=function(){return imageShareImp.disconnect()};this.reject=function(){return imageShareImp.reject()};this.onConnected=function(event){};this.onDisconnected=function(event){};this.onError=function(error,event){};this.onStatus=function(status,event){};this.onReceived=function(message){}}function AddressBook(userId,token,abConfig){var abImp=abConfig.provider.createAddressBook(userId,token,abConfig,this);this.getLists=function(getMembersInList){return abImp.getLists(getMembersInList)};this.getMembers=function(listId){return abImp.getMembers(listId)};this.getContacts=function(){return abImp.getContacts()};this.addMember=function(listId,member){return abImp.addMember(listId,member)};this.addContact=function(contact){return abImp.addContact(contact)};this.updateMember=function(listId,member){return abImp.updateMember(listId,member)};this.updateContact=function(contact){return abImp.updateContact(contact)};this.deleteList=function(listId){return abImp.deleteList(listId)};this.deleteMember=function(listId,member){return abImp.deleteMember(listId,member)};this.deleteContact=function(contact){return abImp.deleteContact(contact)};this.trnsferMember=function(listId,member,newListId){return abImp.trnsferMember(listId,member,newListId)};this.onError=function(error,event){};this.onGetLists=function(lists,event){};this.onGetMembers=function(list,event){};this.onGetContacts=function(contacts,event){};this.onAddMember=function(event){};this.onAddContact=function(event){};this.onUpdateMember=function(event){};this.onUpdateContact=function(event){};this.onDeleteList=function(event){};this.onDeleteMember=function(event){};this.onDeleteContact=function(event){};this.onTransferMember=function(event){}}function generateCallId(){var id="",i,an="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";for(i=0;i<8;i+=1){id+=an.charAt(Math.floor(Math.random()*an.length))}return id}function setTrackListEnabled(tracklist,value){var i;for(i=0;i<tracklist.length;i+=1){tracklist[i].enabled=value}}function selectStreams(list,result,id,audio,video){var i,stream;for(i=0;i<list.length;i+=1){stream=list[i].stream();if((id===""||stream.id===id)&&(!audio||stream.getAudioTracks().length>0)&&(!video||stream.getVideoTracks().length>0)){result.push(list[i])}}}CallError={};CallError.NETWORK_FAILURE="call_error_network_failure";CallStatus={};CallStatus.CONNECTING="call_status_connecting";CallStatus.HOLD="call_status_hold";CallStatus.UNHOLD="call_status_unhold";CallStatus.REJECTED="call_status_rejected";CallStatus.CANCELED="call_status_canceled";CallStatus.CONNECTED="call_status_connected";CallStatus.DISCONNECTED="call_status_disconnected";CallStatus.REMOTE_HOLD="call_status_remote_hold";CallStatus.UPGRADING="call_status_upgrading";CallStatus.DOWNGRADING="call_status_downgrading";CallStatus.ADDSTREAM="call_status_add_stream";CommError={};CommError.NETWORK_FAILURE="comm_error_network_failure";CommError.NOT_SUPPORTED="comm_error_not_supported";CommStatus={};CommStatus.CONNECTING="comm_status_connecting";CommStatus.REJECTED="comm_status_rejected";CommStatus.CANCELED="comm_status_canceled";CommStatus.CONNECTED="comm_status_connected";CommStatus.DISCONNECTED="comm_status_disconnected";CommStatus.PROGRESS="comm_status_progress";CommStatus.SENDSUCCESS="comm_status_send_success";CommStatus.SENDFAIL="comm_status_send_fail";CommStatus.RECEIVED="comm_status_received";SessionError={};SessionError.AUTHENTICATION_FAILED="session_error_authentication_failed";SessionError.NETWORK_ERROR="session_error_network_error";SessionStatus={};SessionStatus.CONNECTED="session_status_connected";SessionStatus.CONNECTING="session_status_connecting";SessionStatus.DISCONNECTED="session_status_disconnected";SessionStatus.INCOMINGCALL="session_status_incoming_call";SessionStatus.AUTHENTICATING="session_status_authenticating";SessionStatus.INCOMINGCHAT="session_status_incoming_chat";SessionStatus.INCOMINGFILE="session_status_incoming_file";SessionStatus.INCOMINGIMAGE="session_status_incoming_image";SessionStatus.INCOMINGAUTOANSWER="session_status_incoming_auto_answer";SessionStatus.UPDATEPRESENCESUCCESS="session_status_update_presence_success";SessionStatus.UPDATEPRESENCEFAIL="session_status_update_presence_fail";AddressBookError={};AddressBookError.AUTHENTICATION_FAILED="addressbook_error_authentication_failed";AddressBookError.CONFIG_ERROR="addressbook_error_config_error";AddressBookError.PARAMETERS_ERROR="addressbook_error_parameters_error";AddressBookError.NETWORK_ERROR="addressbook_error_network_error";AddressBookStatus={};AddressBookStatus.GETLISTS_SUCCESSFUL="addressbook__status_getLists_successful";AddressBookStatus.GETMEMBERS_SUCCESSFUL="addressbook_status_getMembers_successful";AddressBookStatus.GETCONTACTS_SUCCESSFUL="addressbook_status_getContacts_successful";AddressBookStatus.ADDMEMBER_SUCCESSFUL="addressbook_status_addMember_successful";AddressBookStatus.ADDCONTACT_SUCCESSFUL="addressbook_status_addContact_successful";AddressBookStatus.UPDATEMEMBER_SUCCESSFUL="addressbook_status_updateMebmer_successful";AddressBookStatus.UPDATECONTACT_SUCCESSFUL="addressbook_status_updateContact_successful";AddressBookStatus.DELETELIST_SUCCESSFUL="addressbook_status_deleteList_successful";AddressBookStatus.DELETEMEMBER_SUCCESSFUL="addressbook_status_deleteMember_successful";AddressBookStatus.DELETECONTACT_SUCCESSFUL="addressbook_status_deleteContact_successful";AddressBookStatus.TRANSFERMEMBER_SUCCESSFUL="addressbook_status_transferMember_successful";AddressBookStatus.GETLISTS_FAILED="addressbook_status_getLists_failed";AddressBookStatus.GETMEMBERS_FAILED="addressbook_status_getMembers_failed";AddressBookStatus.GETCONTACTS_FAILED="addressbook_status_getContacts_failed";AddressBookStatus.ADDMEMBER_FAILED="addressbook_status_addMember_failed";AddressBookStatus.ADDCONTACT_FAILED="addressbook_status_addContact_failed";AddressBookStatus.UPDATEMEMBER_FAILED="addressbook_status_updateMebmer_failed";AddressBookStatus.UPDATECONTACT_FAILED="addressbook_status_updateContact_failed";AddressBookStatus.DELETELIST_FAILED="addressbook_status_deleteList_failed";AddressBookStatus.DELETEMEMBER_FAILED="addressbook_status_deleteMember_failed";AddressBookStatus.DELETECONTACT_FAILED="addressbook_status_deleteContact_failed";AddressBookStatus.TRANSFERMEMBER_FAILED="addressbook_status_transferMember_failed";orca={createSession:function(userid,token,sessionConfig){return new Session(userid,token,sessionConfig)},createAddressBook:function(userid,token,abConfig){return new AddressBook(userid,token,abConfig)},createManagedStream:function(rtcMediaStream){return new ManagedStream(rtcMediaStream)}};this.orca=orca;this.SessionStatus=SessionStatus;this.SessionError=SessionError;this.CallStatus=CallStatus;this.CallError=CallError;this.CommStatus=CommStatus;this.CommError=CommError;this.AddressBookStatus=AddressBookStatus;this.AddressBookError=AddressBookError}());

// orca/orcaALU.js
console.trace=function(a){if(navigator.userAgent.match(/Chrome/i)){console.debug("["+new Date().toUTCString()+"] "+a+(new Error).stack.replace(/Error|http.*\//g,""))}else{console.debug(a)}};(function(){var a={ab:"urn:oma:xml:rest:netapi:addressbook:1"};var d=true;console.debug("ORCA/$Rev: 421 $; "+navigator.userAgent);if(typeof orcaVersion!=="undefined"){console.debug("ecms: "+orcaVersion)}if(navigator.mozGetUserMedia){console.debug("Firefox adapting");webkitRTCPeerConnection=mozRTCPeerConnection;RTCSessionDescription=mozRTCSessionDescription;RTCIceCandidate=mozRTCIceCandidate;navigator.getUserMedia=navigator.mozGetUserMedia;attachMediaStream=function(x,y){console.log("Attaching media stream");x.mozSrcObject=y;x.play()};reattachMediaStream=function(y,x){console.log("Reattaching media stream");y.mozSrcObject=x.mozSrcObject;y.play()}}else{if(navigator.webkitGetUserMedia){console.debug("chrome adapting");navigator.getUserMedia=navigator.webkitGetUserMedia}else{console.warn("Browser does not appear to be WebRTC-capable")}}function n(A,z,y,B){this.callback=B;this.WebSocketStatus={};this.WebSocketStatus.DISCONNECTED="0";this.WebSocketStatus.CONNECTING="1";this.WebSocketStatus.CONNECTED="2";this.RegisterStatus={};this.RegisterStatus.UNREGISTERED="0";this.RegisterStatus.WAITING="1";this.RegisterStatus.REGISTERING="2";this.RegisterStatus.REGISTERED="3";this.userId=A;this.token=z;this.config=y;this.sessionStatus=SessionStatus.DISCONNECTED;this.socketStatus=this.WebSocketStatus.DISCONNECTED;this.ws=undefined;this.localAOR=A;this.calls=[];this.presenceSubscriptions=[];this.adapter=null;var x=this;this.recoveryAttemptsRemaining=y.providerConfig.maxRecoveryAttempts;this.wsRestoreInProgress=false;this.ws_only=false;this.autoAnswerMode=false;this.needAuthOnReRegister=false;this.closePending=false;this.autoAnswerTimer=false;this.isReceivePong=false;this.updateToken=function(C){console.debug("orcaALU.updateToken");this.token=z;this.adapter.updateToken(C);this.adapter.createSession()};this.sendPingFrame=function(){var D=isNaN(y.providerConfig.crlfKeepAliveInterval)?0:parseInt(y.providerConfig.crlfKeepAliveInterval);console.log("crlfKeepAliveInterval is "+D);if(D>0){var C;if(D>10){C=10}else{C=D}this.SendPingMessage(C);this.sendPingMessageInterval=setInterval(function(){x.SendPingMessage(C)},D*1000)}};this.SendPingMessage=function(C){console.debug("Send CRLF Keep Alive request, timeOut:"+C);this.isReceivePong=false;this.sendPingMessageTimer=setTimeout(function(){x.sendPingMessageTimeout()},C*1000);this.ws.send("\r\n\r\n")};this.sendPingMessageTimeout=function(){console.debug("Enter sendPingMessageTimeout, isReceivePong:"+this.isReceivePong);if(!this.isReceivePong){console.debug("Can't receive the pong meesage, disconnect the session and close the WebSocket");this.setSessionStatus(SessionStatus.DISCONNECTED,SessionError.NETWORK_ERROR);this.ws.close(1000,"CRLF heartbeat failure")}};this.mdsp={myOwnGruu:"",gruuSupported:false,isGRUUsupported:function(){return this.gruuSupported},setGRUUsupport:function(C){this.gruuSupported=C},contacts:[],onContactsUpdate:function(){if(typeof B.onMDSPinfoUpdate==="function"){B.onMDSPinfoUpdate()}},isFeatureEnabled:function(){return x.config.providerConfig.enableMDSPsupport},getSecDeviceId:function(){return x.config.providerConfig.secondaryDeviceId},getContacts:function(){return this.contacts},addContact:function(C,F,D,G){var E;if(C==this.myOwnGruu){return false}for(E=0;E<this.contacts.length;++E){if(this.contacts[E].gruu==C){return false}}this.contacts.push({gruu:C,sipUri:F,displayName:D,isSecondaryDevice:G,dialog:[]});return true},addDialog:function(C){var D;for(D=0;D<this.contacts.length;++D){if(this.contacts[D].displayName==C.localDisplayName){this.contacts[D].dialog.push({dialogId:C.dialogId,callId:C.callId,remoteId:C.remoteId,state:C.state,exclusive:C.exclusive,direction:C.direction,localTag:C.localTag,remoteTag:C.remoteTag,mediaAttr:C.mediaAttr});return true}}console.log("Unable to add dialog, displayName not found:\n\tdisplayName = "+C.localDisplayName+"\n\tdialogId = "+C.dialogId+"\n\tcallId   = "+C.callId+"\n\tremoteId = "+C.remoteId+"\n\tstate    = "+C.state+"\n\texclusive= "+C.exclusive+"\n\tdirection= "+C.direction+"\n\tlocalTag = "+C.localTag+"\n\tremoteTag= "+C.remoteTag);for(D=0;D<C.mediaAttr.length;++D){console.log("\tmediaAttr["+D+"].mediaType      = "+C.mediaAttr[D].mediaType+"\n\tmediaAttr["+D+"].mediaDirection = "+C.mediaAttr[D].mediaDirection)}return false},logContacts:function(F,G){var E,D,C;console.log("MDSP Contacts: "+((F)?F:"")+":\n");for(E=0;E<this.contacts.length;++E){console.log("contacts["+E+"].displayName = "+this.contacts[E].displayName);console.log("contacts["+E+"].gruu   = "+this.contacts[E].gruu);console.log("contacts["+E+"].sipUri = "+this.contacts[E].sipUri);console.log("contacts["+E+"].isSecondaryDevice = "+this.contacts[E].isSecondaryDevice);console.log("\tDialogs:\n");for(D=0;D<this.contacts[E].dialog.length;++D){console.log("\t\tdialog["+D+"].dialogId = "+this.contacts[E].dialog[D].dialogId+"\n\t\tdialog["+D+"].callId   = "+this.contacts[E].dialog[D].callId+"\n\t\tdialog["+D+"].state    = "+this.contacts[E].dialog[D].state+"\n\t\tdialog["+D+"].remoteId = "+this.contacts[E].dialog[D].remoteId+"\n\t\tdialog["+D+"].exclusive= "+this.contacts[E].dialog[D].exclusive+"\n\t\tdialog["+D+"].direction= "+this.contacts[E].dialog[D].direction+"\n\t\tdialog["+D+"].localTag = "+this.contacts[E].dialog[D].localTag+"\n\t\tdialog["+D+"].remoteTag= "+this.contacts[E].dialog[D].remoteTag);for(C=0;C<this.contacts[E].dialog[D].mediaAttr.length;++C){console.log("\t\t\tmediaAttr["+C+"].mediaType = "+this.contacts[E].dialog[D].mediaAttr[C].mediaType+"\n\t\t\tmediaAttr["+C+"].mediaDirection = "+this.contacts[E].dialog[D].mediaAttr[C].mediaDirection)}}if(this.contacts[E].dialog.length==0){console.log("\t\tNone\n")}}if(E==0){console.log("None\n");return}if(G){console.log("My own GRUU = "+this.myOwnGruu)}},subscribeDialog:function(C){x.adapter.sendSubscribeDialog(C)},dialogSubscriptions:[],subscribeToMDSPContactDialogs:function(){var C;for(C=0;C<this.contacts.length;C++){if(this.getDialogSubscriptionIndex(this.contacts[C].sipUri)==(-1)){this.subscribeDialog(this.contacts[C].sipUri);this.addDialogSubscription(this.contacts[C].sipUri)}}},subscribeDialogTimerExp:function(E){var D;var C=this.getDialogSubscriptionIndex(E);for(D=0;D<this.contacts.length;++D){if(this.contacts[D].sipUri==E){this.subscribeDialog(E);if(C>=0){var F=setTimeout(this.subscribeDialogTimerExp.bind(this),60*60*1000,E);this.dialogSubscriptions[C].expTimerId=F}else{this.addDialogSubscription(E)}return}}if(C>=0){dialogSubscriptions.splice(C,1)}},addDialogSubscription:function(C){var D=setTimeout(this.subscribeDialogTimerExp.bind(this),60*60*1000,C);this.dialogSubscriptions.push({sipUri:C,expTimerId:D})},getDialogSubscriptionIndex:function(D){var C;for(C=0;C<this.dialogSubscriptions.length;C++){if(this.dialogSubscriptions[C].sipUri==D){return C}}return -1},clearDialogSubscriptions:function(){var C;for(C=0;C<this.dialogSubscriptions.length;C++){clearTimeout(this.dialogSubscriptions[C].expTimerId)}},clearMDSPcontacts:function(){this.contacts=[];this.clearDialogSubscriptions();this.onContactsUpdate()},onDialogNotify:function(F){var J;var E;var I="application/xml";var G=[];var H;var D;var C;console.debug("mdsp.onDialogNotify():");if(window.DOMParser){J=new DOMParser();E=J.parseFromString(F,I)}else{E=new ActiveXObject("Microsoft.XMLDOM");E.async=false;E.loadXML(F)}C=E.getElementsByTagName("dialog");console.log("dialogArray.length = "+C.length);for(D=0;D<C.length;++D){H=this.getDialogInfoElemFromNotifyDialog(C[D]);G.push(H)}this.reconcileMDSPDialogs(G)},getDialogInfoElemFromNotifyDialog:function(H){var F,E,D;console.log("getDialogInfoElemFromNotifyDialog()");var G={localDisplayName:"Unavailable",dialogId:"0000",callId:"",remoteId:"",state:"",exclusive:false,direction:"",localTag:"",remoteTag:"",mediaAttr:[]};if((H.attributes!=undefined)&&(H.attributes.length>0)){for(F=0;F<H.attributes.length;++F){if(H.attributes[F].localName=="id"){G.dialogId=H.attributes[F].textContent}else{if(H.attributes[F].localName=="call-id"){G.callId=H.attributes[F].textContent}else{if(H.attributes[F].localName=="local-tag"){G.localTag=H.attributes[F].textContent}else{if(H.attributes[F].localName=="remote-tag"){G.remoteTag=H.attributes[F].textContent}else{if(H.attributes[F].localName=="direction"){G.direction=H.attributes[F].textContent}}}}}}}for(F=0;F<H.childNodes.length;++F){if(H.childNodes[F].localName=="exclusive"){G.exclusive=((H.childNodes[F].textContent=="true")?true:false)}else{if(H.childNodes[F].localName=="state"){G.state=H.childNodes[F].textContent}else{if(H.childNodes[F].localName=="remote"){for(E=0;E<H.childNodes[F].childNodes.length;++E){if(H.childNodes[F].childNodes[E].localName=="identity"){G.remoteId=H.childNodes[F].childNodes[E].textContent}else{if(H.childNodes[F].childNodes[E].localName=="mediaAttributes"){var C={};for(D=0;D<H.childNodes[F].childNodes[E].childNodes.length;++D){if(H.childNodes[F].childNodes[E].childNodes[D].localName=="mediaType"){C.mediaType=H.childNodes[F].childNodes[E].childNodes[D].textContent}else{if(H.childNodes[F].childNodes[E].childNodes[D].localName=="mediaDirection"){C.mediaDirection=H.childNodes[F].childNodes[E].childNodes[D].textContent}}}G.mediaAttr.push(C)}}}}else{if(H.childNodes[F].localName=="local"){for(E=0;E<H.childNodes[F].childNodes.length;++E){if(H.childNodes[F].childNodes[E].localName=="identity"){for(D=0;D<H.childNodes[F].childNodes[E].attributes.length;++D){if(H.childNodes[F].childNodes[E].attributes[D].localName=="display-name"){G.localDisplayName=H.childNodes[F].childNodes[E].attributes[D].textContent}}}}}}}}}return G},reconcileMDSPDialogs:function(E){var D,C;console.log("reconcileMDSPDialogs(), newDialogInfo.length = "+E.length);for(D=0;D<this.contacts.length;++D){this.contacts[D].dialog.splice(0,this.contacts[D].dialog.length)}for(D=0;D<E.length;++D){this.addDialog(E[D])}for(D=0;D<E.length;++D){console.log("newDialogInfo["+D+"].localDisplayName = "+E[D].localDisplayName);console.log("newDialogInfo["+D+"].dialogId         = "+E[D].dialogId);console.log("newDialogInfo["+D+"].callId           = "+E[D].callId);console.log("newDialogInfo["+D+"].remoteId         = "+E[D].remoteId);console.log("newDialogInfo["+D+"].state            = "+E[D].state);console.log("newDialogInfo["+D+"].exclusive        = "+E[D].exclusive);console.log("newDialogInfo["+D+"].direction        = "+E[D].direction);console.log("newDialogInfo["+D+"].localTag         = "+E[D].localTag);console.log("newDialogInfo["+D+"].remoteTag        = "+E[D].remoteTag);for(C=0;C<E[D].mediaAttr.length;++C){console.log("newDialogInfo["+D+"].mediaAttr["+C+"].mediaType = "+E[D].mediaAttr[C].mediaType);console.log("newDialogInfo["+D+"].mediaAttr["+C+"].mediaDirection = "+E[D].mediaAttr[C].mediaDirection)}}this.onContactsUpdate()},getContactFromGruu:function(C){var D;for(D=0;D<this.contacts.length;++D){if(this.contacts[D].gruu==C){return this.contacts[D]}}return null},pushCallToContact:function(D,E){var C;C=this.getContactFromGruu(E);if(C==null){console.error("Unable to locate MDSP contact for GRUU = "+gruu);return}x.adapter.doPush(D,C.sipUri,E)},pullCallFromMDSPdialog:function(D,C){D.getCallImp().pullCallInfo=C},getReplacesUriForPull:function(C){return(C.dialogElem.callId+";to-tag="+C.dialogElem.localTag+";from-tag="+C.dialogElem.remoteTag)},getToUriForPull:function(G){var H;var F;var I="VoLTE-";var E="active";var D=x.userId.slice(A.indexOf("@")+1);var C=this.getContactFromGruu(G.gruu);if(C==null){console.debug("Unable to find MDSP contact for GRUU = "+G.gruu)}else{if(C.isSecondaryDevice){I="SP-"}}for(H=0;H<G.dialogElem.mediaAttr.length;++H){if(((G.dialogElem.mediaAttr[H].mediaType=="audio")||(G.dialogElem.mediaAttr[H].mediaType=="video"))&&(G.dialogElem.mediaAttr[H].mediaDirection!="sendrecv")){E="hold"}}F="sip:pull-"+I+E+"@"+D;return F},getRequestUriUserForPull:function(){return"pull-VoLTE-active"}};this.updateToken=function(C){console.debug("orcaALU.updateToken");this.token=C;this.adapter.updateToken(C);this.adapter.createSession()};this.printConfig=function(){console.debug("Config Parameters Start:\n");console.debug("userId: "+this.userId);console.debug("token.id: "+this.token.id);console.debug("token.key: "+this.token.key);console.debug("token.displayName: "+this.token.displayName);console.debug("token.authtype: "+this.token.authtype);console.debug("uri: "+this.config.uri);console.debug("mediatypes: "+this.config.mediatypes);var D=JSON.stringify(this.config.providerConfig);var C=D.split(",");for(i in C){console.debug(C[i])}console.debug("Config Parameters End:\n")};this.connect=function(){console.debug("["+new Date().toUTCString()+"] Session.connect()");this.printConfig();if(!this.config.providerConfig.addCodecs&&this.config.providerConfig.addCodecs!==false){this.config.providerConfig.addCodecs=true;console.debug("use default value 'Enabled' for the addCodecs")}if(d){d=false;if(this.config.providerConfig.autoAnswerTime>0){this.autoAnswerTimer=setTimeout(function(){x.autoAnswerTimer=false},this.config.providerConfig.autoAnswerTime*1000)}}if(this.socketStatus===this.WebSocketStatus.DISCONNECTED){this.createWebSocket()}else{console.error("your session is already connecting or connected to the gateway")}};this.createWebSocket=function(){console.debug("["+new Date().toUTCString()+"] Session.createWebSocket()");var C=this.config.uri;if((C.substr(0,2)!=="ws")&&(C.substr(0,3)!=="wss")){console.error("URI of the gateway is malformed.");return}console.debug("connect to "+C+" interfaceType: "+this.config.providerConfig.interfaceType);if(this.config.providerConfig.interfaceType==="REST-WS"){this.ws=new WebSocket(C,["ALURest"]);this.adapter=new b.RestAdapter(this.ws,A,z,y,this)}else{this.ws=new WebSocket(C,["sip"]);this.adapter=new b.SipAdapter(this.ws,A,z,y,this)}this.ws.binaryType="arraybuffer";this.socketStatus=this.WebSocketStatus.CONNECTING;this.ws.onopen=function(D){x.onWebSocketOpen(D)};this.ws.onclose=function(D){x.onWebSocketClose(D)};this.ws.onerror=function(D){x.onWebSocketError(D)};this.ws.onmessage=function(D){x.onWebSocketMessage(D)}};this.createCall=function(G,C,E,F){console.debug("Session.createCall()");var D=new m(G,C,E,F);this.calls.push(D);return D};this.createChat=function(E,C,D){return new f(E,C,D)};this.sendPageModeChatMessage=function(E,D){var C=new v(E,this,D);this.calls.push(C);C.sendMessage()};this.sendSmsMessage=function(H,F,C){var E=o(9);var G=u(new Date());console.info("generate imdnMessageID:"+E);console.info("ISO dateTime:"+G);var D=new c(H,this,E,G,F);this.calls.push(D);D.sendMessage();C.setSmsIMDNMessageID(E);C.setDateTime(G)};this.sendSmsIMDNMessage=function(G,E,D,F){var C=new p(G,this,E,D,F);this.calls.push(C);C.sendMessage()};this.createFileTransfer=function(F,C,D,E){return new s(F,C,D,E)};this.createImageShare=function(F,C,D,E){return new e(F,C,D,E)};this.subscribePresence=function(C){this.adapter.sendSubscribePresence(C)};this.test=function(D){var C={data:D};this.onWebSocketMessage(C)};this.getPresence=function(C){this.adapter.sendSubscribePresence(C,0)};this.updatePresence=function(C){this.adapter.sendUpdatePresence(C)};this.disconnect=function(){console.debug("Session.disconnect()");if(this.socketStatus!==this.WebSocketStatus.DISCONNECTED){this.adapter.terminateSession()}else{console.warn("Session.disconnect() Ignoring in this state : "+this.socketStatus)}};this.getStatus=function(){return this.sessionStatus};this.onWebSocketOpen=function(C){console.debug("["+new Date().toUTCString()+"] Session.onWebSocketOpen()");this.socketStatus=this.WebSocketStatus.CONNECTED;if((this.wsRestoreInProgress==true)&&(!this.config.providerConfig.sendRegisterOnRecovery)){this.ws_only=true;this.needAuthOnReRegister=true;console.debug("Setting up to create ws only session")}this.adapter.createSession()};this.onWebSocketClose=function(C){console.debug("["+new Date().toUTCString()+"] Session.onWebSocketClose(), evt = "+C);var D={name:C.data};if((this.closePending==true)&&(this.socketStatus==this.WebSocketStatus.CONNECTED)){console.log("Ignoring register refresh timeout late close");this.closePending=false;return}clearTimeout(this.adapter.refresh_timer);clearTimeout(this.adapter.registerResponseTimer);clearTimeout(this.sendPingMessageTimer);clearInterval(this.sendPingMessageInterval);if(this.mdsp.isFeatureEnabled()){this.mdsp.clearMDSPcontacts()}if((this.socketStatus==this.WebSocketStatus.CONNECTED)&&(this.recoveryAttemptsRemaining!=0)&&(this.config.providerConfig.networkRetryInterval!=0)&&(this.calls[0])){console.log("Getting timer to retry ws connection");setTimeout(function(){x.connect()},(y.providerConfig.networkRetryInterval*1000));this.recoveryAttemptsRemaining--;this.wsRestoreInProgress=true;this.socketStatus=this.WebSocketStatus.DISCONNECTED;return}if(this.socketStatus!==this.WebSocketStatus.CONNECTED){console.error("Network failure")}else{D={name:this.sessionStatus};this.callback.onStatus(this.sessionStatus,D);this.callback.onDisconnected(D)}this.socketStatus=this.WebSocketStatus.DISCONNECTED};this.onWebSocketError=function(C){console.error("Network failure");console.debug("Session.onWebSocketError() network failure, evt = "+C);clearTimeout(this.adapter.refresh_timer);this.socketStatus=this.WebSocketStatus.DISCONNECTED;if((this.recoveryAttemptsRemaining!=0)&&(this.config.providerConfig.networkRetryInterval!=0)&&(this.calls[0])){console.log("Getting timer to retry ws connection");setTimeout(function(){x.connect()},(y.providerConfig.networkRetryInterval*1000));this.recoveryAttemptsRemaining--;this.wsRestoreInProgress=true}else{var D={name:SessionError.NETWORK_ERROR};this.callback.onError(SessionError.NETWORK_ERROR,D);this.wsRestoreInProgress=false}};this.onWebSocketMessage=function(C){var D=C.data;if(D==="\r\n"){console.debug("received WebSocket message with CRLF Keep Alive response");this.isReceivePong=true;clearTimeout(this.sendPingMessageTimer);return}else{if(typeof D!=="string"){try{D=String.fromCharCode.apply(null,new Uint8Array(D))}catch(C){console.warn("received WebSocket binary message failed to be converted into string, message discarded");return}}else{}}D=D.replace(/^l:/gm,"Content-Length:");D=D.replace(/^v:/gm,"Via:");D=D.replace(/^t:/gm,"To:");D=D.replace(/^f:/gm,"From:");D=D.replace(/^i:/gm,"Call-ID:");D=D.replace(/^e:/gm,"Content-Encoding:");D=D.replace(/^m:/gm,"Contact:");console.debug("["+new Date().toUTCString()+"] Session.onWebSocketMessage() message:\n"+D);this.adapter.received(D)};this.onPageModeChatMessageFailed=function(C){var E=this.getCall(C.callId);if(E===null){console.warn("Session received a SIP response for a unknow page mode chat message. Ignore it.");return}var F={to:E.to};this.callback.onPageModeChatMessageFailed(E.message,F);for(var D=0;D<this.calls.length;D++){if(this.calls[D].callId===E.callId){this.calls.splice(D,1);break}}};this.onPageModeChatMessageSent=function(C){var E=this.getCall(C.callId);if(E===null){console.warn("Session received a SIP response for a unknow page mode chat message. Ignore it.");return}for(var D=0;D<this.calls.length;D++){if(this.calls[D].callId===E.callId){this.calls.splice(D,1);break}}};this.onSmsMessageSent=function(C){console.info("call onSmsMessageSent");var E=this.getCall(C.callId);if(E===null){console.warn("Session received a SIP response for an unknown sms message. Ignore it.");return}var F={to:E.to,from:C.from,imdnMessageID:C.imdnMessageID,dateTime:C.dateTime,status:C.status};console.info("call.to: "+E.to);console.info("evt.from: "+C.from);console.info("call.message: "+E.message);this.callback.onSmsMessageSent(E.message,F);for(var D=0;D<this.calls.length;D++){if(this.calls[D].callId===E.callId){this.calls.splice(D,1);break}}};this.onSmsMessageFailed=function(C){var E=this.getCall(C.callId);var G=C.imdnMessageID;if(E===null){console.warn("Session received a SIP response for an unknown sms message. Ignore it.");return}var F={to:E.to,imdnMessageID:G};console.info("call.message: "+E.message);this.callback.onSmsMessageFailed(E.message,F);for(var D=0;D<this.calls.length;D++){if(this.calls[D].callId===E.callId){this.calls.splice(D,1);break}}};this.onSmsIMDNMessageSent=function(C){var E=this.getCall(C.callId);if(E===null){console.warn("Session received a SIP response for an unknown sms imdn message. Ignore it.");return}var F={from:C.from,imdnMessageID:C.imdnMessageID,dateTime:C.dateTime,status:C.status};console.info("call.to: "+E.to);console.info("evt.from: "+C.from);this.callback.onSmsIMDNMessageSent(F);for(var D=0;D<this.calls.length;D++){if(this.calls[D].callId===E.callId){this.calls.splice(D,1);break}}};this.onSmsIMDNMessageFailed=function(C){console.info("call onSmsIMDNMessageFailed");var E=this.getCall(C.callId);var G=C.imdnMessageID;if(E===null){console.warn("Session received a SIP response for an unknown sms imdn message. Ignore it.");return}var F={from:C.from,imdnMessageID:C.imdnMessageID,dateTime:C.dateTime,status:C.status};console.info("call.to: "+E.to);console.info("evt.from: "+C.from);this.callback.onSmsIMDNMessageFailed(F);for(var D=0;D<this.calls.length;D++){if(this.calls[D].callId===E.callId){this.calls.splice(D,1);break}}};this.onPresenceNotify=function(C,D){this.callback.onPresenceNotify(C,D)};this.onSubscribePresenceSuccess=function(D){var C=new q(D.from,D.to,D.callId,D.cSeq,D.expires);this.presenceSubscriptions.push(C);if(typeof this.callback.onSubscribePresenceSuccess==="function"){this.callback.onSubscribePresenceSuccess(D)}};this.onSubscribePresenceFailed=function(C){if(typeof this.callback.onSubscribePresenceFailed==="function"){this.callback.onSubscribePresenceFailed(C)}};this.onGetPresenceSuccess=function(D){var C=new q(D.from,D.to,D.callId,D.cSeq,D.expires);this.presenceSubscriptions.push(C);if(typeof this.callback.onGetPresenceSuccess==="function"){this.callback.onGetPresenceSuccess(D)}};this.onGetPresenceFailed=function(C){if(typeof this.callback.onGetPresenceFailed==="function"){this.callback.onGetPresenceFailed(C)}};this.onUpdatePresenceSuccess=function(C){if(typeof this.callback.onUpdatePresenceSuccess==="function"){this.callback.onUpdatePresenceSuccess(C)}};this.onUpdatePresenceFail=function(C){if(typeof this.callback.onUpdatePresenceFail==="function"){this.callback.onUpdatePresenceFail(C)}};this.getPresenceSubscription=function(G,D,F){var E=null,C;for(C=0;C<this.presenceSubscriptions.length;C++){if(this.presenceSubscriptions[C].presentity.indexOf(G)!=-1&&this.presenceSubscriptions[C].callId.match(D)){E=this.presenceSubscriptions[C];if(E.expires===0){this.presenceSubscriptions.splice(C,1)}break}}return E};this.getCall=function(E){var D=null,C;for(C=0;C<this.calls.length;C+=1){if(this.calls[C].callId===E){D=this.calls[C];break}}return D};this.setSessionStatus=function(D,E){this.sessionStatus=D;var C={name:this.sessionStatus};if(E){this.callback.onError(E,C)}else{if(D===SessionStatus.CONNECTED){this.callback.onStatus(this.sessionStatus,C);this.callback.onConnected();if((this.calls[0])&&(this.wsRestoreInProgress)){if(this.config.providerConfig.sendRegisterOnRecovery){console.log("Going to auto answer mode ");this.wsRestoreInProgress=false;this.autoAnswerMode=true;setTimeout(function(){x.autoAnswerMode=false},this.config.providerConfig.autoAnswerTime*1000)}else{console.log("Service Continuity: Call exists... create a new offer");this.calls[0].callDirection=this.calls[0].CallDirection.OUTGOING;console.log("setting restoredCall to true");this.calls[0].restoredCall=true;this.wsRestoreInProgress=false;this.calls[0].createSDPOffer()}}}else{if(D===SessionStatus.DISCONNECTED){this.callback.onStatus(this.sessionStatus,C);this.callback.onDisconnected()}else{this.callback.onStatus(this.sessionStatus,C)}}}};this.incomingSessionEvent=function(C){var D=this.getCall(C.callId);if(!D){if(C.name==="invitation"){D=this.callback.createCall(null,null,this);D.getCallImp().incomingCallSessionEvent(C)}else{if(C.name==="message"){if(C.contentType==="message/cpim"){if(C.bodyContentType==="message/imdn+xml"){this.adapter.sendSmsIMDNMessageResponse(C.uaCall,200);var E={callId:C.callId,from:C.from,message:C.message,imdnMessageID:C.imdnMessageID,dateTime:C.dateTime,status:C.status};this.callback.onIncomingSmsIMDNMessage(E)}else{this.adapter.sendSmsMessageResponse(C.uaCall,200);this.callback.onIncomingSmsMessage(C)}return}this.adapter.sendPageModeChatMessageResponse(C.uaCall,200);if(C.contentType==="application/im-iscomposing+xml"&&w(C.message)){return}this.callback.onIncomingPageModeChat(C)}else{console.warn("no call found for "+C.name);return}}}else{if(C.name==="invitation"){D.incomingCallSessionEvent(C)}else{console.warn("unknown event")}}}}function q(B,A,y,z,x){this.watcher=B;this.presentity=A;this.callId=y;this.cSeq=z;this.expires=x}function m(B,x,z,A){this.callback=A;this.CallStatus={};this.CallStatus.IDLE="idle";this.CallStatus.PREPARING_OFFER="prep-offer";this.CallStatus.CALLING="calling";this.CallStatus.RINGING="ringing";this.CallStatus.PREPARING_ANSWER="prep-answer";this.CallStatus.ACCEPTED="accepted";this.CallStatus.CONFIRMED="confirmed";this.CallStatus.CANCELING="canceling";this.CallStatus.CANCELED="canceled";this.CallStatus.FAILED="failed";this.CallStatus.REFUSED="refused";this.CallStatus.TERMINATING="terminating";this.CallStatus.HOLD="hold";this.CallStatus.REMOTE_HOLD="remote hold";this.CallStatus.UPGRADING="upgrading";this.CallStatus.DOWNGRADING="downgrading";this.CallDirection={};this.CallDirection.INCOMING="i";this.CallDirection.OUTGOING="o";this.MediaDirection={};this.MediaDirection.SENDRECV="sendrecv";this.MediaDirection.SENDONLY="sendonly";this.MediaDirection.RECVONLY="recvonly";this.MediaDirection.INACTIVE="inactive";this.managedStreams=[];this.iceServers=null;this.pc=null;this.session=z;this.callStatus=this.CallStatus.IDLE;this.callStatusExternal=this.CallStatus.DISCONNECTED;this.callDirection=undefined;this.sdpOffer=undefined;this.callId=undefined;this.activeCall=false;this.uaCall=null;this.targetAOR=(typeof B=="string"?[B]:B);this.mediaTypes=x;this.oldMediaTypes=x;this.audioMediaDirection=undefined;this.videoMediaDirection=undefined;this.waitingIce=false;this.remotePeerIds=[];this.isTiledVideo=false;this.dtmfSipBuffer="";this.dtmfSip=(this.session.config.providerConfig.dtmf!=="inband");this.dtmfInband=(this.session.config.providerConfig.dtmf!=="sip");this.holdPending=false;this.resumePending=false;this.telephoneEvent=null;this.crypto=null;this.inviteCount=0;this.initialHoldOffer=false;this.currNonZeroPortCount=0;this.MSID="undefined";this.restoredCall=false;this.localAudioCodecs=[];this.localVideoCodecs=[];this.pullCallInfo=undefined;this.bodilessReInvite=false;this.videoIceUfrag="";this.videoIcePwd="";this.dataChannel=null;var y=this;this.remoteIdentities=function(){return this.remotePeerIds};this.getpc=function(){return this.pc};this.dumpCallInfo=function(){var F=this.getpc();var C,G;C=F.getRemoteStreams();console.log("Number of remote streams: "+C.length);for(G=0;G<C.length;G++){console.log("Stream #"+G);console.log(C[G]);var E,D;E=C[G].getAudioTracks();console.log("# of audio tracks: "+E.length);for(D=0;D<E.length;D++){console.log("track #"+D+", info:");console.log(E[D])}E=C[G].getVideoTracks();console.log("# of video tracks: "+E.length);for(D=0;D<E.length;D++){console.log("track #"+D+", info:");console.log(E[D])}console.log("\n-- End of output for Stream #"+G)}};this.addStream=function(C){var F,E;if(this.callStatus===this.CallStatus.HOLD||this.callStatus===this.CallStatus.REMOTE_HOLD){console.debug("addStream() impossible during call hold");return false}if((this.callStatus===this.CallStatus.CONFIRMED)||(this.callStatus===this.CallStatus.ACCEPTED)){this.callDirection=this.CallDirection.OUTGOING}if(this.pc){F=this.pc.getLocalStreams();if(F.length>0){this.pc.removeStream(F[0]);console.debug("addStream() removeStream: "+F[0].id+"/"+F.length)}}if(this.session.config.providerConfig.persistentPC===false){console.debug("addStream() close peerconnection");if(this.pc){this.pc.close();this.pc=null}}if(!this.pc){console.debug("addStream() create new PeerConnection");this.createPeerConnection()}this.pc.addStream(C.stream());this.mediaTypes=C.type();this.dtmfSender=null;if(this.dtmfInband){E=C.stream().getAudioTracks();if(E.length>0){try{this.dtmfSender=this.pc.createDTMFSender(E[0])}catch(D){this.dtmfSender=null;console.warn("Call.connect() inband DTMF not supported by browser")}}}return true};this.connect=function(){if(this.callStatus===this.CallStatus.HOLD||this.callStatus===this.CallStatus.REMOTE_HOLD){console.debug("Call.connect() impossible during call hold");return false}console.debug("Call.connect()");console.debug("---------- The Call Connect parameters begin ----------");for(var C=0;C<this.targetAOR.length;C++){console.debug("targetAOR: "+this.targetAOR[C])}console.debug("oldMediaTypes: "+this.oldMediaTypes);console.debug("mediaTypes: "+this.mediaTypes);console.debug("---------- The Call Connect parameters end ----------");if(this.pc){if(this.callDirection===this.CallDirection.INCOMING){this.accept()}else{this.sendCallOffer()}}else{console.warn("Call.connect() Peer connection is not created")}return true};this.disconnect=function(){console.debug("Call.disconnect() status: "+this.callStatus);this.session.needAuthOnReRegister=false;if((this.callStatus===this.CallStatus.IDLE)||this.callStatus===this.CallStatus.RINGING||this.callStatus==this.CallStatus.PREPARING_OFFER){if(this.callDirection===this.CallDirection.OUTGOING){this.session.adapter.cancelCallSession(this);this.callStatus=this.CallStatus.CANCELING}else{if(this.callDirection===this.CallDirection.INCOMING){this.session.adapter.rejectCallSession(this);this.callStatus=this.CallStatus.REFUSED;this.callStatusExternal=CallStatus.REJECTED}}}else{console.debug("Call.disconnect() [activeCall = "+this.activeCall+", callStatus = "+this.callStatus+", callDirection = "+this.callDirection+"]");if(this.callDirection===this.CallDirection.INCOMING&&!this.activeCall){this.session.adapter.rejectCallSession(this);this.callStatus=this.CallStatus.REFUSED;this.callStatusExternal=CallStatus.REJECTED}else{this.callStatus=this.CallStatus.FAILED;this.callStatusExternal=CallStatus.DISCONNECTED;this.session.adapter.terminateCallSession(this)}}};this.reject=function(){console.debug("Call.reject()");if(this.activeCall===true){this.callStatus=this.CallStatus.PREPARING_ANSWER;this.markActionNeeded();return}this.callStatus=this.CallStatus.REFUSED;this.callStatusExternal=CallStatus.REJECTED;this.session.adapter.rejectCallSession(this)};this.remoteStreams=function(){return this.managedStreams};this.getStatus=function(){return this.callStatusExternal};this.getMediaTypes=function(){return this.mediaTypes};this.addParticipant=function(C){this.session.adapter.doRefer(this,C,true)};this.removeParticipant=function(C){this.session.adapter.doRefer(this,C,false)};this.sendDTMF=function(C){var E=this.session.config.providerConfig.dtmfDuration;var F=this.session.config.providerConfig.dtmfGap;console.debug("sendDTMF dtmfDuration: "+E);console.debug("sendDTMF dtmfGap: "+F);console.debug("sendDTMF "+C);if(this.activeCall===true){if(this.dtmfInband){if(this.dtmfSender){try{this.dtmfSender.insertDTMF(C,E,F)}catch(D){console.error("Error from insertDTMF: "+D.message)}}else{console.error("Could not send inband DTMF")}}if(this.dtmfSip){if(this.dtmfSipBuffer.length>0){this.dtmfSipBuffer+=","+C}else{this.dtmfSipBuffer=C;this.sendDTMFBuffer()}}}};this.sendDTMFBuffer=function(){var D=y.session.config.providerConfig.dtmfGap;console.debug("sendDTMFBuffer dtmfGap: "+D);var C;if(y.dtmfSipBuffer.length>0){C=y.dtmfSipBuffer[0];y.dtmfSipBuffer=y.dtmfSipBuffer.substring(1);if(C===","){D=2000}else{y.session.adapter.sendDTMFSip(y,C)}if(y.dtmfSipBuffer.length>0){setTimeout(y.sendDTMFBuffer,D)}}};this.transfer=function(C){this.session.adapter.doRefer(this,C,true)};this.startVideo=function(){this.updateCall({audio:undefined,video:"sendrecv"})};this.stopVideo=function(){this.updateCall({audio:undefined,video:"none"})};this.updateCall=function(D){var C=false;var F=false;var E=false;if(D.audio!==this.audioMediaDirection){console.debug("updateCall() audio: "+this.audioMediaDirection+" => "+D.audio);C=true;this.audioMediaDirection=D.audio}if(D.video!==this.videoMediaDirection){console.debug("updateCall() video: "+this.videoMediaDirection+" => "+D.video);C=true;this.videoMediaDirection=D.video}if(D.audio===undefined){F=false}else{F=true}if(D.video===undefined){E=false}else{E=true}if(F===true){if(E===true){this.mediaTypes="audio,video"}else{this.mediaTypes="audio"}}else{if(E===true){this.mediaTypes="video"}else{this.mediaTypes=""}}if(C){this.sendCallOffer()}};this.sendCallOffer=function(){var C;console.debug("Call.invite(): oldMediaTypes="+this.oldMediaTypes+"; current mediaTypes="+this.mediaTypes);this.callDirection=this.CallDirection.OUTGOING;if(this.targetAOR.length>1){this.isTiledVideo=this.mediaTypes.indexOf("video")>-1}for(C=0;C<this.targetAOR.length;C+=1){this.remotePeerIds.push({id:this.targetAOR[C]})}this.markActionNeeded()};this.hold=function(C){if(this.callStatus===this.CallStatus.HOLD||this.callStatus===this.CallStatus.REMOTE_HOLD){console.debug("Call.hold() impossible, already on hold");return false}console.debug("Call.hold() type = "+C);if(C===undefined){C="inactive"}if(C!="sendonly"&&C!="inactive"){console.debug("Call.hold invalid type = ",+C);return false}var D={};if(this.mediaTypes.indexOf("audio")!==-1){D.audio=C}if(this.mediaTypes.indexOf("video")!==-1){D.video=C}this.holdPending=true;this.updateCall(D);return true};this.resume=function(){if(this.callStatus!==this.CallStatus.HOLD){console.debug("Call.resume() impossible, no local hold");return false}console.debug("Call.resume()");if((this.mediaTypes.indexOf("video")===-1)&&(this.mediaTypes.indexOf("audio")===-1)){console.debug("Call.hold invalid mediaTypes=",+this.mediaTypes);return false}this.resumePending=true;var C={};if(this.mediaTypes.indexOf("audio")!==-1){C.audio="sendrecv"}if(this.mediaTypes.indexOf("video")!==-1){C.video="sendrecv"}this.updateCall(C);return true};this.markActionNeeded=function(){this.actionNeeded=true;var C=this;this.doLater(function(){C.onStableStatus();C.dumpCallInfo()})};this.doLater=function(C){setTimeout(C,1)};this.determineWaitingIce=function(C){var E=C.sdp.split("\r\nm=");var D;if(E.length>=2){for(D=1;D<E.length;D++){if(E[D].indexOf(" 0 RTP/")===-1&&E[D].indexOf("\r\na=candidate:")===-1){console.trace("m= line "+D+" does not have ice-candidates.. setting self.waitingIce to true");y.waitingIce=true;break}else{console.trace("m= line "+D+" already has ice-candidates or m= line has port zero")}}}else{console.trace("ERROR: local SDP does not have any m= lines. mLines.length="+E.length)}};this.mediaTypeFromSdp=function(D){var I=undefined,H,G;var C=(/a=dcsa:[0-9]*:[0-9]* accept-types:(.*)\r\n/).exec(D);var E=null;var K=null;if(C){C=C[1]}console.log("parsed accept-types: "+C+", type: "+typeof C);var J=(/a=dcsa:[0-9]*:[0-9]* file-selector:name:"(.*)" type:(.*)\r\n/).exec(D);if(J){E=decodeURIComponent(J[1]);K=J[2];console.log("parsed file-selector name: "+E+", type: "+K)}if(D.search("m=audio")!==-1){if((D.search("m=video")!==-1)&&(D.search("m=video 0")===-1)){I="audio,video"}else{I="audio"}}else{if(D.search("m=video")!==-1){I="video"}else{if(D.search("m=application")!==-1){if(E===null){I="chat"}else{if(C.search("image")!==-1){I="imageshare"}else{var F=(/\.(.*)/).exec(E)[1].toLowerCase();console.log("fileExtension: "+F);if(F.match(/jpg|bmp|gif|png/)){I="imageshare"}else{I="filetransfer"}}}console.log("parsed mediatypes: "+I);if(!this.msrpToPath&&(this.callStatus===this.CallStatus.IDLE||this.callStatus===this.CallStatus.ACCEPTED)){this.msrpToPath=(/a=dcsa:[0-9]*:[0-9]* path:([^\s]*)\r\n/).exec(D);if(this.msrpToPath){this.msrpToPath=this.msrpToPath[1]}else{this.msrpToPath=undefined}}H=(/a=dcsa:[0-9]*:[0-9]* file-selector:(.*)\r\n/).exec(D);if(H){H=H[1].split(" ");this.msrpFileProperties={};for(G=0;G<H.length;G++){if(H[G].indexOf(":")>-1){this.msrpFileProperties[H[G].split(":")[0]]=H[G].split(":")[1]}}if(this.msrpFileProperties.name){this.msrpFileProperties.name=E}}}else{I=undefined}}}return I};this.setMediaTypeFromSdp=function(D){var C=this.mediaTypeFromSdp(D);this.mediaTypes=C;this.oldMediaTypes=C};this.setLDsuccessOnCreateOfferSuccess=function(){console.debug("setLDsuccessOnCreateOfferSuccess(): setLocalDescription success: restoredCall = "+y.restoredCall);y.callStatus=y.CallStatus.PREPARING_OFFER;y.callStatusExternal=CallStatus.CONNECTING;y.sdpOffer=sdpOffer.sdp;y.localAudioCodecs=y.getCodecsFromSDP(y.sdpOffer,"audio");y.localVideoCodecs=y.getCodecsFromSDP(y.sdpOffer,"video");y.markActionNeeded()};this.setLDsuccessOnCreateAnswerSuccess=function(){console.debug("setLDsuccessOnCreateAnswerSuccess(): setLocalDescription success: restoredCall = "+y.restoredCall);y.callStatus=y.CallStatus.PREPARING_ANSWER;y.markActionNeeded()};this.setLDfailure=function(C){console.error("setLocalDescription failure: "+C);y.errorCallback(C)};this.createAnswerSuccess=function(E){var C;var D;console.debug("unmodified local SDP from createAnswer:\n"+E.sdp);E=y.updateSDPCrypto(E,"answer");E=y.updateSDPssrc(E,"answer");E=y.updateSDPcodecs(E,"answer","audio",y.session.config.providerConfig.audioCodecs);E=y.updateSDPcodecs(E,"answer","video",y.session.config.providerConfig.videoCodecs);E=y.updateSDPOfferMediaBundle(E,"answer");E=y.updateSDPBandwidth(E,"answer");y.pc.setLocalDescription(E,y.setLDsuccessOnCreateAnswerSuccess,y.setLDfailure);y.localAudioCodecs=y.getCodecsFromSDP(E.sdp,"audio");y.localVideoCodecs=y.getCodecsFromSDP(E.sdp,"video");C=y.getSDPattrValue(E.sdp,"video","ice-ufrag:");D=y.getSDPattrValue(E.sdp,"video","ice-pwd:");if((C!=y.videoIceUfrag)||(D!=y.videoIcePwd)){console.log("new ICE Params on createAnswer:\n\tprior videoIceUfrag = "+y.videoIceUfrag+"\t  New videoIceUfrag = "+C+"\tprior videoIcePwd   = "+y.videoIcePwd+"\t  New videoIcePwd   = "+D);y.videoIceUfrag=C;y.videoIcePwd=D}console.trace("createAnswerSuccess() setLocalDescription sdp = "+E.sdp);y.determineWaitingIce(E)};this.createAnswerFailure=function(C){console.error("createAnswer failure: "+C);y.callStatus=y.CallStatus.FAILED;y.callStatusExternal=CallStatus.DISCONNECTED;y.errorCallback(C);y.markActionNeeded()};this.setRDsuccess=function(){console.debug("setRemoteDescription success");y.dumpCallInfo()};this.setRDfailure1=function(C){console.error("setRemoteDescription failure: "+C);y.callStatus=y.CallStatus.FAILED;y.callStatusExternal=CallStatus.DISCONNECTED;y.errorCallback(C)};this.setRDfailure2=function(C){console.error("setRemoteDescription failure: "+C);y.errorCallback(C)};this.getNonZeroPortCount=function(E){var D,F,C;D=E.split("\r\nm=");C=0;for(F=1;F<D.length;F++){port=D[F].match(/ \d* /);if(port!=0){C=C+1}}return C};this.updateMSID=function(F){var D,H;var C;var J;switch(y.session.config.providerConfig.msidHandling){case"0":console.debug("updateMSID(), msidHandling is 'Strip Incoming MSID (default)'.\n");F=F.replace(/a=msid-semantic.*\r\n/g,"");F=F.replace(/a=ssrc:.* label:.*\r\n/g,"");console.debug("a=ssrc.* label:.* -removed");F=F.replace(/a=ssrc:.* mslabel:.*\r\n/g,"");console.debug("a=ssrc.* mslabel:.* -removed");return F;case"1":break;case"2":console.debug("updateMSID() no change, msidHandling is 'None, no applicable handling'.\n");return F;default:console.debug("updateMSID() no change, msidHandling is 'Undefined'  ("+y.session.config.providerConfig.msidHandling+")");return F}console.debug("updateMSID(), msidHandling is 'Generate/Replace Incoming MSID'.\n");if(!F.match(/ssrc:\d* /)){console.log("No ssrc lines... so not adding msid");return F}F=F.replace(/a=msid-semantic.*\r\n/g,"");console.debug("a=msid-semantic removed");F=F.replace(/a=ssrc:.* label:.*\r\n/g,"");console.debug("a=ssrc.* label:.* -removed");F=F.replace(/a=ssrc:.* mslabel:.*\r\n/g,"");console.debug("a=ssrc.* mslabel:.* -removed");F=F.replace(/a=msid:.*\r\n/g,"");console.debug("a=msid.* -removed");F=F.replace(/a=ssrc:.* msid:.*\r\n/g,"");console.debug("a=ssrc.* msid:.* -removed");D=F.split("\r\nm=");C=this.getNonZeroPortCount(F);if(this.currNonZeroPortCount!=C){console.debug("currNonZeroPortCount="+this.currNonZeroPortCount+"!= newPortCount="+C+". Generating new MSID");this.currNonZeroPortCount=C;J="orca-wms-id-"+Math.round(Math.random()*100000000000);this.MSID=J;console.debug("Using new MSID generated '"+J+"'")}else{J=this.MSID;console.debug("Using previous MSID '"+J+"'")}D[0]=D[0]+"\r\na=msid-semantic: WMS "+J;for(H=1;H<D.length;H++){var E,L,I;var K=new RegExp("\r\n$");E=D[H];I=E.match(/ssrc:\d* /);if(I){console.log("a=ssrc found.'"+I+"'");L=E.split("a=");msidline=I+"msid:"+J+" ";msidline=msidline+H+"\r\n";mslabelline=I+"mslabel:"+J+"\r\n";labelline=I+"label:"+H;var G;for(G=0;G<L.length;G++){if(L[G].match(/^ssrc:/)){if(K.test(L[G])==true){labelline=labelline+"\r\n"}else{L[G]=L[G]+"\r\n"}L.splice(G+1,0,msidline,mslabelline,labelline);console.debug("Adding msid at position "+G);break}}D[H]=L.join("a=")}}F=D.join("\r\nm=");return F};this.sdpHasDirection=function(E,J,C){var D,F,G,H=["\r\na=sendrecv","\r\na=sendonly","\r\na=recvonly","\r\na=inactive"];if(typeof E==="string"){for(F=0;F<H.length;F+=1){if(H[F].slice(4)===J){H.splice(F,1);break}}if(H.length===4){console.warn("sdpHasDirection() Invalid direction "+J);return false}function K(L){return(L.indexOf("\r\na="+J)>-1)}function I(L){return(L.indexOf(H[0])>-1||L.indexOf(H[1])>-1||L.indexOf(H[2])>-1)}D=E.split("\r\nm=");G=K(D[0])||(J==="sendrecv"&&!I(D[0]));if(D.length===1){if(C){return undefined}return G}if(!C&&!G&&I(D[0])){return false}for(F=1;F<D.length;F+=1){if(C){if(D[F].indexOf(C)===0){return(G?!I(D[F]):K(D[F]))}}else{if(G?I(D[F]):!K(D[F])){return false}}}if(C){return undefined}return true}return false};this.onStableStatus=function(){console.debug("Call.onStableStatus() [actionNeeded = "+this.actionNeeded+", waitingIce = "+this.waitingIce+", status = "+this.callStatus+", callDirection = "+this.callDirection+", activeCall = "+this.activeCall+"]");var F,D,E;if(this.actionNeeded){switch(this.callStatus){case this.CallStatus.IDLE:this.createSDPOffer();break;case this.CallStatus.PREPARING_OFFER:if(this.waitingIce){return}D=this.pc.localDescription.sdp;if(this.callDirection===this.CallDirection.INCOMING){D=this.updateSDPForDTLS(D,"outgoing");D=this.updateSDPCandidate(D,"answer");this.session.adapter.sendResponse(this,200,"OK",D)}else{D=this.updateSDPForDTLS(D,"outgoing");D=this.updateSDPCandidate(D,"offer");D=this.updateSDPDataChannel(D,"offer");this.session.adapter.createCallSession(this,this.targetAOR,D);this.callStatus=this.CallStatus.CALLING}break;case this.CallStatus.ACCEPTED:if(this.sdpOffer!==undefined){this.sdpOffer=this.updateSDPForTempWorkarounds(this.sdpOffer,"offer");var G=this.sdpOffer;G=G.replace(/\r\na=setup:passive/g,"");var C=this.sdpOffer.indexOf("m=video");if(C!==-1&&this.sdpOffer.indexOf("VP8")===-1){G=G.substring(0,C)}G=this.updateMSID(G);console.trace("onStableStatus() setRemoteDescription sdp = "+G);this.pc.setRemoteDescription(new RTCSessionDescription({type:"offer",sdp:G}),this.setRDsuccess,this.setRDfailure1);try{E=this;this.pc.createAnswer(this.createAnswerSuccess,this.createAnswerFailure)}catch(H){console.error("Call.onStableStatus() webkitRTCPeerConnection can not create a SDP answer, exception = "+H);E.callStatus=E.CallStatus.FAILED;E.callStatusExternal=CallStatus.DISCONNECTED;E.markActionNeeded()}}else{this.createSDPOffer()}break;case this.CallStatus.PREPARING_ANSWER:if(this.waitingIce){return}D=this.pc.localDescription.sdp;var C=D.indexOf("m=video");if(C===-1&&this.sdpOffer.indexOf("m=video")!==-1){D=D+"m=video 0 RTP/SAVPF 0\nc=IN IP4 0.0.0.0\n"}D=this.updateSDPForDTLS(D,"outgoing");D=this.updateSDPCandidate(D,"answer");D=this.updateSDPDataChannel(D,"answer");this.session.adapter.sendResponse(this,200,"OK",D);this.setMediaTypeFromSdp(D);break;case this.CallStatus.CONFIRMED:case this.CallStatus.HOLD:if(this.activeCall===false){this.activeCall=true}else{if((this.activeCall===true)&&(this.callDirection===this.CallDirection.OUTGOING)){this.createSDPOffer()}}break;case this.CallStatus.FAILED:if(this.activeCall===true){this.callStatus=this.CallStatus.CONFIRMED;this.callStatusExternal=CallStatus.CONNECTED}else{console.warn("call FAILED");if(this.callDirection===this.CallDirection.INCOMING){this.reject();this.errorCallback("call failed")}}break;case this.CallStatus.CALLING:case this.CallStatus.CANCELED:break;default:console.warn("Call.onStableStatus() Dazed and confused in state "+this.callStatus+", stopping here");break}}};this.onRTCPeerConnectionOnAddStream=function(C){console.debug("Call.onRTCPeerConnectionOnAddStream()");var D,E;D=orca.createManagedStream(C.stream);C.stream.onaddtrack=function(F){console.log("onaddtrack ",C.stream.getVideoTracks());var G,H;G=orca.createManagedStream(C.stream);y.managedStreams.push(G);H={name:CallStatus.ADDSTREAM}};y.managedStreams.push(D);this.callStatusExternal=CallStatus.ADDSTREAM;E={name:CallStatus.ADDSTREAM};y.callback.onAddStream(D,E)};this.onRTCPeerConnectionOnConnecting=function(C){console.debug("Call.onRTCPeerConnectionConnecting()")};this.onRTCPeerConnectionOnGatheringChange=function(C){console.debug("onRTCPeerConnectionOnGatheringChange()");if(C.currentTarget!==undefined){console.debug("onRTCPeerConnectionOnGatheringChange() evt.currentTarget.iceGatheringState = "+C.currentTarget.iceGatheringState);if(C.currentTarget.iceGatheringState==="complete"){if((y.callStatus===y.CallStatus.PREPARING_OFFER)||(y.callStatus===y.CallStatus.PREPARING_ANSWER)){y.waitingIce=false;y.markActionNeeded()}else{console.debug("onRTCPeerConnectionOnGatheringChange() Event reveived event is dropped")}}}};this.onRTCPeerConnectionOnIceCandidate=function(C){var D;if(C.candidate===null){console.debug("Call.onRTCPeerConnectionIceCandidate() end of candidates [status = "+y.callStatus+", callDirection = "+y.callDirection+", activeCall = "+y.activeCall+"]");if((y.callStatus===y.CallStatus.PREPARING_OFFER||y.callStatus===y.CallStatus.PREPARING_ANSWER)&&(!y.session.config.providerConfig.useFirstCandidate||!y.gotFirstCandidate)){y.gotFirstCandidate=true;y.waitingIce=false;y.markActionNeeded()}else{console.debug("Call.onRTCPeerConnectionOnIceCandidate() RTCPeerConnectionIceEvent received event is dropped")}}else{console.debug("Call.onRTCPeerConnectionIceCandidate() received candidate = "+C.candidate.candidate+" [status = "+y.callStatus+", callDirection = "+y.callDirection+", activeCall = "+y.activeCall+"]");if(y.session.config.providerConfig.useFirstCandidate&&!y.gotFirstCandidate&&(y.callStatus===y.CallStatus.PREPARING_OFFER||y.callStatus===y.CallStatus.PREPARING_ANSWER)){if(y.session.config.providerConfig.removeIPV6Candidates){D=C.candidate.candidate.split(" ");if(D[4]&&D[4].indexOf(":")<0){y.gotFirstCandidate=true;y.waitingIce=false;y.markActionNeeded()}}else{y.gotFirstCandidate=true;y.waitingIce=false;y.markActionNeeded()}}}};this.onRTCPeerConnectionOnNegotiationNeeded=function(C){console.debug("Call.onRTCPeerConnectionNegotiationNeeded()")};this.onRTCPeerConnectionOnOpen=function(C){console.debug("Call.onRTCPeerConnectionOnOpen()")};this.onRTCPeerConnectionOnRemoveStream=function(C){console.debug("Call.onRTCPeerConnectionRemoveStream()")};this.onRTCPeerConnectionOnStatusChange=function(C){console.debug("Call.onRTCPeerConnectionStatusChange() [readyStatus="+C.currentTarget.readyStatus+", iceStatus="+C.currentTarget.iceStatus+"]")};this.onDataChannelOnOpen=function(C){console.debug("Call.onDataChannelOnOpen()")};this.onDataChannelOnClose=function(C){console.debug("Call.onDataChannelOnClose()")};this.onDataChannelOnMessage=function(C){if(C.data instanceof File){console.debug("evt.data  is File")}else{if(C.data instanceof Blob){console.debug("evt.data  is Blob")}else{if(C.data instanceof ArrayBuffer){console.debug("evt.data  is ArrayBuffer")}else{if(C.data instanceof String){console.debug("evt.data  is String")}else{if(typeof C.data==="string"){console.debug("evt.data  is string")}else{console.debug("evt.data  is other : ")}}}}}console.debug("Call.onDataChannelOnMessage() message(length: "+C.data.length+"): "+C.data);if(C.data instanceof String||typeof C.data==="string"){console.log("Received data chan message is String.. doing callback directly");y.callback.onMessage(C.data)}else{console.log("Received data chan message is NOT string .. converting it to binary string");function D(G,H,F){var E=new FileReader();E.onload=function(I){H(I.target.result)};E.onerror=function(I){onFail(I.target.error)};E.readAsBinaryString(new Blob([G],{type:"application/octet-stream"}))}D(C.data,function(E){console.log("converted binary string (length: "+E.length+"), type '"+typeof E+"' "+E);y.callback.onMessage(E)},function(E){console.error("converting to binary string failed"+E)})}};this.createOfferSuccess=function(D){console.log("createOffer worked with new constraint style");console.debug("unmodified local SDP from createOffer:\n"+D.sdp);sdpOffer=y.updateSDPOfferMediaDirection(D,{audio:y.audioMediaDirection,video:y.videoMediaDirection});sdpOffer=y.updateSDPForTempWorkarounds(sdpOffer,"offer");sdpOffer=y.updateSDPCrypto(sdpOffer,"offer");sdpOffer=y.updateSDPssrc(sdpOffer,"offer");sdpOffer=y.updateSDPcodecs(sdpOffer,"offer","audio",y.session.config.providerConfig.audioCodecs);sdpOffer=y.updateSDPcodecs(sdpOffer,"offer","video",y.session.config.providerConfig.videoCodecs);sdpOffer=y.updateSDPOfferMediaBundle(sdpOffer,"offer");sdpOffer=y.updateSDPBandwidth(sdpOffer,"offer");if(y.bodilessReInvite){console.log("Making offer after Offerless Invite received.");y.bodilessReInvite=false}if((y.videoIceUfrag!="")&&(y.videoIcePwd!="")){var C=y.getSDPattrValue(sdpOffer.sdp,"video","ice-ufrag:");var F=y.getSDPattrValue(sdpOffer.sdp,"video","ice-pwd:");if((C!="")&&(F!="")&&(y.videoIceUfrag!=C)&&(y.videoIcePwd!=F)){console.log("sdpOffer.sdp Before ICE params replaced = \n"+sdpOffer.sdp+"\n\n");sdpOffer.sdp=y.replaceSDPattr(sdpOffer.sdp,"video","ice-ufrag:",y.videoIceUfrag);sdpOffer.sdp=y.replaceSDPattr(sdpOffer.sdp,"video","ice-pwd:",y.videoIcePwd);console.log("sdpOffer.sdp After ICE params replaced = \n"+sdpOffer.sdp+"\n\n")}}if(sdpOffer.sdp!==y.sdpOffer){console.debug("createOffer: "+y.oldMediaTypes+","+y.mediaTypes);if((y.oldMediaTypes&&y.oldMediaTypes.indexOf("video")!==-1)&&(y.mediaTypes.indexOf("video")===-1)){var E=sdpOffer.sdp.indexOf("m=video");if(E!==-1){console.debug("local SDP has m=video line but video is not needed now... adding m=video 0 line and removing existing m=video line");sdpOffer.sdp=sdpOffer.sdp.substring(0,E)}sdpOffer.sdp+="m=video 0 RTP/SAVPF 0\nc=IN IP4 0.0.0.0\n"}if(y.oldMediaTypes&&y.oldMediaTypes.indexOf("video")===-1&&(y.holdPending||y.resumePending)&&(y.mediaTypes.indexOf("video")===-1)){var E=sdpOffer.sdp.indexOf("m=video");if(E!==-1){console.debug("local SDP has m=video line but video is not needed now... removing existing m=video line");sdpOffer.sdp=sdpOffer.sdp.substring(0,E);sdpOffer.sdp+="m=video 0 RTP/SAVPF 0\nc=IN IP4 0.0.0.0\n"}else{console.debug("local SDP has not m=video line")}}y.determineWaitingIce(sdpOffer);if(y.restoredCall){sdpOffer=y.updateSDPForCallRecovery(sdpOffer,"offer")}console.trace("createSDPOffer() setLocalDescription sdp = "+sdpOffer.sdp);y.pc.setLocalDescription(sdpOffer,y.setLDsuccessOnCreateOfferSuccess,y.setLDfailure);return}console.debug("createSDPOffer() Not sending a new offer")};this.createOfferFailure=function(C){console.error("createOffer failure: "+C);y.errorCallback(C)};this.createSDPOffer=function(){console.debug("Call.createSDPOffer()");if(this.pc===null||this.restoredCall){console.log("Creating new peer connection");if(this.pc){pc_streams=this.pc.getLocalStreams();this.pc.close();this.pc=null}this.createPeerConnection();if(this.restoredCall){this.pc.addStream(pc_streams[0])}}var F,J,H,D=false,C=false,I;if(this.mediaTypes.indexOf("audio")!==-1){D=true}if(this.mediaTypes.indexOf("video")!==-1){C=true}J={audio:D,video:C};H={mandatory:{OfferToReceiveAudio:D,OfferToReceiveVideo:C}};console.debug("createSDPOffer(): oldMediaTypes="+this.oldMediaTypes+"; current mediaTypes="+this.mediaTypes);if(this.holdPending===false&&this.resumePending===false){if(this.mediaTypes.indexOf("audio")!==-1){this.audioMediaDirection=this.MediaDirection.SENDRECV}if(this.mediaTypes.indexOf("video")!==-1){this.videoMediaDirection=this.MediaDirection.SENDRECV}}try{this.pc.createOffer(this.createOfferSuccess,this.createOfferFailure,J)}catch(G){try{this.pc.createOffer(this.createOfferSuccess,this.createOfferFailure,H)}catch(E){console.error("Call.createSDPOffer() webkitRTCPeerConnection can not create a SDP offer, exception = "+E)}}};this.updateSDPCandidate=function(T,V){console.debug("updateSDPCandidate()");var D,Q,U,S,R,P,M,C,O,L,E,N,F=false,K=/^(audio|video|application) ([0-9]+)([^\r\n]*)/,J=/(\r\nc=[^\s]* )([^\s]*) ([^\s]*)/,I=/\r\na=candidate:[^\s]* [^\s]* UDP [^\s]* ([^\s]*) ([^\s]*)/gi,H=/\r\na=candidate:[^\r\n]*/g,G=/(\r\na=rtcp:)([^\s]*) ([^\s]*) ([^\s]*) ([^\s]*)/;if(RTCSessionDescription&&T instanceof RTCSessionDescription){D=T.sdp}else{if(window.SessionDescription&&T instanceof SessionDescription){D=T.toSdp()}else{D=T}}Q=D.split("\r\nm=");E=Q[0].match(J);for(U=1;U<Q.length;U+=1){if(this.session.config.providerConfig.removeIPV6Candidates){C=Q[U].match(H);if(C){for(S=0;S<C.length;S+=1){O=C[S].split(" ");if(O[4]&&O[4].indexOf(":")>-1){Q[U]=Q[U].replace(C[S],"");F=true}}if(F){P=G.exec(Q[U]);C=Q[U].match(I);if(P&&P[5].indexOf(":")>-1&&C&&C[1]){C=I.exec(C[1]);Q[U]=Q[U].replace(G,"$1"+C[2]+" $3 IP4 "+C[1])}}}}M=Q[U].match(K);if(M){M=M[2];P=Q[U].match(J);if(P){P=P[3];N=false}else{if(E){P=E[3];N=true}}if(P){L=false;C=Q[U].match(I);if(C){for(S=0;S<C.length;S+=1){O=C[S].split(" ");if(P===O[4]&&M===O[5]){L=true;break}}}if(!L){O=I.exec(Q[U]);if(O){P=O[1];M=O[2];R=(O[1].indexOf(":")>-1)?"IP6":"IP4";if(N){Q[U]=Q[U].replace(K,"$1 "+M+"$3"+(P===E[3]?"":E[0].replace(J,"$1"+R+" "+P)))}else{Q[U]=Q[U].replace(K,"$1 "+M+"$3").replace(J,"$1"+R+" "+P)}F=true}}}}}if(F){D=Q.join("\r\nm=");console.debug("updateSDPCandidate() SDP has been updated:"+D);if(RTCSessionDescription&&T instanceof RTCSessionDescription){return new RTCSessionDescription({type:V,sdp:D})}else{if(window.SessionDescription&&T instanceof SessionDescription){return new SessionDescription(D)}}return D}console.debug("updateSDPCandidate() SDP has not been updated");return T};this.updateSDPOfferMediaDirection=function(H,D){var E,G,F,C,I;if(RTCSessionDescription&&H instanceof RTCSessionDescription){E=H.sdp}else{if(window.SessionDescription&&H instanceof SessionDescription){E=H.toSdp()}else{E=H}}G=E;C=-1;I=false;if(D.audio!==undefined){C=E.indexOf("a=sendrecv");if(C===-1){C=E.indexOf("a=sendonly");if(C===-1){C=E.indexOf("a=recvonly");if(C===-1){C=E.indexOf("a=inactive")}}}if(C!==-1){G=E.substring(0,C);G=G+"a="+D.audio;G=G+E.substring(C+10);I=true}}if(D.video!==undefined){C=E.lastIndexOf("a=sendrecv");if(C===-1){C=E.lastIndexOf("a=sendonly");if(C===-1){C=E.lastIndexOf("a=recvonly");if(C===-1){C=E.indexOf("a=inactive")}}}if(C!==-1){F=G.substring(0,C);F=F+"a="+D.video;F=F+G.substring(C+10);I=true}}else{F=G}if(I===true){if(RTCSessionDescription&&H instanceof RTCSessionDescription){return new RTCSessionDescription({type:"offer",sdp:F})}else{if(window.SessionDescription&&H instanceof SessionDescription){return new SessionDescription(F)}}return F}console.debug("Call.updateSDPOfferMediaDirection() medias = "+D,", SDP has not been updated)");return H};this.updateSDPOfferMediaBundle=function(E,G){var D,F,C;if(y.session.config.providerConfig.bundle==true){console.debug("updateSDPOfferMediaBundle() no change, bundle is true.\n");return E}else{console.debug("updateSDPOfferMediaBundle() entry.\n")}if(RTCSessionDescription&&E instanceof RTCSessionDescription){D=E.sdp}else{if(window.SessionDescription&&E instanceof SessionDescription){D=E.toSdp()}else{D=E}}F=false;C=D.indexOf("a=group:BUNDLE audio video");if(C!==-1){F=true;D=D.replace("a=group:BUNDLE audio video\r\n","")}else{C=D.indexOf("a=group:BUNDLE audio");if(C!==-1){F=true;D=D.replace("a=group:BUNDLE audio\r\n","")}else{C=D.indexOf("a=group:BUNDLE video");if(C!==-1){F=true;D=D.replace("a=group:BUNDLE video\r\n","")}}}if(F===true){if(RTCSessionDescription&&E instanceof RTCSessionDescription){return new RTCSessionDescription({type:G,sdp:D})}else{if(window.SessionDescription&&E instanceof SessionDescription){return new SessionDescription(D)}}return D}console.debug("updateSDPOfferMediaBundle() SDP has not been updated)");return E};this.updateSDPCrypto=function(E,G){console.debug("updateSDPCrypto()");var D,F,C;if(RTCSessionDescription&&E instanceof RTCSessionDescription){D=E.sdp}else{if(window.SessionDescription&&E instanceof SessionDescription){D=E.toSdp()}else{D=E}}F=false;if(this.session.config.providerConfig.crypto.toLowerCase()!=="dtls-srtp"){C=D.indexOf("a=crypto:0 ");if(C!==-1){F=true;if(D.indexOf("a=crypto:1")===-1){D=D.replace(/a=crypto:0/g,"a=crypto:1")}else{D=D.replace(/a=crypto:0.*\r\n/g,"")}}if(G==="offer"){D=D.replace(/a=fingerprint.*\r\n/g,"");D=D.replace(/a=setup:actpass\r\n/g,"");F=true}}if(F===true){if(RTCSessionDescription&&E instanceof RTCSessionDescription){return new RTCSessionDescription({type:G,sdp:D})}else{if(window.SessionDescription&&E instanceof SessionDescription){return new SessionDescription(D)}}return D}console.debug("updateSDPCrypto() SDP has not been updated)");return E};this.updateSDPssrc=function(D,H){var C;var E;var G=false;if(y.session.config.providerConfig.stripExtraSSRC==false){console.debug("updateSDPssrc() no change, stripExtraSSRC is false.\n");return D}else{console.debug("updateSDPssrc() entry.\n")}if(RTCSessionDescription&&D instanceof RTCSessionDescription){E=D.sdp}else{if(window.SessionDescription&&D instanceof SessionDescription){E=D.toSdp()}else{E=D}}if((E.search("m=video")!=-1)&&(E.search("a=ssrc-group:FID")!=-1)){console.debug("Removing a=fmtp:96 apt=100, a=ssrc-group and 1st set of ssrc for video\n");E=E.replace("a=rtpmap:96 rtx/90000\r\na=fmtp:96 apt=100\r\n","");E=E.replace("100 116 117 96\r\n","100 116 117\r\n");E=E.replace(/a=ssrc-group:FID.*\r\n/,"");E=this.removeSDPattr(E,"video","ssrc:",1,4);G=true}if((E.search("m=video")!=-1)&&(E.search("a=rtpmap:96 rtx/90000")!=-1)){console.debug("rtx found. Removing a=fmtp:96 apt=100\n");E=E.replace("a=rtpmap:96 rtx/90000\r\na=fmtp:96 apt=100\r\n","");E=E.replace("100 116 117 96\r\n","100 116 117\r\n");G=true}E=E.split("\r\nm=");for(C=0;C<E.length;C++){if(E[C].indexOf("audio")==0){var F=E[C].split("a=ssrc:");if(F.length>5){F.splice(1,F.length-5);E[C]=F.join("a=ssrc:");G=true}break}}E=E.join("\r\nm=");if(G===true){console.debug("updateSDPssrc(), SDP has been updated.");if(RTCSessionDescription&&D instanceof RTCSessionDescription){return new RTCSessionDescription({type:H,sdp:E})}else{if(window.SessionDescription&&D instanceof SessionDescription){return new SessionDescription(E)}}return E}console.debug("updateSDPssrc(), SDP has not been updated.");return D};this.removeSDPattr=function(C,K,I,J,H){var G,F,E,D;if(H<=0){H=1000}C=C.split("\r\nm=");if(K=="session"){E=0}else{E=C.length;for(G=1;G<C.length;++G){if(C[G].indexOf(K+" ")==0){E=G;break}}if(E==C.length){console.debug("removeSDPattr() no "+K+" stream found.\n");C=C.join("\r\nm=");return C}}D=C[E];D=D.split("\r\n");for(G=0;G<D.length;++G){if(D[G].indexOf("a="+I)==0){if(J>1){--J;continue}D.splice(G,1);--G;--H;if(H==0){break}}}C[E]=D.join("\r\n");C=C.join("\r\nm=");return C};this.getSDPattrValues=function(C,L,J,K,H){var G,F,E,D;var I;var M=[];if(H<=0){H=1000}C=C.split("\r\nm=");if(L=="session"){E=0}else{E=C.length;for(G=1;G<C.length;++G){if(C[G].indexOf(L+" ")==0){E=G;break}}if(E==C.length){console.debug("getSDPattrValues() no "+L+" stream found.\n");C=C.join("\r\nm=");return M}}D=C[E];D=D.split("\r\n");for(G=0;G<D.length;++G){if(D[G].indexOf("a="+J)==0){if(K>1){--K;continue}I=D[G].substr(D[G].indexOf(":")+1);M.push(I);--H;if(H==0){break}}}C[E]=D.join("\r\n");C=C.join("\r\nm=");return M};this.getSDPattrValue=function(F,D,C){var E=this.getSDPattrValues(F,D,C,1,1);if(E.length!=0){return E[0]}else{return""}};this.replaceSDPattr=function(C,K,J,D){var I,H,F,G;C=C.split("\r\nm=");if(K=="session"){F=0}else{F=C.length;for(I=1;I<C.length;++I){if(C[I].indexOf(K+" ")==0){F=I;break}}if(F==C.length){console.debug("replaceSDPattr() no "+K+" stream found.\n");C=C.join("\r\nm=");return C}}G=C[F];G=G.split("\r\n");for(I=0;I<G.length;++I){if(G[I].indexOf("a="+J)==0){var E=G[I].substring(0,G[I].indexOf(":")+1);G[I]=E+D}}C[F]=G.join("\r\n");C=C.join("\r\nm=");return C};this.getCodecsFromSDP=function(D,K){var H,G,F;var E=[];var I=new RegExp("\r\n$");console.debug("getCodecsFromSDP():\n\tmediaType = "+K+"\n");D=D.split("\r\nm=");for(H=0;H<D.length;H++){if(D[H].indexOf(K)==0){var M=D[H].split("\r\n");var L=M[0].split(" ");for(G=3;G<L.length;G++){if(isNaN(L[G])==false){var J="";var C="a=rtpmap:"+L[G]+" ";for(F=0;F<M.length;++F){if(M[F].indexOf(C)==0){break}}if(F<M.length){J=M[F].substring(C.length);if(I.test(J)){J=J.substr(0,J.length-2)}}else{J=y.getCodecFromStaticPayloadType(L[G])}if(J!=""){console.debug("PT("+L[G]+"): "+J+" FOUND in availableCodecSet.\n");E.push({payloadType:L[G],codec:J})}}}break}}for(H=0;H<E.length;H++){console.debug("codecArray["+H+"] = "+E[H].payloadType+":"+E[H].codec+"\n")}return E};this.getCodecsFromArray=function(D){var C;var E="";for(C=0;C<D.length;++C){if(C>0){E=E+","}E=E+D[C].codec}return E};this.getCodecFromStaticPayloadType=function(D){var C;switch(D){case (0):C="PCMU/8000";break;case (8):C="PCMA/8000";break;case (9):C="G722/8000";break;case (13):C="CN/8000";break;case (18):C="G729/8000";break;default:C="";break}return C};this.updateSDPForCallRecovery=function(D,E){var C;console.debug("updateSDPForCallRecovery():\n\tsdpType = "+E+"\n\tlocalAudioCodecs count = "+y.localAudioCodecs.length+"\n\tlocalVideoCodecs count = "+y.localVideoCodecs.length);if((y.localAudioCodecs.length==0)&&(y.localVideoCodecs.length==0)){return D}C=y.getCodecsFromArray(y.localAudioCodecs);D=y.updateSDPcodecs(D,E,"audio",C);D=y.updateSDPpayloadTypes(D,E,"audio",y.localAudioCodecs);C=y.getCodecsFromArray(y.localVideoCodecs);D=y.updateSDPcodecs(D,E,"video",C);D=y.updateSDPpayloadTypes(D,E,"video",y.localVideoCodecs);console.debug("updateSDPForCallRecovery() completed. SDP :\n"+D.sdp+"\n");return D};this.updateSDPpayloadTypes=function(L,F,N,Q){var J,H;var D;var I=false;var M=[];var C=[];var E=[];var K;console.debug("updateSDPpayloadTypes():\n\tsdpType = "+F+"\n\tmediaType = "+N+"\n\tnewPTArray count = "+Q.length+"\n");if(Q.length==0){return L}if(RTCSessionDescription&&L instanceof RTCSessionDescription){D=L.sdp}else{if(window.SessionDescription&&L instanceof SessionDescription){D=L.toSdp()}else{D=L}}M=y.getCodecsFromSDP(D,N);C.length=0;for(J=0;J<M.length;++J){for(H=0;Q.length;++H){if(M[J].codec==Q[H].codec){if(M[J].payloadType!=Q[H].payloadType){C.push({codec:M[J].codec,oldPT:M[J].payloadType,newPT:Q[H].payloadType})}break}}}if(C.length==0){console.debug("updateSDPpayloadTypes(): No change in "+N+" payloadTypes.\n");return L}else{for(J=0;J<128;++J){E.push({substitutionNeeded:false,newPT:J.toString()})}for(J=0;J<C.length;J++){console.debug("codecPTmap["+J+"] = "+C[J].codec+":"+C[J].oldPT+":"+C[J].newPT+"\n");E[parseInt(C[J].oldPT)].substitutionNeeded=true;E[parseInt(C[J].oldPT)].newPT=C[J].newPT}}D=D.split("\r\nm=");for(J=0;J<D.length;J++){if(D[J].indexOf(N)==0){var P=D[J].split("\r\n");var O=P[0].split(" ");for(H=3;H<O.length;H++){if((isNaN(O[H])==false)&&(E[parseInt(O[H])].substitutionNeeded)){O[H]=E[parseInt(O[H])].newPT;I=true}}P[0]=O.join(" ");for(H=1;H<P.length;H++){if(P[H].indexOf("a=rtpmap:")==0){K=parseInt(P[H].substring(9));if(E[K].substitutionNeeded){P[H]=P[H].replace(new RegExp("a=rtpmap:"+K+" ",""),"a=rtpmap:"+E[K].newPT+" ");I=true}}else{if(P[H].indexOf("a=fmtp:")==0){var G;K=parseInt(P[H].substring(7));if(E[K].substitutionNeeded){P[H]=P[H].replace(new RegExp("a=fmtp:"+K+" ",""),"a=fmtp:"+E[K].newPT+" ");I=true}G=P[H].indexOf("apt=");if(G!=-1){K=parseInt(P[H].substring(G+4));if(E[K].substitutionNeeded){P[H]=P[H].replace(new RegExp(" apt="+K,"")," apt="+E[K].newPT);I=true}}}else{if(P[H].indexOf("a=rtcp-fb:")==0){K=parseInt(P[H].substring(10));if(E[K].substitutionNeeded){P[H]=P[H].replace(new RegExp("a=rtcp-fb:"+K+" ",""),"a=rtcp-fb:"+E[K].newPT+" ");I=true}}}}}D[J]=P.join("\r\n");break}}D=D.join("\r\nm=");if(I===true){console.debug("updateSDPpayloadTypes(), SDP has been updated.");if(RTCSessionDescription&&L instanceof RTCSessionDescription){return new RTCSessionDescription({type:F,sdp:D})}else{if(window.SessionDescription&&L instanceof SessionDescription){return new SessionDescription(D)}}return D}console.debug("updateSDPpayloadTypes(), SDP has not been updated.");return L};this.updateSDPcodecs=function(T,W,D,H){var U,R;var I;var K=false;var O;var aa=new RegExp("\r\n$");var M=false;console.debug("updateSDPcodecs():\n\tsdpType = "+W+"\n\tmediaType = "+D+"\n\tavailableCodecSet = "+H+"\n");if(H==""){return T}if(RTCSessionDescription&&T instanceof RTCSessionDescription){I=T.sdp}else{if(window.SessionDescription&&T instanceof SessionDescription){I=T.toSdp()}else{I=T}}I=I.split("\r\nm=");if(aa.test(I[I.length-2])===false){I[I.length-2]=I[I.length-2]+"\r\n";M=true}for(U=0;U<I.length;U++){if(I[U].indexOf(D)==0){var C=I[U].split("\r\n");var Z=C[0].split(" ");for(R=3;R<Z.length;R++){O=true;if(isNaN(Z[R])==false){var J="";var P="a=rtpmap:"+Z[R]+" ";var V;var L;V=I[U].indexOf(P);if(V!=-1){L=I[U].indexOf("\r\n",V)}switch(Z[R]){case (0):J="PCMU/8000";break;case (8):J="PCMA/8000";break;case (9):J="G722/8000";break;case (13):J="CN/8000";break;case (18):J="G729/8000";break;default:if(V!=-1){J=I[U].substring(V+P.length,L)}else{J=""}break}if((J!="")&&(H.indexOf(J)!=-1)){console.debug("PT("+Z[R]+"): "+J+" FOUND in availableCodecSet.\n")}else{O=false;console.debug("PT("+Z[R]+"): "+J+" NOT FOUND in availableCodecSet.\n")}if(!O){var N=P+".*\r\n";var X="a=fmtp:"+Z[R]+" .*\r\n";var F=" "+Z[R]+" ";var E=" "+Z[R]+"\r";var Q;var Y;I[U]=I[U].replace(new RegExp(N,"g"),"");I[U]=I[U].replace(new RegExp(X,"g"),"");Q=I[U].split("\n");Y=Q[0].split("RTP");Y[1]=Y[1].replace(F," ");Y[1]=Y[1].replace(E,"\r");Q[0]=Y.join("RTP");I[U]=Q.join("\n");if(D=="video"){var G="a=rtcp-fb:"+Z[R]+" .*\r\n";I[U]=I[U].replace(new RegExp(G,"g"),"");if((J!="")&&(J.substr(0,4)=="rtx/")){var S="a=ssrc-group:FID .*\r\n";I[U]=I[U].replace(new RegExp(S,"g"),"");Q=I[U].split("\r\na=");Q.splice(Q.length-8,4);I[U]=Q.join("\r\na=")}}K=true}}}break}}if(M){I[I.length-2]=I[I.length-2].substr(0,I[I.length-2].length-2)}I=I.join("\r\nm=");if(K===true){console.debug("updateSDPcodecs(), SDP has been updated.");if(RTCSessionDescription&&T instanceof RTCSessionDescription){return new RTCSessionDescription({type:W,sdp:I})}else{if(window.SessionDescription&&T instanceof SessionDescription){return new SessionDescription(I)}}return I}console.debug("updateSDPcodecs(), SDP has not been updated.");return T};this.updateSDPForDTLS=function(D,F){console.debug("updateSDPForDTLS(). direction="+F+" config.crypto="+this.session.config.providerConfig.crypto);var C,E=D;if(this.session.config.providerConfig.crypto.toLowerCase()==="dtls-srtp"){if(F=="incoming"){C=E.indexOf(" UDP/TLS/RTP/SAVPF ");if(C!==-1){console.debug("Convert UDP/TLS/RTP/SAVPF to RTP/SAVPF");E=E.replace(/ UDP\/TLS\/RTP\/SAVPF /g," RTP/SAVPF ")}}else{C=E.indexOf(" RTP/SAVPF ");if(C!==-1){console.debug("Convert RTP/SAVPF to UDP/TLS/RTP/SAVPF");E=E.replace(/ RTP\/SAVPF /g," UDP/TLS/RTP/SAVPF ");console.debug("crypto is dtls-srtp. removing a=crypto lines");E=E.replace(/a=crypto.*\r\n/g,"")}}}else{console.debug("crypto is not dtls-srtp. removing fingerprint lines");E=E.replace(/a=fingerprint.*\r\n/g,"")}return E};this.updateSDPAddCodecs=function(G){console.debug("updateSDPAddCodecs()");var D,I,C;var H;var F;if(RTCSessionDescription&&G instanceof RTCSessionDescription){D=G.sdp}else{if(window.SessionDescription&&G instanceof SessionDescription){D=G.toSdp()}else{D=G}}C=D.split("\r\nm=");H=C[0].indexOf("a=inactive");if(H==-1){H=C[0].indexOf("a=sendonly")}I=false;if((/m=video .* RTP\/SAVPF/).test(D)&&!(/a=rtpmap:.* VP8\//).test(D)){C=D.split("\r\nm=");for(var E=0;E<C.length;E++){if(C[E].indexOf("video")==0){F=parseInt(C[E].slice(6));if((C[E].indexOf("a=inactive")>=0)||(C[E].indexOf("a=sendonly")>=0)||((C[E].indexOf("a=sendrecv")==-1)&&(C[E].indexOf("a=recvonly")==-1)&&(H>=0))||(F==0)){I=true;C[E]=C[E].replace(/\r\na=rtpmap:.*/g,"").replace(/\r\na=fmtp:.*/g,"").replace(/(video .* RTP\/SAVPF)(.*)/,"$1 100\r\na=rtpmap:100 VP8/90000");D=C.join("\r\nm=")}break}}}if((/m=audio .* RTP\/SAVPF/).test(D)&&!(/a=rtpmap:.* opus\//).test(D)){C=D.split("\r\nm=");for(var E=0;E<C.length;E++){if(C[E].indexOf("audio")==0){F=parseInt(C[E].slice(6));if((C[E].indexOf("a=inactive")>=0)||(C[E].indexOf("a=sendonly")>=0)||((C[E].indexOf("a=sendrecv")==-1)&&(C[E].indexOf("a=recvonly")==-1)&&(H>=0))||(F==0)){I=true;C[E]=C[E].replace(/(audio .*)/,"$1 111\r\na=rtpmap:111 opus/48000/2\r\na=fmtp:111 minptime=10");console.debug("adding opus");D=C.join("\r\nm=")}break}}}if(I===true){console.debug("updateSDPAddCodecs() SDP has been updated:"+D);if(RTCSessionDescription&&G instanceof RTCSessionDescription){return new RTCSessionDescription({type:"offer",sdp:D})}else{if(window.SessionDescription&&G instanceof SessionDescription){return new SessionDescription(D)}}return D}console.debug("updateSDPAddCodecs() SDP has not been updated)");return G};this.updateSDPForTempWorkarounds=function(D,H){console.debug("updateSDPForTempWorkarounds(). type="+H);var G,C,I,F,E;if(RTCSessionDescription&&D instanceof RTCSessionDescription){G=D.sdp}else{if(window.SessionDescription&&D instanceof SessionDescription){G=D.toSdp()}else{G=D}}I=false;C=G.indexOf("acap:");if(C!==-1){I=true;console.debug("Removed acap from crypto lines");G=G.replace(/acap.*crypto/g,"crypto")}C=G.indexOf(" RTP/AVP ");if(C!==-1&&I===true){I=true;console.debug("Convert RTP/AVP to RTP/SAVPF");G=G.replace(/ RTP\/AVP /g," RTP/SAVPF ")}C=G.indexOf("SAVP ");if(C!==-1){I=true;console.debug("Convert SAVP to SAVPF");G=G.replace(/SAVP /g,"SAVPF ")}if(H==="offer"){F=G.match(/a=rtpmap:(\d+) telephone-event/);console.debug("this.telephoneEvent="+this.telephoneEvent);if(F&&F.length>1){if(this.telephoneEvent){console.debug("this.telephone-event: "+this.telephoneEvent+" and rtpmap in SDP is: "+F);if(this.telephoneEvent!==F[1]){if(G.indexOf("\r\na=rtpmap:"+this.telephoneEvent)>-1){for(C=96;C<=127;C+=1){if(G.indexOf("a=rtpmap:"+C)<0&&C!==this.telephoneEvent){E="(\r\nm=[a-zA-Z]+ [0-9]+ [/a-zA-Z]+[ 0-9]* )"+this.telephoneEvent+"( |\r\n)([ 0-9]*\r?\n?)";G=G.replace(new RegExp(E,"g"),"$1"+C+"$2$3").replace(new RegExp("\r\na=rtpmap:"+this.telephoneEvent,"g"),"\r\na=rtpmap:"+C).replace(new RegExp("\r\na=fmtp:"+this.telephoneEvent,"g"),"\r\na=fmtp:"+C);break}}}E="(\r\nm=[a-zA-Z]+ [0-9]+ [/a-zA-Z]+[ 0-9]* )"+F[1]+"( |\r\n)([ 0-9]*\r?\n?)";G=G.replace(new RegExp(E,"g"),"$1"+this.telephoneEvent+"$2$3").replace(new RegExp("\r\na=rtpmap:"+F[1],"g"),"\r\na=rtpmap:"+this.telephoneEvent).replace(new RegExp("\r\na=fmtp:"+F[1],"g"),"\r\na=fmtp:"+this.telephoneEvent);I=true}}else{console.debug("set this.telephone-event to: "+F[1]);this.telephoneEvent=F[1]}}}if(G.indexOf("a=fingerprint:dummyFunc")!==-1){G=G.replace(/a=fingerprint:dummyFunc.*\r\n/,"");console.log("Removing dummy fingerprint line");I=true}C=G.indexOf("webrtc-DataChannel");if(C!==-1){console.log("Mapping webrtc-DataChannel to webrtc-datachannel 16");G=G.replace(/webrtc-DataChannel/g,"webrtc-datachannel 16");I=true}if(I){console.debug("updateSDPForTempWorkarounds() SDP has been updated:"+G);if(RTCSessionDescription&&D instanceof RTCSessionDescription){return new RTCSessionDescription({type:H,sdp:G})}else{if(window.SessionDescription&&D instanceof SessionDescription){return new SessionDescription(G)}}return G}return D};this.updateSDPMediaIceOption=function(D,F,G){console.debug("updateSDPMediaIceOption()");var E,C;if(RTCSessionDescription&&D instanceof RTCSessionDescription){E=D.sdp}else{if(window.SessionDescription&&D instanceof SessionDescription){E=D.toSdp()}else{E=D}}C=E.indexOf("a=ice-options:google-ice");if(C===-1){E=E.replace(/\r\na=ice-ufrag/g,"\x0d\x0aa=ice-options:"+G+"\x0d\x0aa=ice-ufrag")}if(RTCSessionDescription&&D instanceof RTCSessionDescription){return new RTCSessionDescription({type:F,sdp:E})}else{if(window.SessionDescription&&D instanceof SessionDescription){return new SessionDescription(E)}}return E};this.updateSDPBandwidth=function(D,H){var J,I,G,F,C,E;J=this.getIntOrZero(this.session.config.providerConfig.audioBandwidth);I=this.getIntOrZero(this.session.config.providerConfig.videoBandwidth);G=this.getIntOrZero(this.session.config.providerConfig.dataBandwidth);if(J<=0&&I<=0&&G<=0){console.debug("updateSDPBandwidth() no change, no bandwidth values given");return D}console.debug("updateSDPBandwidth() audioB="+J+" videoB="+I+" dataB="+G);if(RTCSessionDescription&&D instanceof RTCSessionDescription){F=D.sdp}else{if(window.SessionDescription&&D instanceof SessionDescription){F=D.toSdp()}else{F=D}}changed=false;C=F.split("\r\nm=");for(E=0;E<C.length;E+=1){if(J>0&&C[E].indexOf("audio")==0){changed=true;C[E]=this.updateMediaBandwidth(C[E],J)}if(I>0&&C[E].indexOf("video")==0){changed=true;C[E]=this.updateMediaBandwidth(C[E],I)}if(G>0&&C[E].indexOf("application")==0){changed=true;C[E]=this.updateMediaBandwidth(C[E],G)}}if(changed){F=C.join("\r\nm=");console.debug("updateSDPBandwidth() SDP has been updated:"+F);if(RTCSessionDescription&&D instanceof RTCSessionDescription){return new RTCSessionDescription({type:H,sdp:F})}else{if(window.SessionDescription&&D instanceof SessionDescription){return new SessionDescription(F)}}return F}console.debug("updateSDPBandwidth() SDP not changed");return D};this.updateSDPDataChannel=function(H,O){var N,Q,J,F,K,I,M,G,E,L,D,C,P;N=this.getMediaTypes();if(N!=="chat"&&N!=="filetransfer"&&N!=="imageshare"){return H}if(RTCSessionDescription&&H instanceof RTCSessionDescription){Q=H.sdp}else{if(window.SessionDescription&&H instanceof SessionDescription){Q=H.toSdp()}else{Q=H}}J=false;F=Q.split("\r\nm=");for(K=0;K<F.length;K+=1){E=(/^application ([^\s]*) [^\s]* ([^\s]*)/).exec(F[K]);if(E){L=E[2];E=E[1];M="";if(F[K].indexOf("a=data-channel:")<0){M+="a=data-channel:"+L+' stream=0;label="orca";subprotocol="MSRP"\r\n'}if(!(/a=dcsa:[^\s]* accept-types:/).test(F[K])){M+="a=dcsa:"+L+":0 accept-types:";switch(N){case"chat":M+="text/plain message/CPIM\r\n";break;case"imageshare":M+="message/CPIM application/octet-stream image/*\r\n";break;case"filetransfer":M+="message/CPIM application/octet-stream\r\n";break;default:M+="*\r\n"}}if(!(/a=dcsa:[^\s]* path:/).test(F[K])){G=(/\r\nc=[^\s]* [^\s]* ([^\s]*)/).exec(F[K]);if(G){G=G[1];if(!this.msrpFromPath){this.msrpSessionId=Math.random().toString(36).substr(2,16);this.msrpFromPath="msrps://"+G+":"+E+"/"+this.msrpSessionId+";dc"}M+="a=dcsa:"+L+":0 path:"+this.msrpFromPath+"\r\n"}}if(this.msrpFile&&!(/a=dcsa:[^\s]* file-selector:/).test(F[K])){D=encodeURIComponent(this.msrpFile.name||"file");C=this.msrpFile.size||0;P=this.msrpFile.type||"application/octet-stream";M+="a=dcsa:"+L+':0 file-selector:name:"'+D+'" type:'+P+" size:"+C+"\r\n"}if(F[K].indexOf("a=connection:new")<0){M+="a=connection:new\r\n"}if(F[K].indexOf("a=sendrecv")<0&&F[K].indexOf("a=sendonly")<0&&F[K].indexOf("a=recvonly")<0&&F[K].indexOf("a=inactive")<0){M+="a=sendrecv\r\n"}if(M.length>0){J=true;F[K]=F[K].replace(/^(.*\r\n)/,"$1"+M)}}}if(J){Q=F.join("\r\nm=");console.debug("updateSDPDataChannel() SDP has been updated:"+Q);if(RTCSessionDescription&&H instanceof RTCSessionDescription){return new RTCSessionDescription({type:O,sdp:Q})}else{if(window.SessionDescription&&H instanceof SessionDescription){return new SessionDescription(Q)}}return Q}return H};this.updateSDPInitialHold=function(E){var C,F,D,G;C=E.split("\r\nm=");for(F=1;F<C.length;F+=1){if(C[F].indexOf("\r\na=sendonly")<0){D=C[F].indexOf("\r\na=");if(D<0){D=C[F].indexOf("\r\n")}C[F]=C[F].slice(0,D)+"\r\na=sendonly"+C[F].slice(D);G=true}}if(G){E=C.join("\r\nm=");console.debug("updateSDPInitialHold() SDP has been updated:"+E)}else{console.debug("updateSDPInitialHold() No change")}return E};this.updateMediaBandwidth=function(C,D){if(C.indexOf("\r\nb=AS:")>-1){return C.replace(/\r\nb=AS:.*/,"\r\nb=AS:"+D)}return C.replace(/(.*)/,"$1\r\nb=AS:"+D)};this.getIntOrZero=function(C){if(C&&!isNaN(parseInt(C))){return parseInt(C)}return 0};this.isHoldRequest=function(C,D){if((this.audioMediaDirection=="sendonly"||this.audioMediaDirection=="inactive")&&(C=="sendrecv")){return true}if((this.videoMediaDirection=="sendonly"||this.videoMediaDirection=="inactive")&&(D=="sendrecv")){return true}return false};this.parseSDP=function(){var E,H,F,C;this.sdpOffer=this.updateSDPForDTLS(this.sdpOffer,"incoming");if(this.sdpOffer.search("m=message")!==-1){if((this.sdpOffer.search("TCP/MSRP")!==-1)||(this.sdpOffer.search("TCP/TLS/MSRP")!==-1)){return false}}this.mediaTypes=this.mediaTypeFromSdp(this.sdpOffer);E=this.sdpOffer;H=this.sdpOffer;C=-1;audio_start=E.indexOf("audio");video_start=E.indexOf("video");if(audio_start<video_start){audio_end=video_start;video_end=E.length}else{video_end=audio_start;audio_end=E.length}var D=E.slice(audio_start,audio_end);var G=E.slice(video_start,video_end);if(this.mediaTypes.indexOf("audio")!==-1){C=D.indexOf("a=sendrecv");if(C===-1){C=D.indexOf("a=sendonly");if(C===-1){C=D.indexOf("a=recvonly");if(C===-1){C=D.indexOf("a=inactive")}}}if(C!==-1){this.audioMediaDirection=D.substr(C+2,8)}}if(this.mediaTypes.indexOf("video")!==-1){C=G.indexOf("a=sendrecv");if(C===-1){C=G.indexOf("a=sendonly");if(C===-1){C=G.indexOf("a=recvonly");if(C===-1){C=G.indexOf("a=inactive")}}}if(C!==-1){this.videoMediaDirection=G.substr(C+2,8)}}return true};this.accept=function(){console.debug("Call.accept()");this.callStatus=this.CallStatus.ACCEPTED;this.markActionNeeded()};this.clean=function(){console.debug("Call.clean() calls.length: "+this.session.calls.length);this.session.adapter.cleanCallSession(this);var C;for(C=0;C<this.session.calls.length;C+=1){if(this.session.calls[C].callId===this.callId){console.debug("remove call "+this.session.calls[C]+"("+this.callId+")");this.session.calls.splice(C,1);break}}console.debug("Call.clean() calls.length: "+this.session.calls.length);if(this.dataChannel){this.dataChannel.close();this.dataChannel=null}if(this.pc){this.pc.close();this.pc=null}if(this.msrpFile){this.msrpFile=null}};this.setCallStatus=function(D){this.callStatus=D;var C={name:this.callStatus};this.callback.onStatus(this.callStatus,C)};this.incomingCallSessionEvent=function(L){var C,H,E,G,F,I,K,J,M,D;console.debug("Call.incomingCallSessionEvent() event: "+L.name+" status: "+this.callStatus);if(L.name==="confirmed"){if(this.callStatus===this.CallStatus.REFUSED){this.callback.onDisconnected({name:CallStatus.REJECTED});this.clean();return}else{if(this.callStatus===this.CallStatus.CANCELED){this.callback.onDisconnected({name:CallStatus.CANCELED});this.clean();return}}if(this.holdPending){this.holdPending=false;this.callStatusExternal=CallStatus.REMOTE_HOLD;this.callStatus=this.CallStatus.REMOTE_HOLD;C={name:CallStatus.REMOTE_HOLD};this.callback.onStatus(CallStatus.REMOTE_HOLD,C)}else{this.activeCall=true;this.callStatus=this.CallStatus.CONFIRMED;if(this.callStatusExternal===CallStatus.HOLD||this.callStatusExternal===CallStatus.REMOTE_HOLD){this.callStatusExternal=CallStatus.UNHOLD;C={name:CallStatus.UNHOLD};this.callback.onStatus(CallStatus.UNHOLD,C)}else{this.callStatusExternal=CallStatus.CONNECTED;C={name:CallStatus.CONNECTED};this.callback.onConnected(C)}}if(L.sdp){console.debug("received sdp in ACK: "+L.sdp);E=L.sdp;E=this.updateSDPForTempWorkarounds(E,"answer");if(this.session.config.providerConfig.addCodecs){E=this.updateSDPAddCodecs(E)}E=this.updateSDPForDTLS(E,"incoming");E=this.updateMSID(E);console.trace("receivedAck() setRemoteDescription sdp = "+E);this.pc.setRemoteDescription(new RTCSessionDescription({type:"answer",sdp:E}),this.setRDsuccess,this.setRDfailure2);this.setMediaTypeFromSdp(E)}return}else{if(L.name==="canceled"){console.debug("incomingCallSessionEvent: canceled: "+this.callStatus);if(this.callStatus===this.CallStatus.RINGING&&this.callDirection===this.CallDirection.INCOMING){this.callStatus=this.CallStatus.CANCELED;this.callStatusExternal=CallStatus.CANCELED}else{console.warn("invalid call status when receiving cancelled event "+this.callStatus)}return}}if(this.session.config.providerConfig.confWorkaroundChrome){this.inviteCount+=1}this.callDirection=this.CallDirection.INCOMING;if((this.callStatus===this.CallStatus.IDLE)||((this.activeCall===true)&&(this.callStatus===this.CallStatus.CONFIRMED||this.callStatus===this.CallStatus.REMOTE_HOLD||this.callStatus===this.CallStatus.HOLD))){E=L.sdp;if(L.callId){this.callId=L.callId}if(L.uaCall){this.uaCall=L.uaCall}if(L.from){this.targetAOR=[L.from];this.remotePeerIds=[{id:this.targetAOR[0]}]}if(E){this.sdpOffer=E;old_audioMediaDirection=this.audioMediaDirection;old_videoMediaDirection=this.videoMediaDirection;H=this.parseSDP();if(H===false){console.warn("Call.receivedInvite() received a SDP offer with unsupported media");this.session.sendResponse(this,488,"Not Acceptable Here");return}if(this.session.config.providerConfig.confWorkaroundChrome&&this.inviteCount===1&&typeof this.mediaTypes==="string"&&(this.mediaTypes.indexOf("audio")>-1||this.mediaTypes.indexOf("video")>-1)){this.initialHoldOffer=this.sdpHasDirection(this.sdpOffer,"sendonly");if(this.initialHoldOffer){console.log("Conference workaround: First invte.");this.sdpOffer=this.updateSDPInitialHold(this.sdpOffer)}}if(this.session.config.providerConfig.addCodecs){this.sdpOffer=this.updateSDPAddCodecs(this.sdpOffer)}}else{console.debug("receivedInvite() received bodiless INVITE:\n\tset media type to "+this.session.config.mediatypes+"\tUnsetting previous SDP offer, so that a new offer is created.\tcallStatus = "+this.callStatus);this.mediaTypes=this.session.config.mediatypes;this.audioMediaDirection="sendrecv";this.videoMediaDirection="sendrecv";if(this.sdpOffer!=undefined){this.sdpOffer=undefined;this.bodilessReInvite=true;console.log("bodilessReInvite = true\n")}this.sdpOffer=undefined}if(this.session.config.providerConfig.dtmfWorkaround&&!this.isSendingDtmf){G=this.sdpOffer?this.sdpOffer.match(/\r\na=rtpmap:(\d+) telephone-event/):false;if(G){if(this.sdpHasDirection(this.sdpOffer,"sendonly","audio")||this.sdpHasDirection(this.sdpOffer,"inactive","audio")){this.sdpOffer=this.sdpOffer.replace(new RegExp("(\\r\\nm=[a-zA-Z]+ [0-9]+ [a-zA-Z/]+[0-9 ]*) "+G[1]+"(\\r\\n| [0-9 ]+\\r\\n)"),"$1$2").replace(new RegExp("\\r\\na=rtpmap:"+G[1]+".*"),"").replace(new RegExp("\\r\\na=fmtp:"+G[1]+".*"),"")}else{this.isSendingDtmf=true}}}if(this.activeCall===true){if(this.session.config.providerConfig.confWorkaroundChrome&&this.initialHoldOffer){F=(typeof this.sdpOffer==="string")?this.sdpOffer.split("\r\nm=").length:0;I=this.pc.localDescription.sdp.split("\r\nm=").length;K=(typeof this.sdpOffer==="string"&&this.sdpOffer.indexOf("m=video 0 ")>-1);J=this.pc.localDescription.sdp.indexOf("m=video 0 ")>-1;if(I===F&&K===J){M=this.sdpHasDirection(this.sdpOffer,"sendonly");D=this.sdpHasDirection(this.pc.localDescription.sdp,"recvonly");if(!M){this.initialHoldOffer=false}if(!D||M){console.log("Conference workaround: Not doing setRemote/createAnswer, instead sending 200OK with earlier answer. (invteCount="+this.inviteCount+", continue="+this.initialHoldOffer+")");E=this.updateSDPForDTLS(this.pc.localDescription.sdp,"outgoing");this.session.adapter.sendResponse(this,200,"OK",E);return}}else{this.initialHoldOffer=false}console.log("Conference workaround: Do setRemote/createAnswer. (invteCount="+this.inviteCount+", continue="+this.initialHoldOffer+")")}if(this.oldMediaTypes){if(this.oldMediaTypes.indexOf("video")===-1&&this.mediaTypes.indexOf("video")!==-1){console.debug("receivedInvite(): upgrade");this.callStatus=this.CallStatus.UPGRADING;this.callStatusExternal=CallStatus.UPGRADING;C={name:CallStatus.UPGRADING};this.callback.onStatus(CallStatus.UPGRADING,C)}else{if(this.oldMediaTypes.indexOf("video")!==-1&&this.mediaTypes.indexOf("video")===-1){console.debug("receivedInvite(): downgrade");this.callStatus=this.CallStatus.DOWNGRADING;this.callStatusExternal=CallStatus.DOWNGRADING;C={name:CallStatus.DOWNGRADING};this.callback.onStatus(CallStatus.DOWNGRADING,C)}else{if(this.isHoldRequest(old_audioMediaDirection,old_videoMediaDirection)){this.holdPending=true;this.accept()}else{this.accept()}}}}}else{this.isTiledVideo=this.mediaTypes.indexOf("video")>-1&&(/Alcatel-Lucent-HPSS/).test(L.uaString);switch(this.mediaTypes.toLowerCase()){case"filetransfer":G=this.session.callback.createFileTransfer(this.targetAOR[0]);G.getImp().setWrappedCall(this.callback);C={name:SessionStatus.INCOMINGFILE};if(this.msrpFileProperties){C.fileProperties=this.msrpFileProperties}this.session.callback.onIncomingFileTransfer(G,C);break;case"imageshare":G=this.session.callback.createImageShare(this.targetAOR[0]);G.getImp().setWrappedCall(this.callback);C={name:SessionStatus.INCOMINGIMAGE};if(this.msrpFileProperties){C.fileProperties=this.msrpFileProperties}this.session.callback.onIncomingImageShare(G,C);break;case"chat":G=this.session.callback.createChat(this.targetAOR[0]);G.getImp().setWrappedCall(this.callback);C={name:SessionStatus.INCOMINGCHAT};this.session.callback.onIncomingChat(G,C);break;default:if(this.session.autoAnswerMode){this.restoredCall=true;this.session.wsRestoreInProgress=false;C={name:SessionStatus.INCOMINGAUTOANSWER}}else{if(this.session.autoAnswerTimer){C={name:SessionStatus.INCOMINGAUTOANSWER};clearTimeout(this.session.autoAnswerTimer);this.session.autoAnswerTimer=false;this.session.needAuthOnReRegister=true}else{C={name:SessionStatus.INCOMINGCALL}}}console.debug("Sending event = "+C.name);this.session.callback.onIncoming(this.callback,C)}this.session.adapter.sendResponse(this,180,"Ringing");this.callStatus=this.CallStatus.RINGING;this.callStatusExternal=CallStatus.CONNECTING;C={name:CallStatus.CONNECTING};this.callback.onStatus(CallStatus.CONNECTING,C)}}else{console.debug("receivedInvite() received INVITE in state "+this.callStatus);this.session.adapter.sendResponse(this,486,"Busy Here")}};this.terminatedCallSessionEvent=function(C){console.debug("Call.terminatedCallSessionEvent() event: "+C.name+", status: "+this.callStatus);this.clean();if(C.name===CallStatus.CANCELED||this.callStatus===this.CallStatus.CANCELING){this.callback.onDisconnected({name:CallStatus.CANCELED});return}if(this.callStatus===this.CallStatus.REFUSED){this.callback.onDisconnected({name:CallStatus.REJECTED});return}this.callStatusExternal=CallStatus.DISCONNECTED;this.callStatus=this.CallStatus.CLOSED;var D={name:CallStatus.DISCONNECTED};this.callback.onDisconnected(D);if(this.session.ws_only){this.session.ws_only=false;this.session.needAuthOnReRegister=false;this.session.adapter.createSession()}};this.ringingCallSessionEvent=function(C){console.debug("Call.ringingCallSessionEvent() event: "+C.name);if(this.callStatus===this.CallStatus.IDLE){console.warn("no active call");return}this.callStatus=this.CallStatus.RINGING;this.callStatusExternal=CallStatus.CONNECTING};this.acceptedCallSessionEvent=function(D){var F;console.debug("Call.acceptedCallSessionEvent() event: "+D.name+", status: "+this.callStatus);if(this.callStatus===this.CallStatus.IDLE){console.warn("no active call");return}if(!this.pc){console.warn("Call.receivedInviteResponse() no peer connection found.");this.callStatus=this.CallStatus.IDLE;this.callStatusExternal=CallStatus.DISCONNECTED;this.bye();return}if((this.callDirection===this.CallDirection.OUTGOING)&&((this.callStatus===this.CallStatus.CALLING)||(this.callStatus===this.CallStatus.RINGING))){if(this.holdPending){this.callStatus=this.CallStatus.HOLD;this.callStatusExternal=CallStatus.HOLD}else{this.callStatus=this.CallStatus.ACCEPTED}var C=D.sdp;if(this.pc.remoteStreams!==undefined){remoteStream=this.pc.remoteStreams[0];if(remoteStream!==undefined){console.debug("Call.receivedInviteResponse() remove remote stream (label=)"+remoteStream.label+")")}}C=this.updateSDPForDTLS(C,"incoming");C=this.updateSDPForTempWorkarounds(C,"answer");C=this.updateMSID(C);console.trace("receivedInviteResponse() setRemoteDescription sdp = "+C);this.pc.setRemoteDescription(new RTCSessionDescription({type:"answer",sdp:C}),this.setRDsuccess,this.setRDfailure2);this.setMediaTypeFromSdp(C);if(this.holdPending){F={name:CallStatus.HOLD};this.callStatus=this.CallStatus.HOLD;this.callStatusExternal=CallStatus.HOLD;this.holdPending=false;this.callback.onStatus(CallStatus.HOLD,F)}else{if(this.resumePending){this.resumePending=false}this.activeCall=true;this.callStatus=this.CallStatus.CONFIRMED;if(this.callStatusExternal===CallStatus.HOLD||this.callStatusExternal===CallStatus.REMOTE_HOLD){this.callStatusExternal=CallStatus.CONNECTED;F={name:CallStatus.UNHOLD};this.callback.onStatus(CallStatus.UNHOLD,F)}else{this.callStatusExternal=CallStatus.CONNECTED;F={name:CallStatus.CONNECTED};this.callback.onConnected(F)}}if(this.session.ws_only){this.session.needAuthOnReRegister=true;this.session.ws_only=false;var E=this;setTimeout(function(){E.session.adapter.createSession()},1000)}}else{if((this.callDirection===this.CallDirection.OUTGOING)&&(this.callStatus===this.CallStatus.CANCELING)){this.callStatus=this.CallStatus.CANCELED}else{console.warn("Unknown state. Stopped! status: "+this.callStatus+" direction: "+this.callDirection)}}};this.rejectedCallSessionEvent=function(C){console.debug("Call.rejectedCallSessionEvent() event: "+C.name+", status: "+this.callStatus);if(this.callStatus===this.CallStatus.IDLE){console.warn("no active call");return}if(this.callStatus===this.CallStatus.CANCELED){this.callStatusExternal=CallStatus.CANCELED;this.callback.onDisconnected({name:CallStatus.CANCELED})}else{this.callStatusExternal=CallStatus.REJECTED;this.callback.onDisconnected({name:CallStatus.REJECTED})}if(this.session.ws_only){this.session.ws_only=false;this.session.adapter.createSession()}this.clean()};this.errorCallback=function(C){console.trace(C);this.callback.onError(C)};this.createPeerConnection=function(){var E=null;if(webkitRTCPeerConnection===undefined){console.error("webkitRTCPeerConnection is undefined!");return}try{if(z.config.providerConfig){var D=z.config.providerConfig.stun.replace(/^\s+|\s+$/g,"");if(D!==""){this.iceServers={iceServers:[{url:"stun:"+D}]}}if(z.config.providerConfig.crypto.toLowerCase()==="dtls-srtp"){console.debug("Using DTLS-SRTP...");E={optional:[{DtlsSrtpKeyAgreement:true}]}}else{E={optional:[{DtlsSrtpKeyAgreement:false}]}}}this.pc=new webkitRTCPeerConnection(this.iceServers,E);this.pc.onaddstream=this.onRTCPeerConnectionOnAddStream;this.pc.onconnecting=this.onRTCPeerConnectionOnConnecting;this.pc.onicecandidate=this.onRTCPeerConnectionOnIceCandidate;this.pc.onnegotiationneeded=this.onRTCPeerConnectionOnNegotiationNeeded;this.pc.onopen=this.onRTCPeerConnectionOnOpen;this.pc.onremovestream=this.onRTCPeerConnectionOnRemoveStream;this.pc.onstatechange=this.onRTCPeerConnectionOnStatusChange;console.debug("createPeerConnection() create a RTCPeerConnection instance "+this.pc)}catch(C){console.error("Call() Can not create a RTCPeerConnection instance, exception = "+C)}};this.createDataChannel=function(){var E={};if(webkitRTCPeerConnection===undefined){console.error("webkitRTCPeerConnection is undefined!");return}try{if(z.config.providerConfig){var D=z.config.providerConfig.stun.replace(/^\s+|\s+$/g,"");if(D!==""){this.iceServers={iceServers:[{url:"stun:"+D}]}}if(z.config.providerConfig.crypto.toLowerCase()==="dtls-srtp"){console.debug("Using DTLS-SRTP...");E={optional:[{DtlsSrtpKeyAgreement:true}]}}else{E={optional:[{DtlsSrtpKeyAgreement:false}]}}}this.pc=new webkitRTCPeerConnection(this.iceServers,E);console.debug("createDataChannel: "+this.callDirection);if(false&&this.callDirection&&this.callDirection===this.CallDirection.INCOMING){console.debug("createDataChannel ondatachannel: "+this.callDirection);this.pc.ondatachannel=this.gotReceiveChannel}else{console.debug("pc.createDataChannel: "+this.callDirection);this.dataChannel=this.pc.createDataChannel("orcaDataChannel",{reliable:false,negotiated:true});this.dataChannel.onopen=this.onDataChannelOnOpen;this.dataChannel.onclose=this.onDataChannelOnClose;this.dataChannel.onmessage=this.onDataChannelOnMessage}this.pc.onconnecting=this.onRTCPeerConnectionOnConnecting;this.pc.onicecandidate=this.onRTCPeerConnectionOnIceCandidate;this.pc.onnegotiationneeded=this.onRTCPeerConnectionOnNegotiationNeeded;this.pc.onopen=this.onRTCPeerConnectionOnOpen;this.pc.onstatechange=this.onRTCPeerConnectionOnStatusChange;console.debug("createDataChannel() create a RTCPeerConnection data channel "+this.pc+" - "+this.dataChannel)}catch(C){console.error("Call() Can not create a RTCPeerConnection instance or data channel, exception = "+C)}};this.gotReceiveChannel=function(C){console.debug("Receive Channel Callback");this.dataChannel=C.channel;this.dataChannel.onmessage=this.onDataChannelOnMessage;this.dataChannel.onopen=this.onDataChannelOnOpen;this.dataChannel.onclose=this.onDataChannelOnClose};this.sendMessage=function(C){if(!this.dataChannel){console.warn("data channel not exist!");return}this.dataChannel.send(C);console.debug("sendMessage(): "+C)}}function t(A,x,y,z){this.to=A;this.file=x;this.session=y;this.callback=z;this.type="Unknown";this.status=CommStatus.DISCONNECTED;this.wasConnected=false;this.msrp=null;if(this.session&&this.session.adapter.Msrp){this.msrp=new this.session.adapter.Msrp(this)}this.wrappedCall=null;this.setWrappedCall=function(B){this.wrappedCall=B;if(this.file){this.wrappedCall.getCallImp().msrpFile=this.file}if(this.msrp&&typeof this.msrp.setWrappedCall==="function"){this.msrp.setWrappedCall(B)}};this.remoteIdentities=function(){return[{id:this.to}]};this.getStatus=function(){if(this.wrappedCall){var B=this.wrappedCall.getStatus();switch(B){case CallStatus.DISCONNECTED:return CommStatus.DISCONNECTED;case CallStatus.CONNECTING:return CommStatus.CONNECTING;case CallStatus.CONNECTED:return CommStatus.CONNECTED}}return this.status};this.connect=function(){if(this.session.adapter.Msrp){if(!this.wasConnected&&this.msrp){this.wasConnected=true;this.msrp.connect()}}else{this.callback.onError(CommError.NOT_SUPPORTED,{name:CommError.NOT_SUPPORTED});this.callback.onDisconnected({name:CommStatus.DISCONNECTED})}};this.disconnect=function(){if(this.msrp&&typeof this.msrp.disconnect==="function"){this.msrp.disconnect()}else{if(this.wrappedCall){this.wrappedCall.disconnect()}}};this.reject=function(){if(this.msrp&&typeof this.msrp.reject==="function"){this.msrp.reject()}else{if(this.wrappedCall){this.wrappedCall.disconnect()}}}}function v(z,y,x){this.to=z;this.session=y;this.message=x;this.callId=null;this.targetAOR=(typeof z=="string"?[z]:z);this.sendMessage=function(){console.log("sending message: "+this.message+", targetAOR: "+this.targetAOR);this.session.adapter.sendPageModeChatMessage(this,this.targetAOR,this.message)}}function c(B,A,y,z,x){this.to=B;this.session=A;this.message=x;this.callId=null;this.targetAOR=(typeof B=="string"?[B]:B);this.imdnMessageID=y;this.dateTime=z;this.sendMessage=function(){console.log("sending message: "+this.message+", targetAOR: "+this.targetAOR);this.session.adapter.sendSmsMessage(this,this.targetAOR,this.imdnMessageID,this.dateTime,this.message)}}function p(B,A,y,x,z){this.to=B;this.session=A;this.imdnMessageID=y;this.callId=null;this.targetAOR=(typeof B=="string"?[B]:B);if(z!==undefined&&z!==""){this.dateTime=z}else{this.dateTime=u(new Date())}this.status=x;this.sendMessage=function(){console.log("sending message: imdnMessageID:"+this.imdnMessageID+", status: "+this.status+", targetAOR: "+this.targetAOR);this.session.adapter.sendSmsIMDNMessage(this,this.targetAOR,this.imdnMessageID,this.status,this.dateTime)}}function u(y){function x(z){return z<10?"0"+z:z}return y.getUTCFullYear()+"-"+x(y.getUTCMonth()+1)+"-"+x(y.getUTCDate())+"T"+x(y.getUTCHours())+":"+x(y.getUTCMinutes())+":"+x(y.getUTCSeconds())}function o(C){var z=["0","1","2","3","4","5","6","7","8","9","A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z"];var x="";var A=new Date().getTime();for(var y=0;y<C;y++){var B=Math.ceil(Math.random()*35);x+=z[B]}return A+x}function f(z,x,y){t.call(this,z,undefined,x,y);this.type="Chat";this.sendMessage=function(A){if(this.msrp){this.msrp.sendMessage(A)}}}f.prototype=new t();function s(A,x,y,z){t.call(this,A,x,y,z);this.type="FileTransfer"}s.prototype=new t();function e(A,x,y,z){t.call(this,A,x,y,z);this.type="ImageShare"}e.prototype=new t();function w(y){if(y.substr(0,5)!=="<?xml"){return false}var C,B;if(B=document.implementation.createDocument){var E=new DOMParser();B=E.parseFromString(y,"application/xml");var x=B.firstChild;if(x==B.lastChild&&x.nodeName==="isComposing"){var A,D,z;A=x.getElementsByTagName("state");D=x.getElementsByTagName("contenttype");z=x.getElementsByTagName("refresh");if(A&&D&&z){return true}}}else{console.log("Cannot parse xml.");return false}return false}function r(z,y,x,A){this.callback=A;this.userId=z;this.token=y;this.abConfig=x;this.AddressBookAPI={};this.AddressBookAPI.GETLISTIDS="0";this.AddressBookAPI.GETLISTS="1";this.AddressBookAPI.GETMEMBERS="2";this.AddressBookAPI.GETCONTACTS="3";this.AddressBookAPI.ADDMEMBER="4";this.AddressBookAPI.ADDCONTACT="5";this.AddressBookAPI.UPDATEMEMBER="6";this.AddressBookAPI.UPDATECONTACT="7";this.AddressBookAPI.DELETELIST="8";this.AddressBookAPI.DELETEMEMBER="9";this.AddressBookAPI.DELETECONTACT="10";this.AddressBookAPI.TRANSFERMEMBER="11";this.checkConfig=function(){if(!x.contactServerURI){console.warn("contactServerURI is null");return false}if(!x.baseResourcePath){console.warn("baseResourcePath is null");return false}return true};this.request=function(C,B,I,E,F,D,G){var J=this;try{J.xmlHttpReq=false;if(window.XMLHttpRequest){J.xmlHttpReq=new XMLHttpRequest()}else{if(window.ActiveXObject){J.xmlHttpReq=new ActiveXObject("Microsoft.XMLHTTP")}else{try{xmlhttp=new ActiveXObject("Msxml2.XMLHTTP")}catch(H){console.warn("catch the exception: "+H.toString())}}}if(!J.xmlHttpReq){console.warn("Ajax not supported!");return}console.debug("the method is: "+B+",url is: "+C);J.xmlHttpReq.open(B,C,true);J.xmlHttpReq.onreadystatechange=function(){if(!J){return}if(!J.xmlHttpReq){return}if(!J.xmlHttpReq.readyState){return}if(J.xmlHttpReq.readyState==4){var K=J.xmlHttpReq.status;console.debug("xmlHttpReq.status is: "+K);if(K==1223){K=204}J.onResponse(K,G,D)}};if(D){J.xmlHttpReq.setRequestHeader("Accept",D)}if(I){J.xmlHttpReq.setRequestHeader("Content-Type",F);J.xmlHttpReq.send(E)}else{J.xmlHttpReq.send(null)}}catch(H){console.warn("catch the exception: "+H.toString())}};this.onResponse=function(C,F,E){console.debug("status is: "+C+", api is: "+F+", accept is: "+E);var D="Response "+C;D+="\n"+this.xmlHttpReq.getAllResponseHeaders();D+="\n"+this.xmlHttpReq.responseText;console.debug("the response is: "+D);var H=this.xmlHttpReq.responseText;var G;if(F===this.AddressBookAPI.GETLISTIDS){if(C>=200&&C<=300){var B;if(E==="application/xml"){console.debug("parse the response for xml format");B=this.parseGetListsForXml(H,true)}else{if(E==="application/json"){console.debug("parse the response for json format")}else{console.warn("accept error")}}G={name:AddressBookStatus.GETLISTS_SUCCESSFUL};this.callback.onGetLists(B,G)}else{G={name:AddressBookStatus.GETLISTS_FAILED};this.callback.onError(AddressBookError.NETWORK_ERROR,G)}}else{if(F===this.AddressBookAPI.GETLISTS){if(C>=200&&C<=300){var B;if(E==="application/xml"){console.debug("parse the response for xml format");B=this.parseGetListsForXml(H,false)}else{if(E==="application/json"){console.debug("parse the response for json format")}else{console.warn("accept error")}}G={name:AddressBookStatus.GETLISTS_SUCCESSFUL};this.callback.onGetLists(B,G)}else{G={name:AddressBookStatus.GETLISTS_FAILED};this.callback.onError(AddressBookError.NETWORK_ERROR,G)}}else{if(F===this.AddressBookAPI.GETMEMBERS){if(C>=200&&C<=300){var I;if(E==="application/xml"){console.debug("parse the response for xml format");I=this.parseGetMembersForXml(H)}else{if(E==="application/json"){console.debug("parse the response for json format")}else{console.warn("accept error")}}G={name:AddressBookStatus.GETMEMBERS_SUCCESSFUL};this.callback.onGetMembers(I,G)}else{G={name:AddressBookStatus.GETMEMBERS_FAILED};this.callback.onError(AddressBookError.NETWORK_ERROR,G)}}else{if(F===this.AddressBookAPI.GETCONTACTS){}else{if(F===this.AddressBookAPI.ADDMEMBER){if(C>=200&&C<=300){G={name:AddressBookStatus.ADDMEMBER_SUCCESSFUL};this.callback.onAddMember(G)}else{G={name:AddressBookStatus.ADDMEMBER_FAILED};this.callback.onError(AddressBookError.NETWORK_ERROR,G)}}else{if(F===this.AddressBookAPI.ADDCONTACT){}else{if(F===this.AddressBookAPI.UPDATEMEMBER){if(C>=200&&C<=300){G={name:AddressBookStatus.UPDATEMEMBER_SUCCESSFUL};this.callback.onUpdateMember(G)}else{G={name:AddressBookStatus.UPDATEMEMBER_FAILED};this.callback.onError(AddressBookError.NETWORK_ERROR,G)}}else{if(F===this.AddressBookAPI.UPDATECONTACT){}else{if(F===this.AddressBookAPI.DELETELIST){if(C>=200&&C<=300){G={name:AddressBookStatus.DELETELIST_SUCCESSFUL};this.callback.onDeleteList(G)}else{G={name:AddressBookStatus.DELETELIST_FAILED};this.callback.onError(AddressBookError.NETWORK_ERROR,G)}}else{if(F===this.AddressBookAPI.DELETEMEMBER){if(C>=200&&C<=300){G={name:AddressBookStatus.DELETEMEMBER_SUCCESSFUL};this.callback.onDeleteMember(G)}else{G={name:AddressBookStatus.DELETEMEMBER_FAILED};this.callback.onError(AddressBookError.NETWORK_ERROR,G)}}else{if(F===this.AddressBookAPI.DELETECONTACT){}else{if(F===this.AddressBookAPI.TRANSFERMEMBER){if(C>=200&&C<=300){G={name:AddressBookStatus.TRANSFERMEMBER_SUCCESSFUL};this.callback.onTransferMember(G)}else{G={name:AddressBookStatus.TRANSFERMEMBER_FAILED};this.callback.onError(AddressBookError.NETWORK_ERROR,G)}}else{console.debug("the api type error")}}}}}}}}}}}}};this.parseGetListsForXml=function(F,P){if(!F){return}console.debug("messageString is: "+F);if(F.substr(0,5)!=="<?xml"){return}var N,I;var C=new DOMParser();I=C.parseFromString(F,"application/xml");var S=new Array();if(P){console.debug("only return the list Ids");var O=I.getElementsByTagNameNS(a.ab,"listId");for(i=0;i<O.length;i++){var Q=new Object();Q.id=O[i].textContent;S[i]=Q;console.debug("lists["+i+"].id is:"+S[i].id)}}else{console.debug("return list Ids and list members");var M=I.getElementsByTagNameNS(a.ab,"list");for(g=0;g<M.length;g++){var G=M[g].childNodes;var Q=new Object();for(h=0;h<G.length;h++){if(G[h].nodeName==="ab:listId"){Q.id=G[h].textContent;console.debug("list.id is:"+Q.id)}if(G[h].nodeName==="ab:memberCollection"){var R=new Array();var K=G[h].getElementsByTagNameNS(a.ab,"member");for(i=0;i<K.length;i++){var J=K[i].childNodes;var B=new Object();for(j=0;j<J.length;j++){if(J[j].nodeName==="ab:memberId"){B.id=J[j].textContent;console.debug("member.id is:"+B.id)}if(J[j].nodeName==="ab:attributeList"){var H=new Array();var E=J[j].getElementsByTagNameNS(a.ab,"attribute");for(k=0;k<E.length;k++){var L=new Object();var D=E[k].childNodes;for(l=0;l<D.length;l++){if(D[l].nodeName==="name"){L.name=D[l].textContent;console.debug("attribute.name is:"+L.name)}if(D[l].nodeName==="value"){L.value=D[l].textContent;console.debug("attribute.name is:"+L.value)}}if(L.name=="display-name"){B.displayName=L.value}H[k]=L}B.attributes=H}}R[i]=B}Q.members=R}}S[g]=Q}}return S};this.parseGetMembersForXml=function(N){if(!N){return}console.debug("messageString is: "+N);if(N.substr(0,5)!=="<?xml"){return}var G,O;var C=new DOMParser();O=C.parseFromString(N,"application/xml");var B=O.getElementsByTagNameNS(a.ab,"listId");var K=new Object();K.id=B[0].textContent;console.debug("list.id is:"+K.id);var I=new Array();var M=O.getElementsByTagNameNS(a.ab,"member");for(i=0;i<M.length;i++){var L=M[i].childNodes;var J=new Object();for(j=0;j<L.length;j++){if(L[j].nodeName==="ab:memberId"){J.id=L[j].textContent;console.debug("member.id is:"+J.id)}if(L[j].nodeName==="ab:attributeList"){var H=new Array();var E=L[j].getElementsByTagNameNS(a.ab,"attribute");for(k=0;k<E.length;k++){var D=new Object();var F=E[k].childNodes;for(l=0;l<F.length;l++){if(F[l].nodeName==="name"){D.name=F[l].textContent;console.debug("attribute.name is:"+D.name)}if(F[l].nodeName==="value"){D.value=F[l].textContent;console.debug("attribute.name is:"+D.value)}}if(D.name=="display-name"){J.displayName=D.value}H[k]=D}J.attributes=H}}I[i]=J}K.members=I;return K};this.getLists=function(D){if(this.checkConfig()===false){var C={name:AddressBookStatus.GETLISTS_FAILED};this.callback.onError(AddressBookError.CONFIG_ERROR,C);return}var E=encodeURIComponent(z);var B=x.contactServerURI+"/"+x.baseResourcePath+"/addressbook/v1/"+E+"/lists";console.debug("requestURL is: "+B);console.debug("getMembersInList is: "+D);if(D){this.request(B,"GET",false,null,"application/xml","application/xml",this.AddressBookAPI.GETLISTS)}else{this.request(B,"GET",false,null,"application/xml","application/xml",this.AddressBookAPI.GETLISTIDS)}};this.getMembers=function(B){if(this.checkConfig()===false){var E={name:AddressBookStatus.GETMEMBERS_FAILED};this.callback.onError(AddressBookError.CONFIG_ERROR,E);return}if(!B){var E={name:AddressBookStatus.GETMEMBERS_FAILED};this.callback.onError(AddressBookError.PARAMETERS_ERROR,E);return}var F=encodeURIComponent(z);var C=encodeURIComponent(B);var D=x.contactServerURI+"/"+x.baseResourcePath+"/addressbook/v1/"+F+"/lists/"+C;console.debug("requestURL is: "+D);this.request(D,"GET",false,null,"application/xml","application/xml",this.AddressBookAPI.GETMEMBERS)};this.getContacts=function(){};this.addMember=function(H,F){if(this.checkConfig()===false){var C={name:AddressBookStatus.ADDMEMBER_FAILED};this.callback.onError(AddressBookError.CONFIG_ERROR,C);return}if(!H){var C={name:AddressBookStatus.ADDMEMBER_FAILED};this.callback.onError(AddressBookError.PARAMETERS_ERROR,C);return}var L=encodeURIComponent(z);var J=encodeURIComponent(H);var G,D;if(!F){console.debug("member is null, to create list");D=x.contactServerURI+"/"+x.baseResourcePath+"/addressbook/v1/"+L+"/lists/"+J;G='<?xml version="1.0" encoding="UTF-8"?><ab:list xmlns:ab="urn:oma:xml:rest:netapi:addressbook:1"><listId>'+H+"</listId></ab:list>"}else{console.debug("member is not null, to add member in the list");if(!F||!F.id){var C={name:AddressBookStatus.ADDMEMBER_FAILED};this.callback.onError(AddressBookError.PARAMETERS_ERROR,C)}var B=encodeURIComponent(F.id);D=x.contactServerURI+"/"+x.baseResourcePath+"/addressbook/v1/"+L+"/lists/"+J+"/members/"+B;var E=F.attributes;if(!E){console.debug("no attributes");G='<?xml version="1.0" encoding="UTF-8"?><ab:member xmlns:ab="urn:oma:xml:rest:netapi:addressbook:1"><memberId>'+F.id+"</memberId></ab:member>"}else{var K="";for(i=0;i<E.length;i++){K+="<attribute><name>"+E[i].name+"</name><value>"+E[i].value+"</value></attribute>"}var I="<attributeList>"+K.trim()+"<resourceURL>"+D+"/attributes</resourceURL></attributeList>";G='<?xml version="1.0" encoding="UTF-8"?><ab:member xmlns:ab="urn:oma:xml:rest:netapi:addressbook:1"><memberId>'+F.id+"</memberId>"+I+"</ab:member>"}}console.debug("requestURL is: "+D);console.debug("data is: "+G);this.request(D,"PUT",true,G,"application/xml","application/xml",this.AddressBookAPI.ADDMEMBER)};this.addContact=function(B){};this.updateMember=function(H,G){if(this.checkConfig()===false){var C={name:AddressBookStatus.UPDATEMEMBER_FAILED};this.callback.onError(AddressBookError.CONFIG_ERROR,C);return}if(!H||!G||!G.id||!G.attributes){var C={name:AddressBookStatus.UPDATEMEMBER_FAILED};this.callback.onError(AddressBookError.PARAMETERS_ERROR,C);return}var L=encodeURIComponent(z);var J=encodeURIComponent(H);var B=encodeURIComponent(G.id);var D=x.contactServerURI+"/"+x.baseResourcePath+"/addressbook/v1/"+L+"/lists/"+J+"/members/"+B;console.debug("requestURL is: "+D);var E=G.attributes;var K="";for(i=0;i<E.length;i++){K+="<attribute><name>"+E[i].name+"</name><value>"+E[i].value+"</value></attribute>"}var I="<attributeList>"+K.trim()+"<resourceURL>"+D+"/attributes</resourceURL></attributeList>";var F='<?xml version="1.0" encoding="UTF-8"?><ab:member xmlns:ab="urn:oma:xml:rest:netapi:addressbook:1"><memberId>'+G.id+"</memberId>"+I+"</ab:member>";console.debug("data is: "+F);this.request(D,"PUT",true,F,"application/xml","application/xml",this.AddressBookAPI.UPDATEMEMBER)};this.updateContact=function(B){};this.deleteList=function(B){if(this.checkConfig()===false){var E={name:AddressBookStatus.DELETELIST_FAILED};this.callback.onError(AddressBookError.CONFIG_ERROR,E);return}if(!B){var E={name:AddressBookStatus.DELETELIST_FAILED};this.callback.onError(AddressBookError.PARAMETERS_ERROR,E);return}var F=encodeURIComponent(z);var C=encodeURIComponent(B);var D=x.contactServerURI+"/"+x.baseResourcePath+"/addressbook/v1/"+F+"/lists/"+C;console.debug("requestURL is: "+D);this.request(D,"DELETE",false,null,"application/xml","application/xml",this.AddressBookAPI.DELETELIST)};this.deleteMember=function(B,H){if(this.checkConfig()===false){var E={name:AddressBookStatus.DELETEMEMBER_FAILED};this.callback.onError(AddressBookError.CONFIG_ERROR,E);return}if(!B){var E={name:AddressBookStatus.DELETEMEMBER_FAILED};this.callback.onError(AddressBookError.PARAMETERS_ERROR,E);return}if(!H||!H.id){var E={name:AddressBookStatus.DELETEMEMBER_FAILED};this.callback.onError(AddressBookError.PARAMETERS_ERROR,E);return}var F=encodeURIComponent(z);var C=encodeURIComponent(B);var G=encodeURIComponent(H.id);var D=x.contactServerURI+"/"+x.baseResourcePath+"/addressbook/v1/"+F+"/lists/"+C+"/members/"+G;console.debug("requestURL is: "+D);this.request(D,"DELETE",false,null,"application/xml","application/xml",this.AddressBookAPI.DELETEMEMBER)};this.deleteContact=function(B){};this.trnsferMember=function(H,G,I){if(this.checkConfig()===false){var C={name:AddressBookStatus.TRANSFERMEMBER_FAILED};this.callback.onError(AddressBookError.CONFIG_ERROR,C);return}if(!H||!G||!G.id||!I){var C={name:AddressBookStatus.TRANSFERMEMBER_FAILED};this.callback.onError(AddressBookError.PARAMETERS_ERROR,C);return}var K=encodeURIComponent(z);var J=encodeURIComponent(H);var B=encodeURIComponent(G.id);var E=x.contactServerURI+"/"+x.baseResourcePath+"/addressbook/v1/"+K+"/lists/"+J+"/members/"+B+"/transfer";console.debug("requestURL is: "+E);var D=x.contactServerURI+"/"+x.baseResourcePath+"/addressbook/v1/"+z+"/lists/"+I;console.debug("destinationStr is: "+D);var F='<?xml version="1.0" encoding="UTF-8"?><ab:memberTransferParameters xmlns:ab="urn:oma:xml:rest:netapi:addressbook:1"><destination>'+D+"</destination></ab:memberTransferParameters>";console.debug("data is: "+F);this.request(E,"POST",true,F,"application/xml","application/xml",this.AddressBookAPI.TRANSFERMEMBER)}}var b={createSession:function(z,C,D,E){var A={uri:D.uri,mediatypes:D.mediatypes||"audio",providerConfig:{}};var x=["interfaceType","sendAuthOnInitReg","sendAuthOnReregDereg","reUseCallidInReregDereg","stun","bundle","crypto","conferenceFactoryURI","expires","addCodecs","dtmf","dtmfDuration","dtmfGap","audioBandwidth","videoBandwidth","dataBandwidth","audioCodecs","videoCodecs","persistentPC","breaker","stripExtraSSRC","confWorkaroundChrome","useFirstCandidate","removeIPV6Candidates","enableIMDNCapability","autoAnswerTime","maxRecoveryAttempts","networkRetryInterval","sendRegisterOnRecovery","registerResponseTime","registerRefreshTime","msidHandling","crlfKeepAliveInterval","enableMDSPsupport","secondaryDeviceId","dtmfWorkaround"];var y=["SIP-WS",false,true,true,"",false,"dtls-srtp","","600",true,"inband","100","70","","","","","",true,false,true,false,false,true,true,0,5,5,false,0,0,"1",0,false,'mobility="fixed"',true];for(var B=0;B<x.length;B++){if(D.providerConfig&&D.providerConfig[x[B]]!==undefined){A.providerConfig[x[B]]=D.providerConfig[x[B]]}else{A.providerConfig[x[B]]=y[B]}}return new n(z,C,A,E)},createAddressBook:function(y,z,x,A){return new r(y,z,x,A)}};this.orcaALU=b})();

// orca/sip.js
if(typeof sip=="undefined"){sip={}}(function(a){a.filter=function(c,f){var b=[];for(var e=0;e<f.length;++e){if(c(f[e])){b.push(f[e])}}return b};a.map=function(c,f){var b=[];for(var e=0;e<f.length;++e){b.push(c(f[e]))}return b};a.str_partition=function(e,c){var b=e.indexOf(c);return b>=0?[e.substr(0,b),c,e.substr(b+c.length)]:[e,"",""]};a.str_strip=function(b){return b.replace(/^\s+/g,"").replace(/\s+$/g,"")};a.str_slice=function(g,f,c){if(typeof f=="undefined"||f<0){f=0}if(typeof c=="undefined"||c>g.length){c=g.length}var b=[];for(var e=f;e<c;++e){b.push(g.charAt(e))}return b.join("")};a.list_slice=function(f,g,c){if(typeof g=="undefined"||g<0){g=0}if(typeof c=="undefined"||c>f.length){c=f.length}var b=[];for(var e=g;e<c;++e){b.push(f[e])}return b};a.dict_items=function(e){var b=[];for(var c in e){b.push([c,e[c]])}return b};a.is_array=function(b){return Object.prototype.toString.apply(b)==="[object Array]"};a.parse_uri_options={strictMode:false,key:["source","protocol","authority","userInfo","user","password","host","port","relative","path","directory","file","query","anchor"],q:{name:"queryKey",parser:/(?:^|&)([^&=]*)=?([^&]*)/g},parser:{strict:/^(?:([^:\/?#]+):)?(?:\/\/((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?))?((((?:[^?#\/]*\/)*)([^?#]*))(?:\?([^#]*))?(?:#(.*))?)/,loose:/^(?:(?![^:@]+:[^:@\/]*@)([^:\/?#.]+):)?(?:\/\/)?((?:(([^:@]*)(?::([^:@]*))?)?@)?([^:\/?#]*)(?::(\d*))?)(((\/(?:[^?#](?![^?#\/]*\.[^?#\/.]+(?:[?#]|$)))*\/?)?([^?#\/]*))(?:\?([^#]*))?(?:#(.*))?)/}};a.parse_uri=function(g){var f=a.parse_uri_options,b=f.parser[f.strictMode?"strict":"loose"].exec(g),e={},c=14;while(c--){e[f.key[c]]=b[c]||""}e[f.q.name]={};e[f.key[12]].replace(f.q.parser,function(i,h,j){if(h){e[f.q.name][h]=j}});return e};a._keyStr="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";a.b64_encode=function(e){var b="";var m,k,h,l,j,g,f;var c=0;e=a._utf8_encode(e);while(c<e.length){m=e.charCodeAt(c++);k=e.charCodeAt(c++);h=e.charCodeAt(c++);l=m>>2;j=((m&3)<<4)|(k>>4);g=((k&15)<<2)|(h>>6);f=h&63;if(isNaN(k)){g=f=64}else{if(isNaN(h)){f=64}}b=b+a._keyStr.charAt(l)+a._keyStr.charAt(j)+a._keyStr.charAt(g)+a._keyStr.charAt(f)}return b};a.b64_decode=function(e){var b="";var m,k,h;var l,j,g,f;var c=0;e=e.replace(/[^A-Za-z0-9\+\/\=]/g,"");while(c<e.length){l=this._keyStr.indexOf(e.charAt(c++));j=this._keyStr.indexOf(e.charAt(c++));g=this._keyStr.indexOf(e.charAt(c++));f=this._keyStr.indexOf(e.charAt(c++));m=(l<<2)|(j>>4);k=((j&15)<<4)|(g>>2);h=((g&3)<<6)|f;b=b+String.fromCharCode(m);if(g!=64){b=b+String.fromCharCode(k)}if(f!=64){b=b+String.fromCharCode(h)}}b=a._utf8_decode(b);return b};a._utf8_encode=function(e){var b="";for(var g=0;g<e.length;g++){var f=e.charCodeAt(g);if(f<128){b+=String.fromCharCode(f)}else{if((f>127)&&(f<2048)){b+=String.fromCharCode((f>>6)|192);b+=String.fromCharCode((f&63)|128)}else{b+=String.fromCharCode((f>>12)|224);b+=String.fromCharCode(((f>>6)&63)|128);b+=String.fromCharCode((f&63)|128)}}}return b};a._utf8_decode=function(b){var e="";var f=0;var g=c1=c2=0;while(f<b.length){g=b.charCodeAt(f);if(g<128){e+=String.fromCharCode(g);f++}else{if((g>191)&&(g<224)){c2=b.charCodeAt(f+1);e+=String.fromCharCode(((g&31)<<6)|(c2&63));f+=2}else{c2=b.charCodeAt(f+1);c3=b.charCodeAt(f+2);e+=String.fromCharCode(((g&15)<<12)|((c2&63)<<6)|(c3&63));f+=3}}}return e};a.b64_urlsafe_encode=function(b){return a.b64_encode(b).replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,".")};a.MD5=function(s){function L(c,b){return(c<<b)|(c>>>(32-b))}function K(F,c){var H,b,x,G,k;x=(F&2147483648);G=(c&2147483648);H=(F&1073741824);b=(c&1073741824);k=(F&1073741823)+(c&1073741823);if(H&b){return(k^2147483648^x^G)}if(H|b){if(k&1073741824){return(k^3221225472^x^G)}else{return(k^1073741824^x^G)}}else{return(k^x^G)}}function r(b,k,c){return(b&k)|((~b)&c)}function q(b,k,c){return(b&c)|(k&(~c))}function p(b,k,c){return(b^k^c)}function n(b,k,c){return(k^(b|(~c)))}function u(G,F,aa,Z,k,H,I){G=K(G,K(K(r(F,aa,Z),k),I));return K(L(G,H),F)}function f(G,F,aa,Z,k,H,I){G=K(G,K(K(q(F,aa,Z),k),I));return K(L(G,H),F)}function D(G,F,aa,Z,k,H,I){G=K(G,K(K(p(F,aa,Z),k),I));return K(L(G,H),F)}function t(G,F,aa,Z,k,H,I){G=K(G,K(K(n(F,aa,Z),k),I));return K(L(G,H),F)}function e(F){var I;var x=F.length;var k=x+8;var c=(k-(k%64))/64;var H=(c+1)*16;var Z=Array(H-1);var b=0;var G=0;while(G<x){I=(G-(G%4))/4;b=(G%4)*8;Z[I]=(Z[I]|(F.charCodeAt(G)<<b));G++}I=(G-(G%4))/4;b=(G%4)*8;Z[I]=Z[I]|(128<<b);Z[H-2]=x<<3;Z[H-1]=x>>>29;return Z}function B(k){var c="",x="",F,b;for(b=0;b<=3;b++){F=(k>>>(b*8))&255;x="0"+F.toString(16);c=c+x.substr(x.length-2,2)}return c}function J(k){var b="";for(var F=0;F<k.length;F++){var x=k.charCodeAt(F);if(x<128){b+=String.fromCharCode(x)}else{if((x>127)&&(x<2048)){b+=String.fromCharCode((x>>6)|192);b+=String.fromCharCode((x&63)|128)}else{b+=String.fromCharCode((x>>12)|224);b+=String.fromCharCode(((x>>6)&63)|128);b+=String.fromCharCode((x&63)|128)}}}return b}var C=Array();var P,h,E,v,g,Y,X,W,V;var S=7,Q=12,N=17,M=22;var A=5,z=9,y=14,w=20;var o=4,m=11,l=16,j=23;var U=6,T=10,R=15,O=21;s=J(s);C=e(s);Y=1732584193;X=4023233417;W=2562383102;V=271733878;for(P=0;P<C.length;P+=16){h=Y;E=X;v=W;g=V;Y=u(Y,X,W,V,C[P+0],S,3614090360);V=u(V,Y,X,W,C[P+1],Q,3905402710);W=u(W,V,Y,X,C[P+2],N,606105819);X=u(X,W,V,Y,C[P+3],M,3250441966);Y=u(Y,X,W,V,C[P+4],S,4118548399);V=u(V,Y,X,W,C[P+5],Q,1200080426);W=u(W,V,Y,X,C[P+6],N,2821735955);X=u(X,W,V,Y,C[P+7],M,4249261313);Y=u(Y,X,W,V,C[P+8],S,1770035416);V=u(V,Y,X,W,C[P+9],Q,2336552879);W=u(W,V,Y,X,C[P+10],N,4294925233);X=u(X,W,V,Y,C[P+11],M,2304563134);Y=u(Y,X,W,V,C[P+12],S,1804603682);V=u(V,Y,X,W,C[P+13],Q,4254626195);W=u(W,V,Y,X,C[P+14],N,2792965006);X=u(X,W,V,Y,C[P+15],M,1236535329);Y=f(Y,X,W,V,C[P+1],A,4129170786);V=f(V,Y,X,W,C[P+6],z,3225465664);W=f(W,V,Y,X,C[P+11],y,643717713);X=f(X,W,V,Y,C[P+0],w,3921069994);Y=f(Y,X,W,V,C[P+5],A,3593408605);V=f(V,Y,X,W,C[P+10],z,38016083);W=f(W,V,Y,X,C[P+15],y,3634488961);X=f(X,W,V,Y,C[P+4],w,3889429448);Y=f(Y,X,W,V,C[P+9],A,568446438);V=f(V,Y,X,W,C[P+14],z,3275163606);W=f(W,V,Y,X,C[P+3],y,4107603335);X=f(X,W,V,Y,C[P+8],w,1163531501);Y=f(Y,X,W,V,C[P+13],A,2850285829);V=f(V,Y,X,W,C[P+2],z,4243563512);W=f(W,V,Y,X,C[P+7],y,1735328473);X=f(X,W,V,Y,C[P+12],w,2368359562);Y=D(Y,X,W,V,C[P+5],o,4294588738);V=D(V,Y,X,W,C[P+8],m,2272392833);W=D(W,V,Y,X,C[P+11],l,1839030562);X=D(X,W,V,Y,C[P+14],j,4259657740);Y=D(Y,X,W,V,C[P+1],o,2763975236);V=D(V,Y,X,W,C[P+4],m,1272893353);W=D(W,V,Y,X,C[P+7],l,4139469664);X=D(X,W,V,Y,C[P+10],j,3200236656);Y=D(Y,X,W,V,C[P+13],o,681279174);V=D(V,Y,X,W,C[P+0],m,3936430074);W=D(W,V,Y,X,C[P+3],l,3572445317);X=D(X,W,V,Y,C[P+6],j,76029189);Y=D(Y,X,W,V,C[P+9],o,3654602809);V=D(V,Y,X,W,C[P+12],m,3873151461);W=D(W,V,Y,X,C[P+15],l,530742520);X=D(X,W,V,Y,C[P+2],j,3299628645);Y=t(Y,X,W,V,C[P+0],U,4096336452);V=t(V,Y,X,W,C[P+7],T,1126891415);W=t(W,V,Y,X,C[P+14],R,2878612391);X=t(X,W,V,Y,C[P+5],O,4237533241);Y=t(Y,X,W,V,C[P+12],U,1700485571);V=t(V,Y,X,W,C[P+3],T,2399980690);W=t(W,V,Y,X,C[P+10],R,4293915773);X=t(X,W,V,Y,C[P+1],O,2240044497);Y=t(Y,X,W,V,C[P+8],U,1873313359);V=t(V,Y,X,W,C[P+15],T,4264355552);W=t(W,V,Y,X,C[P+6],R,2734768916);X=t(X,W,V,Y,C[P+13],O,1309151649);Y=t(Y,X,W,V,C[P+4],U,4149444226);V=t(V,Y,X,W,C[P+11],T,3174756917);W=t(W,V,Y,X,C[P+2],R,718787259);X=t(X,W,V,Y,C[P+9],O,3951481745);Y=K(Y,h);X=K(X,E);W=K(W,v);V=K(V,g)}var i=B(Y)+B(X)+B(W)+B(V);return i.toLowerCase()}})(sip);(function(a){a._testIP=function(){assert(a.isIPv4("1.2.3.4")==true,'isIPv4("1.2.3.4") == true');assert(a.isIPv4("1.2.3.4.5")==false,'isIPv4("1.2.3.4.5") == false');assert(a.isIPv4("1.2.3")==false,'isIPv4("1.2.3") == false');assert(a.isIPv4("hos.tna.me.is")==false,'isIPv4("hos.tna.me.is") == false');assert(a.isIPv4("1.2.3.256")==false,'isIPv4("1.2.3.256") == false');assert(a.isMulticast("224.1.2.3")==true,'sip.isMulticast("224.1.2.3") == true');assert(a.isMulticast("125.1.2.3")==false,'sip.isMulticast("125.1.2.3") == true');assert(a.isLocal("127.0.0.1")==true,'sip.isLocal("127.0.0.1") == true');assert(a.isLocal("127.0.1.1")==false,'sip.isMulticast("127.0.1.1") == false');assert(a.isPrivate("127.0.0.1")==false,'sip.isPrivate("127.0.0.1") == false');assert(a.isPrivate("10.1.2.3")==true,'sip.isPrivate("10.1.2.3") == true');assert(a.isPrivate("192.168.1.2")==true,'sip.isPrivate("192.168.1.2") == true');assert(a.isPrivate("172.19.1.2")==true,'sip.isPrivate("172.19.1.2") == true')};a._ipv4=/^(\d{1,3})\.(\d{1,3})\.(\d{1,3})\.(\d{1,3})$/;a._ipToParts=function(e){var f=(typeof e==="string")?e.match(this._ipv4):null;if(f==null){return false}f=a.filter(function(g){return g<256},a.map(parseInt,a.list_slice(f,1)));return f.length==4?f:false};a.isIPv4=function(e){return a._ipToParts(e)!=false};a.isMulticast=function(e){var f=a._ipToParts(e);return(f&&((f[0]&240)==224))};a.isLocal=function(e){return e=="127.0.0.1"};a.isPrivate=function(e){var f=a._ipToParts(e);return f&&(f[0]==10||f[0]==172&&f[1]>=16&&f[1]<32||f[0]==192&&f[1]==168)};a._testURI=function(){assert((new a.URI("sip:kundan@example.net")).toString()=="sip:kundan@example.net",'URI("sip:kundan@example.net")');assert((new a.URI("sip:kundan:passwd@example.net:5060;transport=udp;lr?name=value&another=another")).toString()=="sip:kundan:passwd@example.net:5060;transport=udp;lr?name=value&another=another",'URI("sip:kundan:passwd@example.net:5060;transport=udp;lr?name=value&another=another")');assert((new a.URI("sip:192.1.2.3:5060")).toString()=="sip:192.1.2.3:5060",'URI("sip:192.1.2.3:5060")');assert((new a.URI("sip:kundan@example.net")).equals(new a.URI("sip:Kundan@Example.NET")),'URI("sip:kundan@example.net").equals(URI("sip:Kundan@Example.NET"))');assert((new a.URI()).toString()=="","URI() empty");assert((new a.URI("tel:+1-212-9397063")).toString()=="tel:+1-212-9397063",'URI("tel:+1-212-9397063")');var e=(new a.URI("sip:kundan@192.1.2.3:5060")).getHostPort();assert(e[0]=="192.1.2.3"&&e[1]==5060,'URI("sip:kundan@192.1.2.3:5060").getHostPort()')};function b(h){if(h!==undefined){var e=h.match(b._syntax);var l,k;if(e){this.scheme=e[1];this.user=e[4];this.password=e[6];this.host=e[9];this.port=e[11];l=e[13];k=e[15]}else{if(h.match(b._syntax_urn)){e=h.match(b._syntax_urn);this.scheme=e[1];this.host=e[2]}else{throw new String("Invalid URI("+h+")")}}if(this.scheme=="tel"&&this.user==null){this.user=this.host;this.host=null}if(this.port){this.port=parseInt(this.port)}this.param={};if(l){var j=l.split(";");for(var g=0;g<j.length;++g){var f=a.str_partition(j[g],"=");this.param[f[0]]=f[2]||null}}this.header=k?k.split("&"):[]}else{this.scheme=null;this.user=null;this.password=null;this.host=null;this.port=null;this.param={};this.header=[]}}b._syntax=/^([a-zA-Z][a-zA-Z0-9\+\-\.]*):((([a-zA-Z0-9\-\_\.\!\~\*\'\(\)&=\+\$,;\?\/\%]+)(:([^:@;\?]+))?)@)?((([^;\?:]*)(:([\d]+))?))(;([^\?]*))?(\?(.*))?$/;b._syntax_urn=/^(urn):([^;\?>]+)$/;b.prototype.toString=function(){var e=this.scheme=="tel"?null:this.user;var f=this.scheme=="tel"?this.user:this.host;var g=a.map(function(h){return h[1]!==null?h[0]+"="+h[1]:h[0]},a.dict_items(this.param)).join(";");return this.scheme&&f?(this.scheme+":"+(e?(e+(this.password?(":"+this.password):"")+"@"):"")+(f?((f?f:"")+(this.port?(":"+this.port):"")):"")+(g?(";"+g):"")+(this.header.length>0?("?"+this.header.join("&")):"")):""};b.prototype.dup=function(){return new b(this.toString())};b.prototype.getHostPort=function(){return[this.host,this.port]};b.prototype.equals=function(e){return this.toString().toLowerCase()==e.toString().toLowerCase()};b.prototype.setSecure=function(e){if(e&&["sip","http"].indexOf(this.scheme)>=0){this.scheme+="s"}};b.prototype.getSecure=function(){return["sips","https"].indexOf(this.scheme)>=0};a.URI=b;a._testAddress=function(){var f=new a.Address('"Kundan Singh" <sip:kundan@example.net>');var e=new a.Address("Kundan Singh   <sip:kundan@example.net>");var i=new a.Address('"Kundan Singh" <sip:kundan@example.net>   ');var h=new a.Address("<sip:kundan@example.net>");var g=new a.Address("sip:kundan@example.net");assert(f.toString()=='"Kundan Singh" <sip:kundan@example.net>',"Address('\"Kundan Singh\" <sip:kundan@example.net>').toString()");assert(f.toString()==e.toString(),"'\"Kundan Singh\" <sip:kundan@example.net>' == 'Kundan Singh   <sip:kundan@example.net>'");assert(f.toString()==i.toString(),"'\"Kundan Singh\" <sip:kundan@example.net>' == '\"Kundan Singh\" <sip:kundan@example.net>   '");assert(f.uri.toString()==h.uri.toString(),'Address("<sip:kundan@example.net>").uri');assert(f.uri.toString()==g.uri.toString(),'Address("sip:kundan@example.net").uri');assert(f.getDisplayable()=="Kundan Singh","Address('\"Kundan Singh\" <sip:kundan@example.net>').getDisplayable()")};function c(e){this.displayName=null;this.uri=null;this.wildcard=false;this.mustQuote=false;if(e){this.parse(e)}}c._syntax=[/^([a-zA-Z0-9\-\.\_\+\~\ \t]*)<([^>]+)>/,/^"([^"]*)"[\ \t]*<([^>]+)>/,/^[\ \t]*()([^;]+)/];c.prototype.parse=function(j){if(j.substr(0,1)=="*"){this.wildcard=true;return 1}else{var h=0;for(var g=0;g<c._syntax.length;++g){var f=c._syntax[g];var e=j.match(f);if(e){this.displayName=a.str_strip(e[1]);this.uri=new a.URI(a.str_strip(e[2]));h=e[0].length;break}}return h}};c.prototype.toString=function(){return(this.uri?(this.displayName?('"'+this.displayName+'"'+(this.uri?" ":"")):"")+(((this.mustQuote||this.displayName?"<":"")+this.uri.toString()+(this.mustQuote||this.displayName?">":""))):"")};c.prototype.dup=function(){return new c(this.toString())};c.prototype.getDisplayable=function(e){if(e===undefined){e=25}var f=this.displayName||this.uri&&this.uri.user||this.uri&&this.uri.host||"";return f.length<=e?f:f.substr(0,e-3)+"..."};a.Address=c})(sip);(function(g){g._quote=function(n){return n.length>=2&&n[0]=='"'&&n[n.length-1]=='"'?n:'"'+n+'"'};g._unquote=function(n){return n.length>=2&&n[0]=='"'&&n[n.length-1]=='"'?n.substr(1,n.length-2):n};g._address=["contact","from","record-route","refer-to","referred-by","route","to","p-preferred-identity"];g._comma=["authorization","proxy-authenticate","proxy-authorization","www-authenticate"];g._unstructured=["call-id","cseq","date","expires","max-forwards","organization","server","subject","timestamp","user-agent","accept-contact"];g._short=["allow-events","u","call-id","i","contact","m","content-encoding","e","content-length","l","content-type","c","event","o","from","f","subject","s","supported","k","to","t","via","v"];g._exception={"call-id":"Call-ID",cseq:"CSeq","www-authenticate":"WWW-Authenticate","x-alu-authorization":"X-ALU-Authorization"};g._testCanon=function(){assert(g._canon("call-id")=="Call-ID",'_canon("call-id") == "Call-ID"');assert(g._canon("fRoM")=="From",'_canon("fRoM") == "From"');assert(g._canon("refer-to")=="Refer-To",'_canon("refer-to") == "Refer-To"')};g._canon=function(n){n=n.toLowerCase();if(n.length==1&&g._short[n]!==undefined){return g._canon(g._short[g._short.indexOf(n)-1])}else{if(g._exception[n]!==undefined){return g._exception[n]}else{return g.map(function(o){return o.charAt(0).toUpperCase()+g.str_slice(o,1)},n.split("-")).join("-")}}};g._getValues=function(s){var r=[];var n=false;var p=0;if(s.indexOf(",")==-1&&s.toLowerCase().indexOf("%2c")==-1){r.push(s)}else{for(var q=0,o=s.length;q<o;q++){if(s[q]=="%"){var t=s.toLowerCase().substr(q,3);if(t=="%22"||t=="%27"){n=!n}else{if(t=="%2c"){if(n==false){r.push(s.substring(p,q));p=q+1}}}}else{if(s[q]=='"'||s[q]=="'"){n=!n}else{if(s[q]==","){if(n==false){r.push(s.substring(p,q));p=q+1}}}}}r.push(s.substring(p,q))}return r};g._testHeader=function(){assert((new g.Header('"Kundan Singh" <sip:kundan@example.net>',"To")).toRepr()=='To: "Kundan Singh" <sip:kundan@example.net>','Header(\'"Kundan Singh" <sip:kundan@example.net>\', "To")');assert((new g.Header('"Kundan"<sip:kundan99@example.net>',"To")).toRepr()=='To: "Kundan" <sip:kundan99@example.net>','Header(\'"Kundan"<sip:kundan99@example.net>\', "To")');assert((new g.Header("Henry <sip:henry.sinnreich@example.net>","fRoM")).toRepr()=='From: "Henry" <sip:henry.sinnreich@example.net>',"Header('Henry <sip:henry.sinnreich@example.net>', \"fRoM\")");assert((new g.Header("application/sdp","conTenT-tyPe")).toRepr()=="Content-Type: application/sdp",'Header("application/sdp", "conTenT-tyPe")');assert((new g.Header("presence; param=value;param2=another","Event")).toRepr()=="Event: presence;param=value;param2=another","Header('presence; param=value;param2=another', 'Event')");assert((new g.Header("78  INVITE","CSeq")).toRepr()=="CSeq: 78 INVITE","Header('78  INVITE', 'CSeq')")};function k(o,n){this.name=(n!==undefined?g._canon(g.str_strip(n)):null);this.value=this._parse(g.str_strip(o),this.name?this.name.toLowerCase():null)}k.prototype._parseParams=function(r,p){try{var o=r.length,s=0;if(r.toLowerCase().indexOf("digest ")===0){return}var w=0;while(s<o){w+=1;if(w>60){console.warn("sip.Header._parseParams: Breaking out of possibly infinite loop");break}var y=r.indexOf("=",s);var u=r.indexOf(";",s);if(u<0){u=r.indexOf(",",s);if(u<0){u=o}}var q="",x="";if(y>=0&&y<u){while((r[s]==",")||(r[s]==" ")||(r[s]==";")||(r[s]=="\r")){++s}q=g.str_strip(r.substring(s,y).toLowerCase());if(r.charAt(y+1)=='"'){y+=1;u=r.indexOf('"',y+1)}x=g.str_strip(r.substring(y+1,u));s=u+1}else{if(y<0||(y>=0&&y>u)){q=g.str_strip(r.substring(s,u).toLowerCase());s=u+1}else{break}}if(q){this[q]=x}}}catch(t){log("ignoring parameter exception: "+t)}};k.prototype._parse=function(t,p){if(g._address.indexOf(p)>=0){var v=new g.Address();v.mustQuote=true;var s=v.parse(t);var q=t.substr(s);t=v;if(q){this._parseParams(q,false)}}else{if(g._comma.indexOf(p)<0&&g._unstructured.indexOf(p)<0){var r=g.str_partition(t,";");t=r[0];var q=r[2];if(q){this._parseParams(q,false)}}else{if(g._comma.indexOf(p)>=0){var o=g.str_partition(t," ");this.authMethod=o[0];var q=o[2];if(q){this._parseParams(q,true)}}else{if(p=="cseq"){nsm=g.str_partition(t," ");var u=g.str_strip(nsm[0]);this.method=g.str_strip(nsm[2]);this.number=parseInt(u);t=u+" "+this.method}}}}return t};k.prototype.toString=function(){var o=this.name.toLowerCase();var r=[];if(g._comma.indexOf(o)<0&&g._unstructured.indexOf(o)<0){var p=["name","value","_viauri"];for(var q in this){if(typeof q=="string"&&p.indexOf(q.toLowerCase())<0&&typeof this[q]!="function"){var n=this[q];if(n&&!/^[a-zA-Z0-9\-\.\!\%\*_\+\`\'\~]*$/.test(n)){n='"'+n+'"'}r.push(n?q.toLowerCase()+"="+n:q)}}}return this.value.toString()+(r.length>0?";"+r.join(";"):"")};k.prototype.toRepr=function(){return this.name+": "+this.toString()};k.prototype.dup=function(){return k(this.toString(),this.name)};k.prototype.getItem=function(n){var o=n.toLowerCase();return(this[o]!==undefined?this[o]:null)};k.prototype.setItem=function(n,p){var o=n.toLowerCase();this[o]=p};k.prototype.hasItem=function(n){return this[n.toLowerCase()]!==undefined};g._testViaUri=function(){assert((new g.Header("SIP/2.0/UDP example.net:5090;ttl=1","Via")).getViaUri().toString()=="sip:example.net:5090;transport=udp","Header('SIP/2.0/UDP example.net:5090;ttl=1', 'Via').getViaUri()");assert((new g.Header("SIP/2.0/UDP 192.1.2.3;rport=1078;received=76.17.12.18;branch=0","Via")).getViaUri().toString()=="sip:76.17.12.18:1078;transport=udp","Header('SIP/2.0/UDP 192.1.2.3;rport=1078;received=76.17.12.18;branch=0', 'Via').getViaUri()");assert((new g.Header("SIP/2.0/UDP 192.1.2.3;maddr=224.0.1.75","Via")).getViaUri().toString()=="sip:224.0.1.75:5060;transport=udp","Header('SIP/2.0/UDP 192.1.2.3;maddr=224.0.1.75', 'Via').getViaUri()")};k.prototype.getViaUri=function(){if(this["_viaUri"]===undefined){if(this.name!="Via"){throw new String("getViaUri() available only on Via header")}var n=g.str_partition(this.value," ");var p=n[0];var r=n[2];var o=p.split("/")[2].toLowerCase();this._viaUri=new g.URI("sip:"+r+";transport="+o);if(!this._viaUri.port){this._viaUri.port=5060}if(this["rport"]!==undefined){try{this._viaUri.port=(typeof this["rport"]=="number"?parseInt(this["rport"]):this["rport"])}catch(q){}}if(o!="tcp"&&o!="sctp"&&o!="tls"){if(this["maddr"]!==undefined){this._viaUri.host=this["maddr"]}else{if(this["received"]!==undefined){this._viaUri.host=this["received"]}}}}return this["_viaUri"]};g._testCreateHeaders=function(){var n=g.Header.createHeaders("Event: presence, reg");assert(n[0]=="Event",'Header.createHeaders("Event: presence, reg")[0] != "Event"');assert(n[1].length==2,'Header.createHeaders("Event: presence, reg")[1].length != 2');assert(n[1][0].toRepr()=="Event: presence",'Header.createHeaders("Event: presence, reg")[1][0].toRepr() != "Event: presence"');assert(n[1][1].toRepr()=="Event: reg",'Header.createHeaders("Event: presence, reg")[1][1].toRepr() != "Event: reg"')};k.createHeaders=function(p){var n=g.str_partition(p,":");var o=g.str_strip(n[0]);p=g.str_strip(n[2]);var q;if(g._comma.indexOf(o.toLowerCase())>=0){q=[new g.Header(p,o)]}else{q=g.map(function(r){return new g.Header(r,o)},g._getValues(p))}return[g._canon(o),q]};g.Header=k;g._testMessage=function(){var n="INVITE sip:kundan@example.net SIP/2.0\r\nFrom: <sip:henry@iptel.org>\r\nTo: <sip:kundan@example.net>\r\nCall-ID: 1234@127.0.0.1\r\nCSeq: 1 INVITE\r\nContent-Length: 10\r\n\r\nsomebody\r\n";assert((new g.Message(n)).toString()==n,"Message(t1)")};function i(n){this.method=null;this.uri=null;this.response=null;this.responsetext=null;this.protocol="SIP/2.0";this._body=null;this._headers={};if(n!==undefined){this._parse(n)}}i._keywords=["method","uri","response","responsetext","protocol","_body","body","_headers"];i._single=["call-id","content-disposition","content-length","content-type","cseq","date","expires","event","max-forwards","organization","refer-to","referred-by","server","session-expires","subject","timestamp","to","user-agent"];i.prototype.getItem=function(n){var o=n.toLowerCase();return(this._headers[o]!==undefined?this._headers[o]:null)};i.prototype.setItem=function(n,p){var o=n.toLowerCase();this._headers[o]=p};i.prototype.delItem=function(n){var o=n.toLowerCase();delete this._headers[o]};i.prototype.hasItem=function(n){var o=n.toLowerCase();return(this._headers[o]!==undefined)};i.prototype._parse=function(z){var n=z.indexOf("\r\n\r\n");var s=z.indexOf("\n\n");var B,v;if(n>=0&&s>=0){if(n<s){s=-1}else{n=-1}}else{if(n<0&&s<0){log("Message.parse() did not find LFLF or CRLFCRLF")}}if(n>=0){B=z.substr(0,n);v=z.substr(n+4)}else{if(s>=0){B=z.substr(0,s);v=z.substr(s+2)}else{B=z;v=""}}var r,p;var D=B.indexOf("\n");if(D>0&&B.charAt(D-1)=="\r"){r=B.substr(0,D-1);p=B.substr(D+1)}else{if(D>0){r=B.substr(0,D);p=B.substr(D+1)}}var y=r.split(" ");if(y.length<3){throw new String("not enough parts in first line")}if(y[1].match(/^\d+$/)){this.protocol=y.shift();this.response=parseInt(y.shift());this.responsetext=y.join(" ")}else{if(y.length>3){throw new String("invalid number of parts in request line")}else{this.method=y[0];this.uri=new g.URI(y[1]);this.protocol=y[2]}}y=p.split("\n");var u=false;for(var F=0;F<y.length;++F){if(y[F]!=undefined){if(y[F].search(",\r")!=-1){if(u==false){C=F;u=true}else{y[F]=undefined}y[C]=y[C].concat(y[F+1])}else{if(u==true){y[F]=undefined}u=false}}}for(var F=0;F<y.length;++F){var G=y[F];if(G==undefined){continue}if(G&&G.charAt(G.length-1)=="\r"){G=G.substr(0,G.length-1)}if(G.charAt(0)==" "||G.charAt(0)=="\t"){}try{var q=g.Header.createHeaders(G);var I=q[0];var o=q[1];if(!this.hasItem(I)){this.setItem(I,o.length>1?o:o[0])}else{if(i._single.indexOf(I)<0){var x=this.getItem(I);if(!g.is_array(x)){this.setItem(I,[x])}x=this.getItem(I);for(var C=0;C<o.length;++C){x.push(o[C])}}}}catch(H){log("error parsing "+G);if(H.stack!==undefined){log(H.stack)}else{log(H)}continue}}var w=(this.hasItem("Content-Length")?parseInt(this.getItem("Content-Length").value):0);if(v){this.setBody(v);var t=i.utf8ByteLength(v);if(w!=t){throw new String("invalid content length "+w+" != "+v.length)}}var E=["To","From","CSeq","Call-ID"];for(var A=0;A<E.length;++A){if(!this.hasItem(E[A])){throw new String("mandatory header "+E[A]+" is missing")}}};i.prototype.toString=function(){var n;if(this.method){n=this.method+" "+this.uri.toString()+" "+this.protocol+"\r\n"}else{if(this.response){n=this.protocol+" "+this.response+" "+this.responsetext+"\r\n"}else{return null}}var t=["via","from","to","call-id","cseq","max-forwards"];for(var r in this._headers){if(typeof this._headers[r]!="function"&&t.indexOf(r)<0){t.push(r)}}for(var q=0;q<t.length;++q){var r=t[q];if(this._headers[r]!==undefined){var o=this._headers[r];if(g.is_array(o)){for(var p=0;p<o.length;++p){n+=o[p].toRepr()+"\r\n"}}else{n+=o.toRepr()+"\r\n"}}}n+="\r\n";if(this.body){n+=this.body}return n};i.prototype.dup=function(){return new i(this.toString())};i.prototype.first=function(o){var n=this.getItem(o);return(g.is_array(n)?n[0]:n)};i.prototype.all=function(){var q=g.map(function(s){return s.toLowerCase()},arguments?arguments:[]);var n=[];for(var r=0;r<q.length;++r){var o=this.getItem(q[r]);if(o!==null){if(g.is_array(o)){for(var p=0;p<o.length;++p){n.push(o[p])}}else{n.push(o)}}}return n};i.prototype.insert=function(p,n){if(p&&p.name){if(!this.hasItem(p.name)){this.setItem(p.name,p)}else{var o=this.getItem(p.name);if(!g.is_array(o)){this.setItem(p.name,[o])}o=this.getItem(p.name);if(n){o.push(p)}else{o.splice(0,0,p)}}}};i.prototype.del=function(o,n){if(n===undefined){this.deleteItem(o)}else{var p=this.all(o);try{p.splice(n,1)}catch(q){}if(p.length==0){this.delItem(o)}else{if(p.length==1){this.setItem(o,p[0])}else{this.setItem(o,p)}}}};i.prototype.setBody=function(o){this.body=o;var n=i.utf8ByteLength(o);this.setItem("Content-Length",new g.Header(o?""+n:0,"Content-Length"))};i.utf8ByteLength=function(p){var q=0;var o;var n;for(o=0;o<p.length;o++){n=p.charCodeAt(o);if(n<127){q=q+1}else{if((128<=n)&&(n<=2047)){q+=2}else{if((2048<=n)&&(n<=65535)){q+=3}}}}return q};i._populateMessage=function(n,q,p){if(q){for(var o=0;o<q.length;++o){n.insert(q[o],true)}}if(p){n.setBody=p}else{n.setItem("Content-Length",new g.Header("0","Content-Length"))}};i.createRequest=function(r,p,q,o){var n=new g.Message();n.method=r;n.uri=typeof p=="string"?new g.URI(p):p;n.protocol="SIP/2.0";i._populateMessage(n,q,o);if(n.hasItem("CSeq")&&n.getItem("CSeq").method!=r){n.setItem("CSeq",new g.Header(""+n.getItem("CSeq").number+" "+r,"CSeq"))}return n};i.createResponse=function(o,t,s,q,p){var n=new g.Message();n.response=o;n.responsetext=t;if(p!==undefined){n.setItem("To",p.getItem("To"));n.setItem("From",p.getItem("From"));n.setItem("CSeq",p.getItem("CSeq"));n.setItem("Call-ID",p.getItem("Call-ID"));n.setItem("Via",p.getItem("Via"));if(o==100&&p.hasItem("Timestamp")){n.setItem("Timestamp",p.getItem("Timestamp"))}}i._populateMessage(n,s,q);return n};i.prototype.is1xx=function(){return this.response&&Math.floor(this.response/100)==1};i.prototype.is2xx=function(){return this.response&&Math.floor(this.response/100)==2};i.prototype.is3xx=function(){return this.response&&Math.floor(this.response/100)==3};i.prototype.is4xx=function(){return this.response&&Math.floor(this.response/100)==4};i.prototype.is5xx=function(){return this.response&&Math.floor(this.response/100)==5};i.prototype.is6xx=function(){return this.response&&Math.floor(this.response/100)==6};i.prototype.isfinal=function(){return this.response&&this.response>=200};g.Message=i;function j(n){this.branch=null;this.id=null;this.stack=null;this.app=null;this.request=null;this.transport=null;this.remote=null;this.tag=null;this.state=null;this.server=n;this.timers={};this.timer=new g.Timer();this.close=function(){this.stopTimers();if(this.stack){if(this.stack.transactions[this.id]!==undefined){delete this.stack.transactions[this.id]}}};this.setState=function(o){this.state=o;if(this.state=="terminated"){this.close()}};this.getHeaders=function(){var o=this.request;return g.map(function(p){return o.getItem(p)},["To","From","CSeq","Call-ID"])};this.createAck=function(){return(this.request&&!this.server?i.createRequest("ACK",this.request.uri.toString(),this.getHeaders()):null)};this.createCancel=function(){var o=(this.request&&!this.server?i.createRequest("CANCEL",this.request.uri.toString(),this.getHeaders()):null);if(o&&this.request.hasItem("Route")){o.setItem("Route",this.request.getItem("Route"))}if(o){o.setItem("Via",this.request.first("Via"))}return o};this.createResponse=function(p,r){var o=(this.request&&this.server?i.createResponse(p,r,null,null,this.request):null);var q=o.getItem("To");if(p!=100&&q.tag===undefined){q.tag=this.tag}return o};this.startTimer=function(o,p){if(p>0){var q;if(this.timers[o]!==undefined){q=this.timers[o]}else{q=this.stack.createTimer(this);this.timers[o]=q}q.delay=p;q.start()}};this.stopTimers=function(){for(var p in this.timers){var o=this.timers[p];delete this.timers[p];o.stop()}};this.timedout=function(r){if(r.running){r.stop()}var q=false;for(var p in this.timers){var o=this.timers[p];if(o===r){delete this.timers[p];if(!q){q=true;this.timeout(p,r.delay)}}}}}j.createBranch=function(p,r){var t,s,o,n;if(g.is_array(p)){t=p[0];s=p[1];o=p[2];n=p[3];localtag=p[4];remotetag=p[5]}else{t=p.getItem("To").value;s=p.getItem("From").value;o=p.getItem("Call-ID").value;n=p.getItem("CSeq").number}var q=t.toString().toLowerCase()+"|"+s.toString().toLowerCase()+"|"+o.toString()+"|"+n.toString()+"|"+localtag+"|"+((remotetag!=null)?remotetag:"");return"z9hG4bK"+g.b64_urlsafe_encode(g.MD5(q))};j.createProxyBranch=function(o,p){var n=o.first("Via");if(n&&n.branch!==undefined){return"z9hG4bK"+g.b64_urlsafe_encode(g.MD5(n.branch))}else{return j.createBranch(o,p)}};j.createId=function(n,o){return(o!="ACK"&&o!="CANCEL"?n:n+"|"+o)};j.createServer=function(o,s,r,v,n,u){if(u===undefined){u=true}var q=(r.method=="INVITE"?new g.InviteServerTransaction():new g.ServerTransaction());q.stack=o;q.app=s;q.request=r;q.transport=v;q.tag=n;var p=r.first("Via");q.remote=(p?p.getViaUri().getHostPort():null);q.branch=(p&&p.branch!==undefined?p.branch:j.createBranch(r,true));q.id=j.createId(q.branch,r.method);o.transactions[q.id]=q;if(u){q.start()}else{q.state="trying"}return q};j.createClient=function(n,s,q,u,r){var p=(q.method=="INVITE"?new g.InviteClientTransaction():new g.ClientTransaction());p.stack=n;p.app=s;p.request=q;p.remote=r;p.transport=u;var o=q.first("Via");p.branch=(o&&o.branch!==undefined?o.branch:j.createBranch(q,false));p.id=j.createId(p.branch,q.method);n.transactions[p.id]=p;p.start();return p};j.equals=function(s,q,p){var o=s.request;var n=o.getItem("To").value.uri.equals(q.getItem("To").value.uri);n=n&&o.getItem("From").value.uri.equals(q.getItem("From").value.uri);n=n&&(o.getItem("Call-ID").value==q.getItem("Call-ID").value);n=n&&(q.getItem("CSeq").value==q.getItem("CSeq").value);n=n&&(o.getItem("From").tag==q.getItem("From").tag);n=n&&(p.server==s.server);return n};g.Transaction=j;function m(p,o,n){this.T1=(p===undefined?500:p);this.T2=(o===undefined?4000:o);this.T4=(n===undefined?5000:n)}m.prototype.A=function(){return this.T1};m.prototype.B=function(){return 64*this.T1};m.prototype.D=function(){return Math.max(64*this.T1,32000)};m.prototype.E=m.prototype.A;m.prototype.F=m.prototype.B;m.prototype.G=m.prototype.A;m.prototype.H=m.prototype.B;m.prototype.I=function(){return this.T4};m.prototype.J=m.prototype.B;m.prototype.K=m.prototype.I;g.Timer=m;function b(){this.base=g.Transaction;this.base(false);delete this.base;this.start=function(){this.state="trying";if(!this.transport.reliable){this.startTimer("E",this.timer.E())}this.startTimer("F",this.timer.F());this.stack.send(this.request,this.remote,this.transport)};this.receivedResponse=function(n){if(n.is1xx()){if(this.state=="trying"){this.state="proceeding";this.app.receivedResponse(this,n)}else{if(this.state=="proceeding"){this.app.receivedResponse(this,n)}}}else{if(n.isfinal()){if(this.state=="trying"||this.state=="proceeding"){this.state="completed";this.app.receivedResponse(this,n);if(!this.transport.reliable){this.startTimer("K",this.timer.K())}else{this.timeout("K",0)}}}}};this.timeout=function(n,o){if(this.state=="trying"||this.state=="proceeding"){if(n=="E"){o=(this.state=="trying"?Math.min(2*o,this.timer.T2):this.timer.T2);this.startTimer("E",o);this.stack.send(this.request,this.remote,this.transport)}else{if(n=="F"){this.state="terminated";this.app.timeout(this)}}}else{if(this.state=="completed"){if(n=="K"){this.state="terminated"}}}};this.error=function(n){if(this.state=="trying"||this.state=="proceeding"){this.state="terminated";this.app.error(this,n)}}}g.ClientTransaction=b;function e(){this.base=g.Transaction;this.base(true);delete this.base;this.start=function(){this.state="trying";this.app.receivedRequest(this,this.request)};this.receivedRequest=function(n){if(this.request.method==n.method){if(this.state=="proceeding"||this.state=="completed"){this.stack.send(this.lastResponse,this.remote,this.transport)}else{if(this.state=="trying"){}}}};this.timeout=function(n,o){if(this.state=="completed"){if(n=="J"){this.state="terminated"}}};this.error=function(n){if(this.state=="completed"){this.state="terminated";this.app.error(this,n)}};this.sendResponse=function(n){this.lastResponse=n;if(n.is1xx()){if(this.state=="trying"||this.state=="proceedings"){this.state="proceeding";this.stack.send(n,this.remote,this.transport)}}else{if(n.isfinal()){if(this.state=="proceeding"||this.state=="trying"){this.state="completed";this.stack.send(n,this.remote,this.transport);if(!this.transport.reliable){this.startTimer("J",this.timer.J())}else{this.timeout("J",0)}}}}}}g.ServerTransaction=e;function l(){this.base=g.Transaction;this.base(false);delete this.base;this.start=function(){this.state="calling";if(!this.transport.reliable){this.startTimer("A",this.timer.A())}this.startTimer("B",this.timer.B());this.stack.send(this.request,this.remote,this.transport)};this.receivedResponse=function(n){if(n.is1xx()){if(this.state=="calling"){this.state="proceeding";this.app.receivedResponse(this,n)}else{if(this.state=="proceeding"){this.app.receivedResponse(this,n)}}}else{if(n.is2xx()){if(this.state=="calling"||this.state=="proceeding"){this.state="terminated";this.app.receivedResponse(this,n)}else{if(this.state=="terminated"){this.stack.send(this.createAck(n),this.remote,this.transport)}}}else{if(this.state=="calling"||this.state=="proceeding"){this.state="completed";this.stack.send(this.createAck(n),this.remote,this.transport);this.app.receivedResponse(this,n);if(!this.transport.reliable){this.startTimer("D",this.timer.D())}else{this.timeout("D",0)}}else{if(this.state=="completed"){this.stack.send(this.createAck(n),this.remote,this.transport)}}}}};this.timeout=function(n,o){if(this.state=="calling"){if(n=="A"){this.startTimer("A",2*o);this.stack.send(this.request,this.remote,this.transport)}else{if(n=="B"){this.state="terminated";this.app.timeout(this)}}}else{if(this.state=="completed"){if(n=="D"){this.state="terminated"}}}};this.error=function(n){if(this.state=="calling"||this.state=="completed"){this.state="terminated";this.app.error(this,n)}};this.createAck=function(o){if(!this.request){throw new String("No transaction request found")}var n=i.createRequest("ACK",this.request.uri.toString());n.setItem("Call-ID",this.request.getItem("Call-ID"));n.setItem("From",this.request.getItem("From"));n.setItem("To",o?o.getItem("To"):this.request.getItem("To"));n.setItem("Via",this.request.first("Via"));n.setItem("CSeq",new g.Header(""+this.request.getItem("CSeq").number+" ACK","CSeq"));if(this.request.hasItem("Route")){n.setItem("Route",this.request.getItem("Route"))}return n}}g.InviteClientTransaction=l;function a(){this.base=g.Transaction;this.base(true);delete this.base;this.start=function(){this.state="proceeding";this.sendResponse(this.createResponse(100,"Trying"));this.app.receivedRequest(this,this.request)};this.receivedRequest=function(n){if(this.request.method==n.method){if(this.state=="proceeding"||this.state=="completed"){this.stack.send(this.lastResponse,this.remote,this.transport)}}else{if(n.method=="CANCEL"){this.app.receivedRequest(this,n)}else{if(n.method=="ACK"){if(this.state=="completed"){this.state="confirmed";if(!this.transport.reliable){this.startTimer("I",this.timer.I())}else{this.timeout("I",0)}this.app.receivedRequest(this,n)}else{if(this.state=="confirmed"){}else{if(this.state=="terminated"){this.app.receivedRequest(this,n)}}}}}}};this.timeout=function(n,o){if(this.state=="completed"){if(n=="G"){this.startTimer("G",Math.min(2*o,this.timer.T2));this.stack.send(this.lastResponse,this.remote,this.transport)}else{if(n=="H"){this.state="terminated";this.app.timeout(this)}}}else{if(this.state=="confirmed"){if(n=="I"){this.state="terminated"}}}};this.error=function(n){if(this.state=="proceeding"||this.state=="trying"||this.state=="confirmed"){this.state="terminated";this.app.error(this,n)}};this.sendResponse=function(n){this.lastResponse=n;if(n.is1xx()){if(this.state=="proceeding"||this.state=="trying"){this.stack.send(n,this.remote,this.transport)}}else{if(n.is2xx()){if(this.state=="proceeding"||this.state=="trying"){this.state="terminated";this.stack.send(n,this.remote,this.transport)}}else{if(this.state=="proceeding"||this.state=="trying"){this.state="completed";if(!this.transport.reliable){this.startTimer("G",this.timer.G())}this.startTimer("H",this.timer.H());this.stack.send(n,this.remote,this.transport)}}}}}g.InviteServerTransaction=a;function c(n,o,p){if(n!==undefined){this.stack=n;this.request=(o===undefined?null:o);this.server=(p===undefined?(o!==null):p);this.name=(this.server?"UAS":"UAC");this.transaction=null;this.cancelTransaction=null;this.breaker=false;this.cancelRequest=null;this.callId=(o&&o.hasItem("Call-ID")?o.getItem("Call-ID").value:this.stack.getNewCallId());this.remoteParty=(o&&o.hasItem("From")?o.getItem("From").value:null);this.localParty=(o&&o.hasItem("To")?o.getItem("To").value:null);this.localTag=this.stack.tag+Math.floor(10000000000*Math.random());this.remoteTag=null;this.subject=(o&&o.hasItem("Subject")?o.getItem("Subject").value:null);this.secure=(o&&o.uri.scheme=="sips"?true:false);this.maxForwards=70;this.routeSet=[];this.localTarget=null;this.remoteTarget=null;this.remoteCandidates=null;this.localSeq=0;this.remoteSeq=0;this.contact=new g.Address(this.stack.uri.toString());if(this.localParty&&this.localParty.uri.user){this.contact.uri.user=this.localParty.uri.user}this.autoack=true;this.auth={}}}c.prototype.toString=function(){return"<"+this.name+" call-id="+this.callId+" />"};c.prototype.createTransaction=function(n){return g.Transaction.createServer(this.stack,this,n,this.stack.transport,this.stack.tag)};c.prototype.createRequest=function(n,w,y){if(y===undefined){y=null}if(w===undefined){w=null}this.server=false;if(!this.remoteParty){throw new String("No remoteParty for UAC")}if(!this.localParty){this.localParty=new g.Address('"Anonymous" <sip:anonymous@anonymous.invalid>')}var q=new g.URI(this.remoteTarget?this.remoteTarget.toString():this.remoteParty.uri.toString());if(n=="REGISTER"){q.user=null}if(!this.secure&&q.secure){this.secure=true}if(n!="ACK"&&n!="CANCEL"){this.localSeq=this.localSeq+1}var A=new g.Header(this.remoteParty.toString(),"To");A.value.uri.secure=this.secure;var o=new g.Header(this.localParty.toString(),"From");o.value.uri.secure=this.secure;o.tag=this.localTag;var u=new g.Header(""+this.localSeq+" "+n,"CSeq");if(n=="REGISTER"){this.callId=this.stack.getNewCallId()}var v=new g.Header(this.callId,"Call-ID");var t=new g.Header(""+this.maxForwards,"Max-Forwards");var z=this.stack.createVia(this.secure);z.branch=g.Transaction.createBranch([A.value,o.value,v.value,u.number,this.localTag,this.remoteTag],false);if(!this.localTarget){this.localTarget=this.stack.uri.dup();this.localTarget.user=this.localParty.uri.user}if(n!="MESSAGE"){var r=new g.Header(this.localTarget.toString(),"Contact");if(this.breaker){r.value.uri.param.transport="ws";r.value.uri.param["rtcweb-breaker"]="yes"}r.value.uri.secure=this.secure;var p=[A,o,u,v,t,z,r]}else{var p=[A,o,u,v,t,z]}if(this.routeSet){for(var s=0;s<this.routeSet.length;++s){var x=new g.Header(this.routeSet[s].toString(),"Route");x.value.uri.secure=this.secure;p.push(x)}}if(y){p.append(new g.Header(y,"Content-Type"))}this.request=i.createRequest(n,q.toString(),p,w);return this.request};c.prototype.createRegister=function(n){if(n){this.remoteParty=new g.Address(n.toString())}if(!this.localParty){this.localParty=new g.Address(this.remoteParty.toString())}return this.createRequest("REGISTER")};c.prototype.sendRequest=function(p){if(!this.request&&p.method=="REGISTER"){if(this.transaction&&this.transaction.state!="completed"&&this.transaction.state!="terminated"){throw new String("Cannot re-REGISTER since pending registration")}}this.request=p;if(!p.hasItem("Route")){this.remoteTarget=p.uri}var q=this.remoteTarget;if(p.hasItem("Route")){var n=p.all("Route");if(n.length>0){q=n[0].value.uri;if(!q||q.param.lr===undefined){log("strict route target=",q,"routes=",n);n.shift();if(n.length>0){log("appending our route");n.append(new g.Header(p.uri.toString(),"Route"))}p.setItem("Route",n);p.uri=q}}}this.stack.sending(this,p);var o=q.dup();o.port=(q.port?q.port:(q.secure?5061:5060));if(o.host=="localhost"){this.remoteCandidates=[new g.URI("sip:127.0.0.1:"+o.port)];this.tryNextCandidate()}else{if(g.isIPv4(o.host)){this.remoteCandidates=[o];this.tryNextCandidate()}else{var r=this;this.stack.resolve(o.host,"A",function(t,s){r.remoteCandidates=g.map(function(u){return new g.URI("sip:"+u.address+":"+o.port)},s);r.tryNextCandidate()})}}};c.prototype.tryNextCandidate=function(){if(!this.remoteCandidates||this.remoteCandidates.length==0){this.error(null,"cannot resolve DNS target")}else{target=this.remoteCandidates.shift();if(this.request.method!="ACK"){this.transaction=g.Transaction.createClient(this.stack,this,this.request,this.stack.transport,target.getHostPort())}else{this.stack.send(this.request,target.getHostPort())}}};c.prototype.retryNextCandidate=function(){if(!this.remoteCandidates||this.remoteCandidates.length==0){throw new String("No more DNS resolved address to try")}var n=new g.URI(this.remoteCandiates.shift());this.request.first("Via").branch+="A";this.transaction=g.Transaction.createClient(this.stack,this,this.request,this.stack.transport,n.getHostPort())};c.prototype.canCreateDialog=function(o,n){return(n.is2xx()&&(o.method=="INVITE"||o.method=="SUBSCRIBE"))||(n.is1xx()&&n.getItem("To")["tag"]!==undefined)};c.prototype.receivedResponse=function(q,n){if(q&&q!==this.transaction){if(q&&q!==this.cancelTransaction){log("Invalid transaction received "+q+" != "+this.transaction);return}}if(n.all("Via").length>1){}if(n.is1xx()){if(this.cancelRequest){var p=g.Transaction.createClient(this.stack,this,this.cancelRequest,q.transport,q.remote);this.cancelRequest=null}else{this.stack.receivedResponse(this,n)}}else{if(n.response==401||n.response==407){if(!this.authenticate(n,this.transaction)){this.stack.receivedResponse(this,n)}}else{if(this.canCreateDialog(this.request,n)){var o=g.Dialog.createClient(this.stack,this.request,n,q);o.autoack=this.autoack;this.stack.dialogCreated(o,this);this.stack.receivedResponse(o,n);if(o.autoack&&this.request.method=="INVITE"&&n.getItem("CSeq")["method"]=="INVITE"){o.sendRequest(o.createRequest("ACK"))}}else{this.stack.receivedResponse(this,n)}}}};c.prototype.receivedRequest=function(q,p){if(q&&this.transaction&&q!=this.transaction&&p.method!="CANCEL"){throw new String("Invalid transaction for received request")}this.server=true;if(p.uri.scheme!="sip"&&p.uri.scheme!="sips"){q.sendResponse(q.createResponse(416,"Unsupported URI scheme"));return}if(p.getItem("To")["tag"]===undefined&&p.method!="CANCEL"){if(this.stack.findOtherTransaction(p,q)){q.sendResponse(q.createResponse(482,"Loop detected - found another transaction"));return}}if(p.hasItem("Require")){if(p.method!="CANCEL"&&p.method!="ACK"){var n=q.createResponse(420,"Bad extension");n.setItem("Unsupported",new g.Header(p.Require.value,"Unsupported"));q.sendResponse(n);return}}if(q&&p.method!="CANCEL"){this.transaction=q}if(p.method=="CANCEL"){var o=this.stack.findTransaction(g.Transaction.createId(q.branch,"INVITE"));if(!o){q.sendResponse(q.createResponse(481,"Original transaction not found"));return}if(o.state=="proceeding"||o.state=="trying"){o.sendResponse(o.createResponse(487,"Request Terminated"))}q.sendResponse(q.createResponse(200,"OK"));this.stack.cancelled(this,p);return}this.stack.receivedRequest(this,p)};c.prototype.sendResponse=function(p,t,r,s,o){if(t===undefined){t=null}if(r===undefined){r=null}if(s===undefined){s=null}if(o===undefined){o=true}if(!this.request){throw new String("Invalid request in sending a response")}if(typeof p=="number"){p=this.createResponse(p,t,r,s)}if(!o){if(this.request.hasItem("Record-Route")){p.setItem("Record-Route",this.request.getItem("Record-Route"))}if(!p.hasItem("Contact")){var n=new g.Address(this.contact.toString());if(!n.uri.user){n.uri.user=this.request.getItem("To").value.uri.user}n.uri.secure=this.secure;p.setItem("Contact",new g.Header(n.toString(),"Contact"))}this.stack.sending(q,p)}else{if(o&&this.canCreateDialog(this.request,p)){if(this.request.hasItem("Record-Route")){p.setItem("Record-Route",this.request.getItem("Record-Route"))}if(!p.hasItem("Contact")){var n=new g.Address(this.contact.toString());if(!n.uri.user){n.uri.user=this.request.getItem("To").value.uri.user}n.uri.secure=this.secure;p.setItem("Contact",new g.Header(n.toString(),"Contact"))}var q=h.createServer(this.stack,this.request,p,this.transaction);this.stack.dialogCreated(q,this);this.stack.sending(q,p)}else{this.stack.sending(this,p)}}if(!this.transaction){this.stack.send(p,p.first("Via").getViaUri().getHostPort())}else{this.transaction.sendResponse(p)}};c.prototype.createResponse=function(n,q,o,p){if(o===undefined){o=null}if(p==undefined){p=null}if(!this.request){throw new String("Invalid request in creating a response")}n=g.Message.createResponse(n,q,null,o,this.request);if(p){n.setItem("Content-Type",new g.Header(p,"Content-Type"))}if(n.response!=100&&n.getItem("To")["tag"]===undefined){n.getItem("To")["tag"]=this.localTag}return n};c.prototype.sendCancel=function(){if(!this.transaction){throw new String("No transaction for sending CANCEL")}this.cancelRequest=this.transaction.createCancel();this.cancelRequest.setItem("Max-Forwards",new g.Header(""+this.maxForwards,"Max-Forwards"));if(this.transaction.state!="trying"&&this.transaction.state!="calling"){if(this.transaction.state=="proceeding"){var n=g.Transaction.createClient(this.stack,this,this.cancelRequest,this.transaction.transport,this.transaction.remote);this.cancelTransaction=n}this.cancelRequest=null}};c.prototype.timeout=function(n){if(n&&n!=this.transaction){return}this.transaction=null;if(!this.server){if(this.remoteCandidates&&this.remoteCandidates.length>0){this.retryNextCandidate()}else{this.receivedResponse(null,i.createResponse(408,"Request timeout",null,null,this.request))}}};c.prototype.error=function(o,n){if(o&&o!=this.transaction){return}this.transaction=null;if(!this.server){if(this.remoteCandidates&&this.remoteCandidates.length>0){this.retryNextCandidate()}else{this.receivedResponse(null,i.createResponse(503,"Service unavailable - "+n,null,null,this.request))}}};c.prototype.authenticate=function(p,o){var v=p.first("WWW-Authenticate")||p.first("Proxy-Authenticate")||null;if(!v){return false}var q=new g.Message(o.request.toString());var t=false;var s=false;var n=q.all("Authorization","Proxy-Authorization");for(var r=0;r<n.length;++r){var u=n[r];console.log("handling b="+u);if((v.realm==u.realm)&&(((v.name=="WWW-Authenticate")&&(u.name=="Authorization"))||((v.name=="Proxy-Authenticate")&&(u.name=="Proxy-Authorization")))){s=true;break}}if(((s)||(u==undefined))&&(v.realm!==undefined)){var x=this.stack.authenticate(this,v);if(!x||v.password===undefined&&v.hashValue===undefined){return false}var w=g.createAuthorization(v.value,v.username,v.password,q.uri.toString(),this.request.method,this.request.body,this.auth);if(w){q.delItem("Authorization");q.insert(new g.Header(w,(v.name=="WWW-Authenticate"?"Authorization":"Proxy-Authorization")),true);t=true}}if(t){this.localSeq=this.localSeq+1;q.setItem("CSeq",new g.Header(""+this.localSeq+" "+q.method,"CSeq"));q.first("Via").branch=g.Transaction.createBranch(q,false);this.request=q;this.transaction=g.Transaction.createClient(this.stack,this,this.request,this.transaction.transport,this.transaction.remote);return true}else{return false}};g.UserAgent=c;function h(n,o,p,q){if(q===undefined){q=null}this.base=g.UserAgent;this.base(n,o,p,q);delete this.base;this.servers=[];this.clients=[];this._id=null;if(q){q.app=this}}h.prototype=new g.UserAgent;h.createServer=function(n,p,o,r){var q=new h(n,p,true);q.request=p;q.routeSet=(p.hasItem("Record-Route")?p.all("Record-Route"):null);while(q.routeSet&&g.isMulticast(q.routeSet[0].value.uri.host)){log("deleting top multicast routeSet "+q.routeSet[0]);q.routeSet.shift();if(q.routeSet.length==0){q.routeSet=null}}q.secure=p.uri.secure;q.localSeq=p.getItem("CSeq").number;q.remoteSeq=p.getItem("CSeq").number;q.callId=p.getItem("Call-ID").value;q.localTag=(o.getItem("To")["tag"]||"");q.remoteTag=(o.getItem("From")["tag"]||"");q.localParty=new g.Address(p.getItem("To").value.toString());q.remoteParty=new g.Address(p.getItem("From").value.toString());q.stack.log("request contact "+p.Contact);if(p.hasItem("Contact")){q.remoteTarget=new g.URI(p.first("Contact").value.uri.toString())}n.dialogs[q.getId()]=q;q.servers.push(r);return q};h.createClient=function(n,p,o,r){var q=new h(n,p,false);q.request=p;q.routeSet=(o.hasItem("Record-Route")?o.all("Record-Route").reverse():null);q.secure=p.uri.secure;q.localSeq=p.getItem("CSeq").number;q.remoteSeq=0;q.callId=p.getItem("Call-ID").value;q.localTag=(o.getItem("From")["tag"]||"");q.remoteTag=(o.getItem("To")["tag"]||"");q.localParty=new g.Address(p.getItem("From").value.toString());q.remoteParty=new g.Address(p.getItem("To").value.toString());if(o.hasItem("Contact")){q.remoteTarget=new g.URI(o.first("Contact").value.uri.toString())}n.dialogs[q.getId()]=q;return q};h.extractId=function(n){var o=n.getItem("Call-ID");var q=n.getItem("From");var p=n.getItem("To");return o.value+"|"+(n.method?p.tag:q.tag)+"|"+(n.method?q.tag:p.tag)};h.prototype.close=function(){if(this.stack){var n=this.getId();if(this.stack.dialogs[n]!==undefined){delete this.stack.dialogs[n]}}};h.prototype.getId=function(){if(!this._id){this._id=this.callId+"|"+this.localTag+"|"+this.remoteTag}return this._id};h.prototype.createRequest=function(q,o,p){var n=g.UserAgent.prototype.createRequest.apply(this,[q,o!==undefined?o:null,p!==undefined?p:null]);if(this.remoteTag){n.getItem("To")["tag"]=this.remoteTag}if(this.routeSet&&this.routeSet.length>0&&this.routeSet[0].value.uri.param.lr===undefined){n.uri=this.routeSet[0].value.uri.dup();if(n.uri.param.lr!==undefined){delete n.uri.param.lr}}return n};h.prototype.createResponse=function(n,r,p,q){if(this.servers.length==0){throw new String("No server transaction to create response")}var o=this.servers[0].request;n=g.Message.createResponse(n,r,null,p!==undefined?p:null,o);if(q){n.setItem("Content-Type",new g.Header(q,"Content-Type"))}if(n.response!=100&&n.getItem("To")["tag"]===undefined){n.getItem("To")["tag"]=this.localTag}return n};h.prototype.sendResponse=function(o,s,q,r,n){if(n===undefined){n=true}if(this.servers.length==0){throw new String("No server transaction to send response")}this.transaction=this.servers[0];this.request=this.servers[0].request;g.UserAgent.prototype.sendResponse.apply(this,[o,s!==undefined?s:null,q!==undefined?q:null,r!==undefined?r:null,false]);var p=typeof o=="number"?o:o.response;if(p>=200){this.servers.shift()}};h.prototype.sendCancel=function(){if(this.clients.length==0){d.stack.log("No client transaction to send cancel");return}this.transaction=this.clients[0];this.request=this.clients[0].request;g.UserAgent.prototype.sendCancel.apply(this,[])};h.prototype.receivedRequest=function(o,n){if(this.remoteSeq!=0&&n.getItem("CSeq").number<this.remoteSeq){d.stack.log("Dialog.receivedRequest() CSeq is old "+n.getItem("CSeq").number+" < "+this.remoteSeq);this.sendResponse(500,"Internal server error - invalid CSeq");return}this.remoteSeq=n.getItem("CSeq").number;if(n.method=="INVITE"&&n.hasItem("Contact")){this.remoteTarget=n.first("Contact").value.uri.dup()}if(n.method=="ACK"||n.method=="CANCEL"){this.servers=g.filter(function(p){return p!==o},this.servers);if(n.method=="ACK"){this.stack.receivedRequest(this,n)}else{this.stack.cancelled(this,o.request)}return}if(n.method!="ACK"){this.servers.push(o)}this.stack.receivedRequest(this,n)};h.prototype.receivedResponse=function(o,n){if(n.is2xx()&&n.hasItem("Contact")&&o&&o.request.method=="INVITE"){this.remoteTarget=n.first("Contact").value.uri.dup()}if(!n.is1xx()||(n.is1xx()&&n.getItem("To")["tag"]!==undefined)){this.clients=g.filter(function(p){return p!==o},this.clients)}if(n.response==408||n.response==481){this.close()}if(n.response==401||n.response==407){if(!this.authenticate(n,o)){this.stack.receivedResponse(this,n)}}else{if(o){this.stack.receivedResponse(this,n)}}if(this.autoack&&n.is2xx()&&(o&&o.request.method=="INVITE"||n.getItem("CSeq").method=="INVITE")){this.sendRequest(this.createRequest("ACK"))}};g.Dialog=h;function f(o,p,n){this.tag=""+Math.ceil(10000000000*Math.random());this.app=o;this.transport=p;this.fix_nat=(n!==undefined?n:false);this.closing=false;this.dialogs={};this.transactions={};this.serverMethods=["INVITE","BYE","MESSAGE","SUBSCRIBE","NOTIFY"];this.uri=new g.URI(((p.type=="tls")?"sips":"sip")+":"+p.hostport)}f.prototype.log=function(n){if(this.app){this.app.debug(n)}};f.prototype.close=function(){this.closing=true;for(var o in this.dialogs){delete this.dialogs[o]}for(var n in this.transactions){delete this.transactions[n]}delete this.dialogs;delete this.transactions};f.prototype.getNewCallId=function(){return""+Math.ceil(10000000000*Math.random())+"@"+(this.transport.host||"localhost")};f.prototype.createVia=function(n){if(!this.transport){throw new String("No transport in stack")}if(n&&!this.transport.secure){throw new String("Cannot find a secure transport")}return new g.Header("SIP/2.0/"+this.transport.type.toUpperCase()+" "+this.transport.hostport,"Via")};f.prototype.send=function(o,n,p){if(n&&(n instanceof g.URI)){if(!n.host){throw new String("No host in destination uri")}n=[n.host,n.port||(this.transport.type=="tls"||this.transport.secure?5061:5060)]}if(o instanceof g.Message){if(o.method){if(n&&g.isMulticast(n[0])){o.first("Via")["maddr"]=n[0];o.first("Via")["ttl"]=1}}else{if(o.response){if(!n){n=o.first("Via").getViaUri().getHostPort()}}}o=o.toString()}this.app.send(o,n,this)};f.prototype.received=function(r,u){var n=new g.Message();try{n._parse(r);var q=new g.URI((this.transport.secure?"sips":"sip")+":"+u[0].toString()+":"+u[1]);if(n.method){this.log("received request="+n.method);if(!n.hasItem("Via")){throw new String("No Via header in request")}var p=n.first("Via");if(p.getViaUri().host!=u[0]||p.getViaUri().port!=u[1]){p.received=u[0];p.getViaUri().host=u[0]}if(p.rport!==undefined){p.rport=u[1];p.getViaUri().port=u[1]}if(this.fix_nat&&(n.method=="INVITE"||n.method=="MESSAGE")){this._fixNatContact(n,u)}this._receivedRequest(n,q)}else{if(n.response){this.log("received response="+n.response+" "+n.responsetext);var o=n.getItem("CSeq");if(this.fix_nat&&o&&(o.method=="INVITE"||o.method=="MESSAGE")){this._fixNatContact(n,u)}this._receivedResponse(n,q)}else{throw new String("Received invalid message")}}}catch(t){this.log("Error in received message: "+t);this.log(t.stack);if(n.method&&n.uri&&n.protocol&&n.method!="ACK"){try{this.send(g.Message.createResponse(400,""+t,null,null,n))}catch(s){}}}};f.prototype._fixNatContact=function(n,p){if(n.hasItem("Contact")){var o=n.first("Contact").value.uri;if((o.scheme=="sip"||o.scheme=="sips")&&g.isIPv4(o.host)&&o.host!=p[0]&&!g.isLocal(p[0])&&!g.isLocal(o.host)&&g.isPrivate(o.host)&&!isPrivate(p[0])){this.log("fixing NAT -- private contact from "+o);o.host=p[0];o.port=p[1];this.log("to received "+o)}}};f.prototype._receivedRequest=function(n,q){if(!n.hasItem("Via")){throw new String("No Via header in received request")}var x=n.first("Via")["branch"]!==undefined?n.first("Via")["branch"]:"";var z=null;if(n.method=="ACK"){w=this.findDialog(n);if(w!=null){if(w.transaction instanceof a&&w.transaction!=null){lastResponse=w.transaction.lastResponse;if(lastResponse.isfinal()){if(lastResponse.is2xx()){z=null}else{this.log("Found existing transaction for ACK on non-2xx final response");z=w.transaction}}}else{z=null}}else{z=null}if(n.isfinal()){if(n.is2xx()){z=null}else{}}}else{z=this.findTransaction(x);if(!z){z=this.findTransaction(g.Transaction.createId(x,n.method))}}if(!z){var s=null;if(n.method!="CANCEL"&&n.getItem("To")["tag"]!==undefined){this.log("request has To tag");var w=this.findDialog(n);if(!w){this.log("no exiting dialog found");if(n.method!="ACK"){this.log("creating new UAS");var y=this.createServer(n,q);if(y){s=y}else{this.send(g.Message.createResponse(481,"Dialog does not exist",null,null,n));return}}else{this.log("no dialog for ACK, finding transaction");if(!z&&x!="0"){z=this.findTransaction(g.Transaction.createId(x,"INVITE"))}if(z&&z.state!="terminated"){this.log("Found transaction "+z);z.receivedRequest(n);return}else{this.log("No existing transaction for ACK");var y=this.createServer(n,q);if(y){s=y}else{this.log("Ignoring ACK without transaction");return}}}}else{this.log("found existing dialog");s=w}}else{if(n.method!="CANCEL"){this.log("creating new UAS");var y=this.createServer(n,q);if(y){s=y}else{if(n.method=="OPTIONS"){var v=new g.Message.createResponse(200,"OK",null,null,n);v.setItem("Allow",new g.Header("INVITE, ACK, CANCEL, BYE, OPTIONS","Allow"));this.send(v);return}else{if(n.method!="ACK"){this.send(g.Message.createResponse(405,"Method not allowed",null,null,n));return}}}}else{this.log("finding original transaction");var p=this.findTransaction(g.Transaction.createId(n.first("Via")["branch"],"INVITE"));if(!p){this.send(g.Message.createResponse(481,"Original transaction does not exist",null,null,n));return}else{s=p.app}}}if(s&&n.method!="ACK"){this.log("creating new server transaction");z=s.createTransaction(n);if(n.method=="ACK"&&z&&this.transactions[z.id]!==undefined){delete this.transactions[z.id]}}else{if(s&&n.method=="ACK"){s.receivedRequest(null,n)}else{if(n.method!="ACK"){this.log("could not find any app to handle the request");this.send(i.createResponse(404,"Not found",null,null,n))}}}}else{this.log("found existing transaction");if((z instanceof g.ServerTransaction)||(z instanceof g.InviteServerTransaction)){z.receivedRequest(n)}else{this.log("the transaction was not a server transaction");this.send(g.Message.createResponse(482,"Loop detected",null,null,n))}}};f.prototype._receivedResponse=function(s,q){if(!s.hasItem("Via")){throw new String("No Via header in received response")}var p=s.first("Via")["branch"]!==undefined?s.first("Via")["branch"]:"";var v=s.getItem("CSeq").method;var o=this.findTransaction(g.Transaction.createId(p,v));if(!o){if(v=="INVITE"&&s.is2xx()){var u=this.findDialog(s);if(!u){throw new String("No transaction or dialog for 2xx of INVITE")}else{u.receivedResponse(null,s)}}else{this.log("transaction id "+g.Transaction.createId(p,v)+" not found");if(v=="INVITE"&&s.isfinal()){var n=g.Message.createRequest("ACK",s.getItem("To").value.uri.toString());n.setItem("Call-ID",s.getItem("Call-ID"));n.setItem("From",s.getItem("From"));n.setItem("To",s.getItem("To"));n.setItem("Via",s.first("Via"));n.setItem("CSeq",new g.Header(""+s.getItem("CSeq").number+" ACK","CSeq"));this.send(n,q.getHostPort())}throw new String("No transaction for response")}}else{o.receivedResponse(s)}};f.prototype.createServer=function(o,n){return this.app.createServer(o,n,this)};f.prototype.sending=function(n,o){return(this.app.sending!==undefined?this.app.sending(n,o,this):null)};f.prototype.receivedRequest=function(n,o){this.app.receivedRequest(n,o,this)};f.prototype.receivedResponse=function(o,n){this.app.receivedResponse(o,n,this)};f.prototype.cancelled=function(n,o){this.app.cancelled(n,o,this)};f.prototype.dialogCreated=function(o,n){this.app.dialogCreated(o,n,this)};f.prototype.authenticate=function(n,o){return(this.app.authenticate!==undefined?this.app.authenticate(n,o,this):false)};f.prototype.createTimer=function(n){return this.app.createTimer(n,this)};f.prototype.resolve=function(o,n,p){return this.app.resolve(o,n,p,this)};f.prototype.findDialog=function(n){var o=(n instanceof i?g.Dialog.extractId(n):n.toString());return(this.dialogs[o]!==undefined?this.dialogs[o]:null)};f.prototype.findTransaction=function(n){return(this.transactions[n]!==undefined?this.transactions[n]:null)};f.prototype.findOtherTransaction=function(p,q){for(var o in this.transactions){var n=this.transactions[o];if(n!==q&&g.Transaction.equals(n,p,q)){return n}}return null};g.Stack=f})(sip);(function(a){a._testCreateAuthenticate=function(){assert(a.createAuthenticate("Basic",{realm:"iptel.org"})=='Basic realm="iptel.org"',"createAuthenticate('Basic', ...)");assert(a.createAuthenticate("Digest",{realm:"iptel.org",domain:"sip:iptel.org",nonce:"somenonce"})=='Digest realm="iptel.org", domain="sip:iptel.org", qop="auth", nonce="somenonce", opaque="", stale=FALSE, algorithm=MD5',"createAuthenticate('Digest', ...)")};if(a.onetime===undefined){a.onetime=""+Math.random()}a.createAuthenticate=function(e,l){if(e.toLowerCase()=="basic"){return"Basic realm="+a._quote(l&&l.realm||"")}else{if(e.toLowerCase()=="digest"){var f=["realm","domain","qop","nonce","opaque","stale","algorithm"];var j=["stale","algorithm"];var b=Math.ceil((new Date()).getTime()/1000);var h=l&&l.nonce||a.b64_encode(""+b+" "+a.MD5(""+b+":"+a.onetime));var c={realm:"",domain:"",opaque:"",stale:"FALSE",algorithm:"MD5",qop:"auth",nonce:h};var i=a.map(function(k){return[k,l&&l[k]||c[k]]},f);for(var g in l){if(f.indexOf(g)<0){i.push([g,l[g]])}}return"Digest "+a.map(function(k){return k[0]+"="+(j.indexOf(k[0])<0?a._quote(k[1]):k[1])},i).join(", ")}else{throw new String("invalid auth method "+e)}}};a._testCreateAuthorization=function(){var b={cnonce:"0a4f113b",nc:0};assert(a.createAuthorization('Digest realm="testrealm@host.com", qop="auth", nonce="dcd98b7102dd2f0e8b11d0f600bfb0c093", opaque="5ccc069c403ebaf9f0171e9517f40e41"',"Mufasa","Circle Of Life","/dir/index.html","GET",null,b)=='Digest cnonce="0a4f113b",nc=00000001,nonce="dcd98b7102dd2f0e8b11d0f600bfb0c093",opaque="5ccc069c403ebaf9f0171e9517f40e41",qop=auth,realm="testrealm@host.com",response="6629fae49393a05397450978507c4ef1",uri="/dir/index.html",username="Mufasa"','createAuthorization("Digest...")');assert(a.createAuthorization('Basic realm="WallyWorld"',"Aladdin","open sesame")=="Basic QWxhZGRpbjpvcGVuIHNlc2FtZQ==","createAuthorization('Basic...')")};a.createAuthorization=function(D,f,b,k,e,E,c){var w=a.str_partition(a.str_strip(D)," ");var h=w[0];var q=w[2];var p={};var g={username:f,password:b};if(h.toLowerCase()=="basic"){return h+" "+a.basic(g)}else{if(h.toLowerCase()=="digest"){if(q){w=q.split(",");for(var A=0;A<w.length;++A){var C=a.str_partition(a.str_strip(w[A]),"=");var x=C[0];var o=C[2];p[a.str_strip(x.toLowerCase())]=a._unquote(a.str_strip(o))}}var u=["username","realm","nonce","opaque","algorithm"];for(var z=0;z<u.length;++z){var m=u[z];if(p[m]!==undefined){g[m]=p[m]}}g.uri=k||null;g.httpMethod=e||null;if(p.qop!==undefined){var B,l;if(c&&c.cnonce!==undefined){B=c.cnonce;l=c.nc+1}else{B=a.MD5(""+Math.ceil(10000000000*Math.random()));l=1}if(c){c.cnonce=B;c.nc=l}g.qop="auth";g.cnonce=B;l=l.toString(16);if(l.length<8){l="00000000".substr(0,8-l.length)+l}g.nc=l}g.response=a.digest(g);u=["name","authMethod","value","httpMethod","entityBody","password"];var t=[];for(var r in g){if(u.indexOf(r)<0){t.push(r)}}t.sort();return h+" "+a.map(function(i){return i+"="+(i=="qop"||i=="nc"?g[i]:a._quote(g[i]))},t).join(",")}else{throw new String("Invalid auth method -- "+h)}}};a._testBasicDigest=function(){assert(a.basic({username:"Aladdin",password:"open sesame"})=="QWxhZGRpbjpvcGVuIHNlc2FtZQ==","basic()");var b={httpMethod:"GET",username:"Mufasa",password:"Circle Of Life",realm:"testrealm@host.com",algorithm:"md5",nonce:"dcd98b7102dd2f0e8b11d0f600bfb0c093",uri:"/dir/index.html",qop:"auth",nc:"00000001",cnonce:"0a4f113b",opaque:"5ccc069c403ebaf9f0171e9517f40e41"};assert(a.digest(b)=='"6629fae49393a05397450978507c4ef1"',"digest()")};a.digest=function(m){var n=m.algorithm||null;var i=m.username||null;var k=m.realm||null;var q=m.password||"";var l=m.nonce||null;var s=m.cnonce||null;var j=m.nc!==undefined?m.nc:null;var c=m.qop||null;var b=m.httpMethod||null;var g=m.uri||null;var f=m.entityBody||null;var p=function(t){return a.MD5(t)};var r=function(t,u){return a.MD5(t+":"+u)};var h,e;if(n&&n.toLowerCase()=="md5-sess"){h=p(i+":"+k+":"+q)+":"+l+":"+s}else{h=i+":"+k+":"+q}if(!c||c=="auth"){e=b+":"+g.toString()}else{e=b+":"+g.toString()+":"+p(f&&f.toString()||"")}if(c&&(c=="auth"||c=="auth-int")){var o=l+":"+j.toString()+":"+s+":"+c+":"+e;return a._quote(r(p(h),l+":"+j.toString()+":"+s+":"+c+":"+p(e)))}else{return a._quote(r(p(h),l+":"+p(e)))}};a.basic=function(b){return a.b64_encode(b.username+":"+b.password)}})(sip);(function(a){a._testSDP=function(){var g="v=0\r\no=jdoe 2890844526 2890842807 IN IP4 10.47.16.5\r\ns=SDP Seminar\r\ni=A Seminar on the session description protocol\r\nu=http://www.example.com/seminars/sdp.pdf\r\ne=j.doe@example.com (Jane Doe)\r\nc=IN IP4 224.2.17.12/127\r\nt=2873397496 2873404696\r\na=recvonly\r\nm=audio 49170 RTP/AVP 0\r\nm=video 51372 RTP/AVP 99\r\na=rtpmap:99 h263-1998/90000\r\n";assert((new a.SDP(g)).toString()==g,"SDP")};function f(g){if(g){this._parse(g)}}f._multiple="tramb";function e(g){if(g&&typeof g=="string"){var h=g.split(" ");this.username=h[0];this.sessionid=parseInt(h[1]);this.version=parseInt(h[2]);this.nettype=h[3];this.addrtype=h[4];this.address=h[5]}else{this.username="-";this.sessionid=Math.ceil((new Date()).getTime()/1000);this.version=Math.ceil((new Date()).getTime()/1000);this.nettype="IN";this.addrtype="IP4";this.address=(g&&g.address!==undefined?g.address:"127.0.0.1")}}e.prototype.toString=function(){return[this.username,this.sessionid.toString(),this.version.toString(),this.nettype,this.addrtype,this.address].join(" ")};f.originator=e;function b(m){if(m&&typeof m=="string"){parts=m.split(" ");this.nettype=parts[0];this.addrtype=parts[1];var k=parts[2].split("/");this.address=(k.length>0?k[0]:null);this.ttl=(k.length>1?parseInt(k[1]):null);this.count=(k.length>2?parseInt(k[2]):null)}else{var h=["address",null,"nettype","IN","addrtype","IP4","ttl",null,"count",null];for(var j=0;j<h.length;j+=2){var g=h[j];var l=h[j+1];this[g]=(m&&m[g]!==undefined?m[g]:l)}}}b.prototype.toString=function(){return this.nettype+" "+this.addrtype+" "+this.address+(this.ttl===null?"":"/"+this.ttl)+(this.count===null?"":"/"+this.count)};f.connection=b;function c(k){if(k&&typeof k=="string"){var l=k.split(" ");this.media=l.shift();this.port=parseInt(l.shift());this.proto=l.shift();this.fmt=[];for(var h=0;h<l.length;++h){var j=l[h];var g={};if(j.match(/^\d+$/)){g.pt=parseInt(j)}else{g.pt=j}this.fmt.push(g)}}else{this.media=(k&&k.media!==undefined?k.media:null);this.port=(k&&k.port!==undefined?k.port:0);this.proto=(k&&k.proto!==undefined?k.proto:"RTP/AVP");this.fmt=(k&&k.fmt!==undefined?k.fmt:[])}}c.prototype.toString=function(){var s=this.media+" "+this.port+" "+this.proto+" "+a.map(function(i){return i.pt.toString()},this.fmt).join(" ");var q=["i","c","b","k","a"];for(var n=0;n<q.length;++n){var h=q[n];if(this[h]!==undefined){var p=this[h];if(f._multiple.indexOf(h)<0){s+="\r\n"+h+"="+p.toString()}else{for(var m=0;m<p.length;++m){var r=p[m];s+="\r\n"+h+"="+r.toString()}}}}for(var g=0;g<this.fmt.length;++g){var o=this.fmt[g];if(o.name!==undefined){s+="\r\na=rtpmap:"+o.pt+" "+o.name+"/"+o.rate+(o.params?"/"+o.params:"")}}return s};c.prototype.dup=function(){var g=new f.media({media:this.media,port:this.port,proto:this.proto,fmt:a.map(function(i){return{pt:i.pt,name:i.name,rate:i.rate,params:i.params}},this.fmt)});var j=["i","c","b","k","a"];for(var l=0;l<j.length;++l){var h=j[l];if(this[h]!==undefined){var m=this[h];if(a.is_array(m)){g[h]=m.slice()}else{g[h]=m}}}return g};f.media=c;f.prototype._parse=function(q){var y=true;var l=q.replace(/\r\n/g,"\n").split("\n");var p=null;for(var x=0;x<l.length;++x){var n=l[x];var t=a.str_partition(n,"=");var u=t[0];var o=t[2];if(u=="o"){o=new f.originator(o)}else{if(u=="c"){o=new f.connection(o)}else{if(u=="m"){o=new f.media(o)}}}if(u=="m"){if(this["m"]===undefined){this["m"]=[]}this["m"].push(o);p=this["m"][this["m"].length-1]}else{if(this["m"]!==undefined){p=this["m"][this["m"].length-1];if(u=="a"&&o.substr(0,7)=="rtpmap:"){var h=o.substr(7).split(" ");var s=h.shift();var r=h.join(" ");h=a.str_partition(r,"/");var C=h[0];r=h[2];h=a.str_partition(r,"/");var B=h[0];var A=h[2];var m=a.filter(function(g){return g.pt.toString()==s.toString()},p.fmt);for(var w=0;w<m.length;++w){var z=m[w];z.name=C;z.rate=parseInt(B);z.params=A||null}}else{if(f._multiple.indexOf(u)>=0){if(p[u]!==undefined){p[u].push(o)}else{p[u]=[o]}}else{p[u]=o}}}else{p=this;if(f._multiple.indexOf(u)>=0){if(p[u]!==undefined){p[u].push(o)}else{p[u]=[o]}}else{p[u]=o}}}}};f.prototype.toString=function(){var g="";var n=["v","o","s","i","u","e","p","c","b","t","a","m"];for(var o=0;o<n.length;++o){var l=n[o];if(this[l]!==undefined){var p=this[l];if(f._multiple.indexOf(l)<0){g+=l+"="+p.toString()+"\r\n"}else{for(var m=0;m<p.length;++m){var h=p[m];g+=l+"="+h.toString()+"\r\n"}}}}return g};a.SDP=f})(sip);(function(a){a._testOfferAnswer=function(){var f=new a.SDP.media({media:"audio",port:9000});f.fmt=[{pt:0,name:"PCMU",rate:8000},{pt:8,name:"PCMA",rate:8000}];var e=new a.SDP.media({media:"video",port:9002});e.fmt=[{pt:31,name:"H261",rate:90000}];var c=a.createOffer([f,e]);c.o.sessionid=1192000146;c.o.version=1192000146;c.o.address="192.168.1.66";assert(c.toString().replace(/\r/g,"\\r").replace(/\n/g,"\\n")=="v=0\\r\\no=- 1192000146 1192000146 IN IP4 192.168.1.66\\r\\ns=-\\r\\nt=0 0\\r\\nm=audio 9000 RTP/AVP 0 8\\r\\na=rtpmap:0 PCMU/8000\\r\\na=rtpmap:8 PCMA/8000\\r\\nm=video 9002 RTP/AVP 31\\r\\na=rtpmap:31 H261/90000\\r\\n","createOffer()");var b=new a.SDP.media({media:"audio",port:8020});b.fmt=[{pt:0},{pt:3}];var h=a.createAnswer([b],c);h.o.sessionid=1192000146;h.o.version=1192000146;h.o.address="192.168.1.66";assert(h.toString().replace(/\r/g,"\\r").replace(/\n/g,"\\n")=="v=0\\r\\no=- 1192000146 1192000146 IN IP4 192.168.1.66\\r\\ns=-\\r\\nt=0 0\\r\\nm=audio 8020 RTP/AVP 0\\r\\na=rtpmap:0 PCMU/8000\\r\\nm=video 0 RTP/AVP 31\\r\\na=rtpmap:31 H261/90000\\r\\n","createAnswer()");var g=a.createOffer([f],c);assert(g.toString().replace(/\r/g,"\\r").replace(/\n/g,"\\n")=="v=0\\r\\no=- 1192000146 1192000147 IN IP4 192.168.1.66\\r\\ns=-\\r\\nt=0 0\\r\\nm=audio 9000 RTP/AVP 0 8\\r\\na=rtpmap:0 PCMU/8000\\r\\na=rtpmap:8 PCMA/8000\\r\\n","createOffer(revision)")};a.createOffer=function(j,g,c){var f=new a.SDP();f.v="0";if(c!==undefined){var h=["i","e","p"];for(var e=0;e<h.length;++e){var b=h[e];if(c[b]!==undefined){f[b]=c[b]}}}f.o=(g?new a.SDP.originator(g.o.toString()):new a.SDP.originator());if(g){f.o.version=f.o.version+1}f.s="-";f.t=["0 0"];f.m=j;return f};a.createAnswer=function(h,b,p){var n=new a.SDP();n.v="0";if(p!==undefined){var w=["i","e","p"];for(var t=0;t<w.length;++t){var x=w[t];if(p[x]!==undefined){n[x]=p[x]}}}n.o=new a.SDP.originator();n.s="-";n.t=b.t;n.m=[];h=h.slice();for(var r=0;r<b.m.length;++r){var v=b.m[r];var l=null;var t=0;while(t<h.length){if(h[t].media==v.media){l=h[t].dup();h.splice(t,1);var k=[];for(var g=0;g<v.fmt.length;++g){var c=v.fmt[g];for(var q=0;q<l.fmt.length;++q){var f=l.fmt[q];var e=(typeof f.pt=="number"?f.pt:-1);var u=(typeof c.pt=="number"?c.pt:-1);if(e>=0&&e<32&&u>=0&&u<32&&e==u||e<0&&u<0&&f.pt==c.pt||(""+f.name).toLowerCase()==(""+c.name).toLowerCase()&&f.rate==c.rate&&f.count==c.count){k.push([c,f]);break}}}if(k.length>0){l.fmt=a.map(function(i){return i[0]},k)}else{l.fmt=[{pt:0}];l.port=0}break}else{++t}}if(!l){l=new a.SDP.media(v.toString());l.port=0}n.m.push(l)}var o=false;for(var t=0;t<n.m.length;++t){l=n.m[t];if(l.port!=0){o=true;break}}return(o?n:null)}})(sip);(function(a){function b(f){this.app=f;this.delay=0;this.running=false;this.task=null}b.prototype.start=function(f){if(this.running){this.stop()}if(f!==undefined){this.delay=f}this.running=true;var g=this;this.task=setTimeout(function(){g.app.timedout.apply(g.app,[g])},this.delay)};b.prototype.stop=function(){if(this.running){this.running=false}if(this.task){clearTimeout(this.task);this.task=null}};a.TimerImpl=b;function c(f){this.createServer=function(i,h,g){return(i.method!="CANCEL"?new a.UserAgent(this,i):null)};this.sending=function(h,i,g){log("sending\n"+i.toString())};this.receivedRequest=function(h,i,g){log("received\n"+i.toString());f("request",h,i)};this.receivedResponse=function(i,h,g){log("received\n"+request.toString());f("response",i,h)};this.cancelled=function(h,i,g){log("cancelled");f("cancelled",h,i)};this.dialogCreated=function(i,h,g){log("dialog created")};this.authenticate=function(h,i,g){return true};this.createTimer=function(h,g){return new a.TimerImpl(h)};this.send=function(h,i,g){log("send\n"+h)}}a.App=c;function e(i,g,h,j,k,f){this.host=i||"127.0.0.1";this.port=g||(j?5061:5060);this.type=h||"udp";this.hostport=this.host+(g?":"+g:"");this.secure=j===undefined?true:j;this.reliable=k===undefined?true:k;this.congestionControlled=f===undefined?true:f}a.TransportInfo=e;a._testStack=function(){var j=new a.TransportInfo("127.0.0.1",5060,"udp",false,false,false);var h=function(){};var i=new a.App(h);var f=new a.Stack(i,j);var g=new a.UserAgent(f);g.localParty=new a.Address("sip:kundan@iptel.org");g.remoteParty=new a.Address("sip:kundan@iptel.org");g.remoteTarget=new a.URI("sip:kundan@127.0.0.1")}})(sip);

// orca/sipMsrp.js
(function(){function c(h){var f=this,g;this.comm=h;this.isIncoming=undefined;this.isDataChannelOpen=false;this.chunkManager=new e(this);this.setWrappedCall=function(i){this.addCallbacks()};this.connect=function(){var j,k,i;if(this.comm.wrappedCall){this.isIncoming=true}else{this.isIncoming=false;j=this.comm.type.toLowerCase();i=this.comm.session.callback.createCall([this.comm.to],j);this.comm.setWrappedCall(i)}this.comm.wrappedCall.getCallImp().onDataChannelOnOpen=function(){f.onDataChannelOnOpen()};this.comm.wrappedCall.getCallImp().onDataChannelOnClose=function(){f.onDataChannelOnClose()};this.comm.wrappedCall.createDataChannel();this.comm.wrappedCall.connect()};this.sendMessage=function(i){if(this.chunkManager&&this.comm.type==="Chat"&&this.isDataChannelOpen&&this.comm.status===CommStatus.CONNECTED){return this.chunkManager.send(i+"")}};this.sendFile=function(){if(this.chunkManager&&this.comm.file&&this.isDataChannelOpen&&this.comm.status===CommStatus.CONNECTED){if(this.useBlob){setTimeout(function(){f.chunkManager.send(f.comm.file)},1000)}else{var i=new FileReader();i.onload=function(){arrayBuffer=this.result;if(arrayBuffer instanceof File){console.log("this.result is File")}else{if(arrayBuffer instanceof Blob){console.log("this.result is Blob")}else{if(arrayBuffer instanceof ArrayBuffer){console.log("this.result is ArrayBuffer")}else{console.log("this.result is other")}}}console.log("Converting file to arraybuffer done.. will send it after 1sec. arrayBuffer.length:"+arrayBuffer.byteLength);setTimeout(function(){f.chunkManager.send(arrayBuffer)},1000)};console.log("Ready to send file... converting file to arraybuffer");if(f.comm.file instanceof File){console.log("self.comm.file is File")}else{if(f.comm.file instanceof Blob){console.log("self.comm.file is Blob")}else{console.log("self.comm.file is other")}}i.readAsArrayBuffer(f.comm.file)}}};this.addCallbacks=function(){var i;for(i in this.callbacks){if(this.callbacks.hasOwnProperty(i)){this.comm.wrappedCall[i]=(function(k,j){return function(){j.callbacks[k].apply(j,arguments)}})(i,this)}}};this.clean=function(){var i;if(this.chunkManager.abort()){this.chunkManager=null}};this.onDataChannelOnOpen=function(){this.isDataChannelOpen=true;this.sendFile()};this.onDataChannelOnClose=function(){this.isDataChannelOpen=false;if(this.comm.status===CommStatus.CONNECTED){this.comm.callback.onError(CommError.NETWORK_ERROR,{name:CommError.NETWORK_ERROR});this.comm.callback.disconnect()}};this.callbacks={onConnected:function(){console.log("callbacks.onConnected");if(!this.chunkManager){return}var i;this.comm.status=CommStatus.CONNECTED;if(typeof this.comm.callback.onConnected==="function"){this.comm.callback.onConnected({name:CommStatus.CONNECTED})}i=this.comm.wrappedCall.getCallImp();this.chunkManager.initSession(i);console.log("callbacks.onConnected==>sendFile()");this.sendFile()},onDisconnected:function(){this.comm.status=CommStatus.DISCONNECTED;if(typeof this.comm.callback.onDisconnected==="function"){this.comm.callback.onDisconnected({name:CommStatus.DISCONNECTED})}this.clean()},onError:function(){if(typeof this.comm.callback.onError==="function"){this.comm.callback.onError(CommError.NETWORK_ERROR,{name:CommError.NETWORK_ERROR})}this.clean()},onStatus:function(i,j){switch(i){case CallStatus.REJECTED:this.comm.status=CommStatus.DISCONNECTED;if(typeof this.comm.callback.onStatus==="function"){this.comm.callback.onStatus(CommStatus.REJECTED,{name:CommStatus.REJECTED})}this.clean();break;case CallStatus.CONNECTING:this.comm.status=CommStatus.CONNECTING;if(typeof this.comm.callback.onStatus==="function"){this.comm.callback.onStatus(CommStatus.CONNECTING,{name:CommStatus.CONNECTING})}break}},onMessage:function(i){if(this.chunkManager){this.chunkManager.onMessage(i)}}}}function e(f){var g=this;this.sipmsrp=f;this.events={onMessageReceived:function(j,i,h){console.log("ChunkManager.onMessageReceived "+j+" "+i);if(h instanceof ArrayBuffer){h=new Blob([h],{type:i})}g.sipmsrp.comm.callback.onReceived(h,{name:CommStatus.RECEIVED});if(g.sipmsrp.comm.type!=="Chat"){setTimeout(function(){console.log("MSRP file complete, now auto-disconnect.");g.sipmsrp.comm.callback.disconnect()},500)}},onMessageSent:function(h){console.log("ChunkManager.onMessageSent "+h)},onMessageDelivered:function(h){console.log("ChunkManager.onMessageDelivered "+h);g.progressEvent(h);g.sipmsrp.comm.callback.onStatus(CommStatus.SENDSUCCESS,{name:CommStatus.SENDSUCCESS,id:h});if(g.sipmsrp.comm.type!=="Chat"){setTimeout(function(){console.log("MSRP file complete, now auto-disconnect.");g.sipmsrp.comm.callback.disconnect()},5000)}},onMessageSendFailed:function(l,h,k,j){console.log("ChunkManager.onMessageSendFailed",arguments);var i={name:CommStatus.SENDFAIL,id:l};if(j&&g.sipmsrp.comm.type==="Chat"){i.content=j}g.sipmsrp.comm.callback.onStatus(CommStatus.SENDFAIL,i);if(g.sipmsrp.comm.type!=="Chat"){console.log("MSRP file failed, now auto-disconnect.");g.sipmsrp.comm.callback.disconnect()}},onFirstChunkReceived:function(l,k,h,i,j){console.log("ChunkManager.onFirstChunkReceived",arguments);if(g.sipmsrp.comm.type!=="Chat"){g.totalSize=i;g.progressEvent(l,0)}},onChunkReceived:function(i,h){console.log("ChunkManager.onChunkReceived",arguments);if(g.sipmsrp.comm.type!=="Chat"){g.progressEvent(i,h)}},onMessageReceiveAborted:function(i,h){console.log("ChunkManager.onMessageReceiveAborted "+i);if(g.sipmsrp.comm.type!=="Chat"){console.log("MSRP file aborted, now auto-disconnect.");g.sipmsrp.comm.callback.disconnect()}},onMessageReceiveTimeout:function(h){console.log("ChunkManager.onMessageReceiveTimeout "+h);if(g.sipmsrp.comm.type!=="Chat"){console.log("MSRP file timed out, now auto-disconnect.");g.sipmsrp.comm.callback.disconnect()}},onChunkSent:function(i,h){console.log("ChunkManager.onChunkSent",arguments);if(g.sipmsrp.comm.type!=="Chat"){g.progressEvent(i,h)}}};this.connection=new d(this);this.wswrapper=new a(this.connection,this.sipmsrp);this.session=new b(this.connection,undefined,undefined,this.events);this.connection.ws=this.wswrapper;this.totalSize=0;this.send=function(h){this.session.send(h)};this.onMessage=function(h){this.wswrapper.onMessage(h)};this.abort=function(h){var i;this.session.close()};this.initSession=function(h){this.session.toPath=[h.msrpToPath];this.session.localUri=new CrocMSRP.Uri(h.msrpFromPath);this.session.sessionId=h.msrpSessionId;this.connection.localSessionIds[h.msrpSessionId]=this.session};this.progressEvent=function(i,h){if(this.sipmsrp.comm.type!=="Chat"){if(h===undefined){h=this.totalSize}this.sipmsrp.comm.callback.onStatus(CommStatus.PROGRESS,{name:CommStatus.PROGRESS,id:i,progress:h,size:this.totalSize})}}}function b(h,m,k,l){this.con=h;this.config=h.config;this.sessionId=m;this.localUri=k;this.toPath=[];this.eventObj=l;this.chunkReceivers={};this.receiverCheckInterval=null;this.chunkSenders={};this.send=function(n,r){var p,o,q=this;if(n instanceof String||typeof n==="string"){console.log("Session.body is String");p=r||"text/plain"}else{if(n instanceof Blob){console.log("Session.body is Blob");p=r||n.type||"application/octet-stream"}else{console.log("Session.body is ArrayBuffer or other");p=r||"application/octet-stream"}}console.log("Create chunkSender with contentType "+p);o=new CrocMSRP.ChunkSender(this,n,p);o.onReportTimeout=g(q,o.messageId);this.con.addSender(o);this.chunkSenders[o.messageId]=o;return o.messageId};this.abortReceive=function(o){if(o){var n=this.chunkReceivers[o];if(!n){throw new RangeError("Invalid message id")}n.abort()}else{for(o in this.chunkReceivers){this.chunkReceivers[o].abort()}}};this.abortSend=function(o){if(o){var n=this.chunkSenders[o];if(!n){throw new RangeError("Invalid message id")}n.abort()}else{for(o in this.chunkSenders){this.chunkSenders[o].abort()}}};this.close=function(){this.abortReceive();this.abortSend()};this.onIncomingSend=function(y){var q,A=null,o=null,C=-1,v,t,D,p,B,x,s;var z=this.con.chunkManager.sipmsrp.comm.type;console.log("session.onIncomingSend(). session type: "+z);y.isBase64=false;if(typeof y.body==="string"){if(typeof y.contentTransferEncoding==="string"&&y.contentTransferEncoding.toLowerCase()==="base64"){y.isBase64=true}else{if((/data:.*;base64/).test(y.body)){y.isBase64=true;console.log("onIncomingSend() -- found base64")}}}if(y.byteRange.start===1&&y.contentType&&y.contentType.match(/message\/cpim/i)){CrocMSRP.parseCPIMMessage(y)}try{if(y.byteRange.start===1&&y.continuationFlag===CrocMSRP.Message.Flag.end){if(y.body){q=y.messageId||CrocMSRP.util.newMID();C=y.byteRange.total;if(y.contentDisposition&&(y.contentDisposition.type==="attachment"||y.contentDisposition.type==="render")){A=y.getHeader("content-description");o=y.contentDisposition.param.filename}t=y.body;if(y.isBase64){D=decodeURIComponent(escape(atob(t.split(",")[1])));p=t.slice(t.indexOf(":")+1,t.indexOf(";"));t=new Blob([D])}else{if(typeof t==="string"&&(z==="FileTransfer"||z==="ImageShare")){B=new ArrayBuffer(t.length);x=new Uint8Array(B);for(s=0;s<t.length;s++){x[s]=t.charCodeAt(s)}t=new Blob([B],{type:y.contentType})}}this.eventObj.onFirstChunkReceived(q,y.contentType,o,C,A);if(this.eventObj.onChunkReceived){this.eventObj.onChunkReceived(q,C)}this.eventObj.onMessageReceived(q,y.contentType,t)}}else{q=y.messageId;if(!q||!(q instanceof String||typeof q==="string")){f(y,this.con,this.localUri,CrocMSRP.Status.BAD_REQUEST);return}if(y.byteRange.start===1&&y.continuationFlag===CrocMSRP.Message.Flag.continued){v=new CrocMSRP.ChunkReceiver(y,this.config.recvBuffer);if(y.contentDisposition&&(y.contentDisposition.type==="attachment"||y.contentDisposition.type==="render")){A=y.getHeader("content-description");o=y.contentDisposition.param.filename}this.eventObj.onFirstChunkReceived(q,y.contentType,o,y.byteRange.total,A);this.chunkReceivers[q]=v;if(!this.receiverCheckInterval){var w=this;this.receiverCheckInterval=setInterval(function(){j(w)},1000)}}else{v=this.chunkReceivers[q];if(!v){f(y,this.con,this.localUri,CrocMSRP.Status.STOP_SENDING);return}if(v.firstChunk.isBase64){y.isBase64=true}if(!v.processChunk(y)){delete this.chunkReceivers[q];if(v.remoteAbort){f(y,this.con,this.localUri,CrocMSRP.Status.STOP_SENDING)}else{f(y,this.con,this.localUri,CrocMSRP.Status.STOP_SENDING)}try{this.eventObj.onMessageReceiveAborted(q,v.blob)}catch(u){console.warn("Unexpected application exception: "+u.stack)}return}}console.log("chunkReceiver.size "+v.size+". chunkReceiver.totalBytes "+v.totalBytes);if(v.isComplete()){delete this.chunkReceivers[q];var n=v.blob;if(this.eventObj.onChunkReceived){this.eventObj.onChunkReceived(q,v.size)}this.eventObj.onMessageReceived(q,n.type,n)}else{if(this.eventObj.onChunkReceived){this.eventObj.onChunkReceived(q,v.receivedBytes)}}}}catch(u){var r=CrocMSRP.Status.INTERNAL_SERVER_ERROR;if(u instanceof CrocMSRP.Exceptions.UnsupportedMedia){r=CrocMSRP.Status.UNSUPPORTED_MEDIA}else{console.warn("Unexpected application exception: "+u.stack)}f(y,this.con,this.localUri,r);return}f(y,this.con,this.localUri,CrocMSRP.Status.OK);if(y.getHeader("success-report")==="yes"){i(this,y)}};this.onIncomingReport=function(n){var q,o;q=n.messageId;if(!q){console.log("Invalid REPORT: no message id");return}o=this.chunkSenders[q];if(!o){console.log("Invalid REPORT: unknown message id");return}o.processReport(n);if(!o.isComplete()){return}delete this.chunkSenders[q];if(o.aborted&&!o.remoteAbort){return}try{if(n.status===CrocMSRP.Status.OK){if(this.eventObj.onMessageDelivered){this.eventObj.onMessageDelivered(q)}}else{this.eventObj.onMessageSendFailed(q,n.status,n.comment,o.bodyText)}}catch(p){console.warn("Unexpected application exception: "+p.stack)}};this.onIncomingResponse=function(r){var q;q=r.request.getHeader("message-id");if(!q){console.log("Can't retrieve SEND message id");return}var n=r.request.sender;if(r.status===CrocMSRP.Status.OK){try{if(!n.aborted&&this.eventObj.onChunkSent){this.eventObj.onChunkSent(q,r.request.byteRange.end)}if(r.request.continuationFlag===CrocMSRP.Message.Flag.end&&this.eventObj.onMessageSent){this.eventObj.onMessageSent(q)}}catch(p){console.warn("Unexpected application exception: "+p.stack)}}else{var o=undefined;if(this.chunkSenders[q]){o=this.chunkSenders[q].bodyText}n.abort();n.remoteAbort=true;delete this.chunkSenders[q];try{this.eventObj.onMessageSendFailed(q,r.status,r.comment,o)}catch(p){console.warn("Unexpected application exception: "+p.stack)}}};function g(o,n){return function(){var p=undefined;if(o.chunkSenders[n]){p=o.chunkSenders[n].bodyText}delete o.chunkSenders[n];try{o.eventObj.onMessageSendFailed(n,CrocMSRP.Status.REQUEST_TIMEOUT,"Report Timeout",p)}catch(q){console.warn("Unexpected application exception: "+q.stack)}}}function f(q,o,p,n){if(n===CrocMSRP.Status.OK){if(!q.responseOn.success){return}}else{if(!q.responseOn.failure){return}}o.ws.send(new CrocMSRP.Message.OutgoingResponse(q,p,n))}function i(s,r){var o;o=new CrocMSRP.Message.OutgoingRequest(s,"REPORT");o.addHeader("message-id",r.messageId);o.addHeader("status","000 200 OK");if(r.byteRange||r.continuationFlag===CrocMSRP.Message.Flag.continued){var t=1,n,q=-1;if(r.byteRange){t=r.byteRange.start;q=r.byteRange.total}if(!r.body){n=0}else{if(r.body instanceof ArrayBuffer){console.log("sendReport. req.body is ArrayBuffer");n=t+r.body.byteLength-1}else{if(r.isBase64){console.log("sendReport. req.body is base64");n=t+r.body.length-1}else{console.log("sendReport. req.body is String");var p=new Blob([r.body]);n=t+p.size-1}}}if(n!==r.byteRange.end){console.warn("Report Byte-Range end does not match request. end:"+n+",req.byteRange.end:"+r.byteRange.end)}o.byteRange={start:t,end:n,total:q}}s.con.ws.send(o)}function j(s){var r,p,n=new Date().getTime(),o=s.config.chunkTimeout;for(r in s.chunkReceivers){p=s.chunkReceivers[r];console.log("now: "+n+", lastReceive: "+p.lastReceive+", timeout: "+o);if(n-p.lastReceive>o){p.abort();delete s.chunkReceivers[r];try{s.eventObj.onMessageReceiveTimeout(r,p.blob)}catch(q){console.warn("Unexpected application exception: "+q.stack)}}}if(CrocMSRP.util.isEmpty(s.chunkReceivers)){clearInterval(s.receiverCheckInterval);s.receiverCheckInterval=null}}}function d(j){this.chunkManager=j;this.config=new CrocMSRP.ConnectionConfig();this.ws=null;this.localSessionIds={};this.reconnectTimer=null;this.reducedChunkSize=512;this.bandwidthDelay=200;this.bandwidthRetries=5;this.ramp=2;this.activeSenders=[];this.outstandingSends=0;this.onMsrpRequest=function(l){var k,m;if(l.toPath.length!==1){g(l,this,l.toPath[0],CrocMSRP.Status.SESSION_DOES_NOT_EXIST);return}k=new CrocMSRP.Uri(l.toPath[0]);if(!k){g(l,this,l.toPath[0],CrocMSRP.Status.BAD_REQUEST);return}m=this.localSessionIds[k.sessionId];if(!m||!(m.localUri.authority===k.authority)||!(m.localUri.port===k.port)||!(m.localUri.sessionId===k.sessionId)){g(l,this,l.toPath[0],CrocMSRP.Status.SESSION_DOES_NOT_EXIST);return}switch(l.method){case"SEND":m.onIncomingSend(l);break;case"REPORT":m.onIncomingReport(l);break;default:g(l,this,l.toPath[0],CrocMSRP.Status.NOT_IMPLEMENTED);return}};this.addSender=function(k){this.activeSenders.push(k);h(this)};this.onMsrpResponse=function(k){if(k.request.method==="SEND"){this.outstandingSends--}k.request.session.onIncomingResponse(k);h(this)};function g(n,l,m,k){if(k===CrocMSRP.Status.OK){if(!n.responseOn.success){return}}else{if(!n.responseOn.failure){return}}l.ws.send(new CrocMSRP.Message.OutgoingResponse(n,m,k))}function h(l,n){var o,q,p,k,m;if(!n){n=0}while(l.activeSenders.length>0&&l.outstandingSends<l.config.maxOutstandingSends&&n<l.ramp){o=l.activeSenders[0];if(o.aborted&&o.remoteAbort){l.activeSenders.shift()}l.outstandingSends++;n++;l.chunkManager.totalSize=o.size;q=o.getNextChunk();p=l.ws.send(q);if(p===true||o.aborted){f(l,o)}else{if(p==="BlobForbidden"&&q.byteRange.start===1){i(o,function(r){var t,s;console.log("sendRequests: Trying again with base64 data");l.chunkManager.totalSize=r.size;t=r.getNextChunk();s=l.ws.send(t);if(s==="OtherError"){r.config.chunkSize=l.reducedChunkSize;r.session.config.chunkSize=l.reducedChunkSize;i(r,function(u){console.log("sendRequests: Trying again with reduced chunk size");var v=u.getNextChunk();l.ws.send(v);f(l,u);h(l,n)});return}if(s!==true){console.warn("Unexpected result from WSWrapper.send: "+s)}f(l,r);h(l,n)});return}if(p==="OtherError"){k=0;m=setInterval(function(){k+=1;if(l.ws.send(q)!=="OtherError"||k>=l.bandwidthRetries){clearInterval(m);f(l,o);h(l,n);return}},l.bandwidthDelay);return}console.warn("Unexpected result from WSWrapper.send: "+p);f(l,o)}}}function f(k,l){if(l.isSendComplete()){k.activeSenders.shift()}else{if(k.activeSenders.length>1){k.activeSenders.push(k.activeSenders.shift())}}}function i(l,m){l.sentBytes=0;l.ackedBytes=0;l.incontiguousReports={};l.incontiguousReportCount=0;l.reportTimer=null;l.aborted=false;l.remoteAbort=false;l.getNextChunk=function(){var o;o=new CrocMSRP.Message.OutgoingRequest(this.session,"SEND");o.sender=this;o.addHeader("message-id",this.messageId);o.addHeader("success-report","yes");o.addHeader("failure-report","yes");if(this.aborted){o.continuationFlag=CrocMSRP.Message.Flag.abort}else{var q=this.sentBytes+1,n=Math.min(this.sentBytes+this.config.chunkSize,this.size);o.byteRange={start:q,end:n,total:this.size};if(this.size>0){if(this.sentBytes===0){if(this.disposition){o.addHeader("content-disposition",this.disposition)}else{o.addHeader("content-disposition","inline")}if(this.description){o.addHeader("content-description",this.description)}if(typeof this.bodyText!=="string"){o.addHeader("content-transfer-encoding","base64")}}o.contentType=this.contentType;console.debug("Slicing the blob for next chunk at from "+this.sentBytes+"-"+n);o.body=this.blob.slice(this.sentBytes,n)}if(n<this.size){o.continuationFlag=CrocMSRP.Message.Flag.continued}else{if(this.onReportTimeout){var p=this;this.reportTimer=setTimeout(function(){p.onReportTimeout();p.reportTimer=null},this.config.reportTimeout)}}this.sentBytes=n}return o};if(typeof l.bodyText==="string"&&!(/.*[\u4e00-\u9fa5]+.*$/.test(l.bodyText))){l.blob=l.bodyText;l.size=l.blob.length;m(l)}else{if(typeof l.blob==="string"&&!(/.*[\u4e00-\u9fa5]+.*$/.test(l.blob))){l.size=l.blob.length;m(l)}else{var k=new window.FileReader();k.readAsDataURL(l.blob);k.onload=function(n){l.blob=n.target.result;l.size=l.blob.length;if(typeof m==="function"){m(l)}}}}}}function a(g,f){this.con=g;this.sipmsrp=f;this.transactions={};this.msrpBuffer="";this.send=function(l,i){var k=this,o,m,j;if(l instanceof CrocMSRP.Message.Request&&l.method!=="REPORT"){}if(i){o=i}else{o=l.encode();m=window.cordova;if(m&&m.plugins&&m.plugins.iosrtc&&o instanceof Blob){console.log("iosrtc plugin does not allow send Blob. convert to ArrayBuffer.");j=new FileReader();j.onload=function(){k.send(l,this.result)};j.readAsArrayBuffer(o);return true}}try{this.sipmsrp.comm.wrappedCall.sendMessage(o);if(l.method=="SEND"){l.timer=setTimeout(function(){h(k,l)},30000);this.transactions[l.tid]=l;console.debug("Timer for transaction '"+l.tid+"' set")}}catch(n){console.log("Could not send through DataChannel. Error: "+n);if(n.toString().indexOf("Blob")>-1){return"BlobForbidden"}else{return"OtherError"}}return true};this.onMessage=function(n){this.msrpBuffer=this.msrpBuffer+n;while(this.msrpBuffer!=""){var k,j,l,i,m;k=this.msrpBuffer.indexOf("\r\n");if(k<=0){console.debug("partial MSRP message-no first line: this.msrpBuffer does not have 1st MSRP line yet.. wait for more data:'"+this.msrpBuffer+"'this.msrpBuffer.length: "+this.msrpBuffer.length+"orcaDataChannel index:"+this.msrpBuffer.indexOf("orcaDataChannel"));if(this.msrpBuffer.length==27){console.debug("Ignoring 'orcaDataChannel' MSRP chunk!!");this.msrpBuffer=""}return}j=this.msrpBuffer.substring(0,k);l=j.split(" ");if(l.length<3||l[0]!=="MSRP"||l[1].length===0||l[2].length===0){console.log("Error parsing message: unexpected first line format: "+j);return}m=l[1];i=this.msrpBuffer.indexOf("-------"+m);console.debug("chunkEndIndex: "+i);if(i<0){console.debug("partial MSRP message: End of chunk NOT found for transaction "+m+" wait for more data");return}i=i+m.length+10;n=this.msrpBuffer.substring(0,i);this.msrpBuffer=this.msrpBuffer.substring(i);if(n.length>0){console.debug("processing new MSRP chunk "+n)}if(this.msrpBuffer.length>0){console.debug("partial MSRP msg remaining in this.msrpBuffer '"+this.msrpBuffer+"'")}var n=CrocMSRP.parseMessage(n);if(!n){console.warn("Parsing error on incoming message. Ignoring message.");return}if(n instanceof CrocMSRP.Message.Response){n.request=this.transactions[n.tid];if(n.request){console.debug("Clearing timeout for transaction '"+n.tid+"'");clearTimeout(n.request.timer);delete n.request.timer;delete this.transactions[n.tid];this.con.onMsrpResponse(n)}else{console.log("Unexpected response received; not in transaction list")}return}this.con.onMsrpRequest(n)}};function h(i,j){console.error("timeout happened for transaction request.tid: "+j.tid);delete j.timer;delete i.transactions[j.tid];var k=new CrocMSRP.Message.IncomingResponse(j.tid,408,CrocMSRP.StatusComment[408]);k.request=j;i.con.onMsrpResponse(k)}}orcaALU.SipMsrp=c;if(orcaALU.SipAdapter){orcaALU.SipAdapter.Msrp=orcaALU.SipMsrp}})();

// orca/sipAdapter.js
(function(){function d(e,h,g,f,j){this.Msrp=orcaALU.SipMsrp;this.stack=undefined;this.uaReg=null;this.transport="ws";this.userAgent="ALU ORCA Agent ";if(typeof orcaVersion!=="undefined"){this.userAgent+=orcaVersion}var i=navigator.userAgent.match(/(Firefox|Chrome)\/(\d|\.)+/);if(i&&i.length>=2){this.userAgent=this.userAgent+" "+i[0]}this.listenIp="r"+Math.floor(Math.random()*10000000000)+".invalid";this.listenPort=0;this.instanceId=undefined;this.sessionExpires=isNaN(f.providerConfig.expires)?600:parseInt(f.providerConfig.expires);this.refreshInProgress=false;this.refresh_timer=0;this.timeouts_allowed=1;this.presenceExpires=300;this.presenceRefreshTimer=undefined;this.presenceEtag=undefined;this.presencePendingUpdates=[];this.localAOR=h;this.session=j;this.config=f;this.token=g;this.ws=e;this.updateToken=function(k){console.debug("sipAdapter.updateToken"+g);this.token.key=k};this.setSessionStatus=function(k){console.debug("setSessionStatus() session status -> "+k);this.session.setSessionStatus(k)};this.createSession=function(){if(!this.stack){this.createStack()}if(this.session.ws_only){console.log("Setting status to connected for ws only session");this.setSessionStatus(SessionStatus.CONNECTED)}else{this.register();this.setSessionStatus(SessionStatus.CONNECTING)}};this.terminateSession=function(){this.unregister()};this.createCallSession=function(m,l,k,n){console.debug("createCallSession() dest: "+l);if(this.session.sessionStatus!==SessionStatus.CONNECTED){console.error("sessionStatus is: "+this.session.sessionStatus);m.clean();return}this.createAndSendInviteRequest(m,l,k)};this.acceptCallSession=function(l,k){this.sendResponse(l,200,"OK",k)};this.rejectCallSession=function(l,m,k){if(m&&k){this.sendResponse(l,m,k)}else{this.sendResponse(l,480,"Temporarily Unavailable")}};this.cancelCallSession=function(k){this.cancel(k)};this.terminateCallSession=function(k){this.bye(k)};this.cleanCallSession=function(k){console.debug("cleanCallSession()");if(k.uaCall!==null){if(k.uaCall instanceof sip.Dialog){k.uaCall.close()}k.uaCall=null}};this.sendResponse=function(m,n,l,k){console.debug("sendResponse(): "+n+" "+l);if(n===200){this.sendInviteResponse(m,n,l,k)}else{this.sendInviteResponse(m,n,l)}};this.createStack=function(){console.debug("Session.createStack()");var k=new sip.TransportInfo(this.listenIp,this.listenPort,this.transport,false,true,true);this.stack=new sip.Stack(this,k)};this.register=function(){var n,p;if(!this.stack){this.createStack()}console.debug("Session.register()");this.uaReg=new sip.UserAgent(this.stack,undefined,undefined,this.config.providerConfig.breaker);this.uaReg.localParty=new sip.Address(this.localAOR);this.uaReg.remoteParty=new sip.Address(this.localAOR);n=this.getRouteHeader();n.value.uri.param.transport=this.transport;p=this.createRegister();p.setItem("Expires",new sip.Header(this.sessionExpires.toString(),"Expires"));p.setItem("User-Agent",new sip.Header(this.userAgent,"User-Agent"));console.log("userId = "+h);console.log("token.id = "+g.id);if(this.token.authtype=="SSO-Auth"){var o=this.token.key;var m=o.authorizationHeader;var q=o.pAccessNetworkInfoHeader;console.log("authorizationHeader = "+m);console.log("pAccessNetworkInfoHeader = "+q);p.setItem("Authorization",new sip.Header(m,"Authorization"));if(q){p.setItem("P-Access-Network-Info",new sip.Header(q,"P-Access-Network-Info"))}}else{if((this.session.autoAnswerTimer)||(this.config.providerConfig.sendAuthOnInitReg)){var l={username:'"'+g.id+'"',uri:'"sip:'+h.slice(h.indexOf("@")+1)+'"',realm:'"'+h.slice(h.indexOf("@")+1)+'"',nonce:'""',response:'""'};p.setItem("Authorization",new sip.Header("Digest username="+l.username+",realm="+l.realm+",uri="+l.uri+",nonce="+l.nonce+",response="+l.response+",algorithm=MD5","Authorization"))}}this.uaReg.sendRequest(p);if(this.config.providerConfig.registerResponseTime>0){var k=this;this.registerResponseTimer=setTimeout(function(){k.registerTimeout()},this.config.providerConfig.registerResponseTime*1000)}};this.register_refresh=function(){var n,p;console.debug("["+new Date().toUTCString()+"] Session.register_refresh()");p=this.createRegister();p.setItem("Expires",new sip.Header(this.sessionExpires.toString(),"Expires"));p.setItem("User-Agent",new sip.Header(this.userAgent,"User-Agent"));if(this.config.providerConfig.reUseCallidInReregDereg){p.setItem("Call-ID",new sip.Header(this.savedCallId.toString(),"Call-ID"))}if(this.token.authtype=="SSO-Auth"){var o=this.token.key;var m=o.authorizationHeader;var q=o.pAccessNetworkInfoHeader;console.log("authorizationHeader = "+m);console.log("pAccessNetworkInfoHeader = "+q);p.setItem("Authorization",new sip.Header(m,"Authorization"));if(q){p.setItem("P-Access-Network-Info",new sip.Header(q,"P-Access-Network-Info"))}}else{if((this.session.needAuthOnReRegister)||(this.config.providerConfig.sendAuthOnReregDereg)){var l={username:'"'+g.id+'"',uri:'"sip:'+h.slice(h.indexOf("@")+1)+'"',realm:'"'+h.slice(h.indexOf("@")+1)+'"',nonce:'""',response:'""'};p.setItem("Authorization",new sip.Header("Digest username="+l.username+",realm="+l.realm+",uri="+l.uri+",nonce="+l.nonce+",response="+l.response,"Authorization"))}}this.uaReg.sendRequest(p);this.refreshInProgress=true;if(this.config.providerConfig.registerResponseTime>0){var k=this;this.registerResponseTimer=setTimeout(function(){k.registerTimeout()},this.config.providerConfig.registerResponseTime*1000)}if(this.session.mdsp.isFeatureEnabled()){this.session.mdsp.logContacts("at end register_refresh",true)}};this.registerTimeout=function(){if(this.session.socketStatus==this.session.WebSocketStatus.CONNECTED){console.log("Registration response timeout");this.session.onWebSocketError();this.session.closePending=true;this.ws.close()}else{console.log("Ignoring registration timeout because ws connection is already disconnected ")}};this.unregister=function(){console.debug("Session.unregister()");clearTimeout(this.presenceRefreshTimer);this.sendUpdatePresence("",false,false,true);var n=this.createRegister();n.setItem("Expires",new sip.Header("0","Expires"));n.setItem("User-Agent",new sip.Header(this.userAgent,"User-Agent"));if(this.config.providerConfig.reUseCallidInReregDereg){n.setItem("Call-ID",new sip.Header(this.savedCallId.toString(),"Call-ID"))}if(this.token.authtype=="SSO-Auth"){var m=this.token.key;var l=m.authorizationHeader;var o=m.pAccessNetworkInfoHeader;console.log("authorizationHeader = "+l);console.log("pAccessNetworkInfoHeader = "+o);n.setItem("Authorization",new sip.Header(l,"Authorization"));if(o){n.setItem("P-Access-Network-Info",new sip.Header(o,"P-Access-Network-Info"))}}else{if(this.config.providerConfig.sendAuthOnReregDereg){var k={username:'"'+g.id+'"',uri:'"sip:'+h.slice(h.indexOf("@")+1)+'"',realm:'"'+h.slice(h.indexOf("@")+1)+'"',nonce:'""',response:'""'};n.setItem("Authorization",new sip.Header("Digest username="+k.username+",realm="+k.realm+",uri="+k.uri+",nonce="+k.nonce+",response="+k.response,"Authorization"))}}this.uaReg.sendRequest(n);if(this.refresh_timer){clearTimeout(this.refresh_timer)}this.savedCallId=undefined};this.createContactHeader=function(k){var m;console.debug("adapter.createContactHeader()");if(k=="REGISTER"){m=new sip.Header(this.stack.uri.toString(),"Contact");m.setItem("reg-id","1");this.createInstanceId()}else{m=new sip.Header((new sip.Address(this.localAOR)).uri.toString(),"Contact")}m.value.uri.user=this.getUsername(this.localAOR);m.value.displayName=this.token.displayName;if(this.config.providerConfig.breaker){m.value.uri.param.transport="ws";m.value.uri.param["rtcweb-breaker"]="yes"}if((k=="REGISTER")||(this.session.mdsp.isFeatureEnabled())){m.setItem("+sip.instance",this.instanceId)}if(this.session.mdsp.isFeatureEnabled()){var l=this.session.mdsp.getSecDeviceId();if(l!=""){m.setItem(l)}if(this.session.mdsp.myOwnGruu!=""){m.value.uri.param.gr=this.session.mdsp.myOwnGruu}}return m};this.createRegister=function(){var k,l;console.debug("Session.createRegister()");k=this.uaReg.createRequest("REGISTER");l=this.createContactHeader("REGISTER");k.setItem("Supported",new sip.Header("path, gruu","Supported"));k.setItem("Contact",l);if(this.token.authtype=="Token-Auth"){console.debug("token.authtype: Token-Auth, token.key: "+this.token.key);k.setItem("X-ALU-Authorization",new sip.Header('access-token="'+this.token.key+'"',"X-ALU-Authorization"))}return k};this.getUsername=function(o){var n,m,l,k;n=o.split("<")[1];if(n===undefined){n=o}m=n.split(">")[0];if(m===undefined){m=n}l=m.split(":")[1];if(l===undefined){l=m}k=l.split("@")[0];if(k===undefined){k=l}return k};this.getRouteHeader=function(l){var k=this.config.uri.split("/")[2].trim()+";transport="+this.transport;return new sip.Header("<sip:"+(l?l+"@":"")+k+";lr>","Route")};this.createUUID4=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(m){var l=Math.random()*16|0,k=m==="x"?l:(l&3|8);return k.toString(16)})};this.createInstanceId=function(){if(!this.instanceId&&localStorage!=="undefined"){this.instanceId=localStorage.getItem("instance_id_"+this.token.id);if(!this.instanceId){this.instanceId="<urn:uuid:"+this.createUUID4()+">";localStorage.setItem("instance_id_"+this.token.id,this.instanceId);console.debug("New instanceId generated = "+this.instanceId)}else{console.debug("Existing instanceId from localStorage = "+this.instanceId)}}if(this.session.mdsp.myOwnGruu==""){this.session.mdsp.myOwnGruu=this.instanceId.substring(1,this.instanceId.length-1)}};this.createTimer=function(l,k){return new sip.TimerImpl(l)};this.debug=function(k){console.debug("[SIP] "+k)};this.send=function(m,o,k){var l="=> "+o[0]+":"+o[1]+"\n"+m;console.debug("["+new Date().toUTCString()+"] Session.send() message "+l);try{this.ws.send(m,o[0],o[1])}catch(n){this.ws.send(m)}};this.received=function(k){console.debug("\n["+new Date().toUTCString()+"] sipAdapter.received()\n");this.stack.received(k,["127.0.0.1",0])};this.receivedResponse=function(n,m,l){console.debug("\n["+new Date().toUTCString()+"] sipAdapter.receivedResponse()");var r,p,o;r=n.request.method;if(r==="REGISTER"){this.receivedRegisterResponse(n,m)}else{if(r==="MESSAGE"){if(n.request.getItem("Content-Type").value==="message/cpim"){console.info("ua.request.body: "+n.request.body);var k=this.parseGetMessageBody(n.request.body);var q=this.parseGetMessageContentType(n.request.body).trim();console.log("message body: "+k);console.log("bodyContentType:"+q);if(q.trim()==="message/imdn+xml"){this.receivedSmsIMDNMessageResponse(n,m)}else{this.receivedSmsMessageResponse(n,m)}}else{this.receivedPageModeMessageResponse(n,m)}}else{if(r==="PUBLISH"){this.receivedUpdatePresenceResponse(n,m)}else{if(r==="SUBSCRIBE"){if(n.request._headers.event.value=="dialog"){this.receivedSubscribeDialogResponse(n,m)}else{if(n.request._headers.event.value=="presence"){this.receivedSubscribePresenceResponse(n,m)}}}else{p=m.getItem("call-id").value;o=this.session.getCall(p);if(o===null||o.uaCall.callId!==n.callId){console.warn("Session.ReceivedResponse() Receive a SIP response for a unknow call. Ignore it.");return}if(r==="INVITE"){this.receivedInviteResponse(o,n,m)}else{if(r==="BYE"){o.terminatedCallSessionEvent({name:CallStatus.DISCONNECTED})}else{if(r==="CANCEL"){o.terminatedCallSessionEvent({name:CallStatus.DISCONNECTED})}else{console.warn("Session.receivedResponse() Ignoring SIP response for method="+r)}}}}}}}};this.receivedRequest=function(m,n,q){console.debug("\n["+new Date().toUTCString()+"] sipAdapter.receivedRequest()");var o,s,k;k=n.method;if(k==="INVITE"){this.receivedInvite(m,n)}else{if(k==="BYE"){this.receivedBye(m,n)}else{if(k==="ACK"){this.receivedAck(m,n)}else{if(k==="INFO"){this.receivedInfo(m,n)}else{if(k==="NOTIFY"){var l=n.getItem("event").value;if(l=="presence"){this.receivedPresenceNotify(m,n)}else{if(l=="dialog"){this.receivedDialogNotify(m,n)}else{this.receivedNotify(m,n)}}}else{if(k==="MESSAGE"){var r=n.getItem("Content-Type").value;if(r=="message/cpim"){var p=this.parseGetMessageContentType(n.body);console.info("received request bodyContentType: "+p);if(p.trim()==="message/imdn+xml"){this.receivedSmsIMDNMessage(m,n)}else{this.receivedSmsMessage(m,n)}}else{this.receivedPageModeChatMessage(m,n)}}else{console.warn("Session.receivedRequest() ignoring received request [method= "+k+", callID = "+n.getItem("call-id").value+"]");if(k!=="ACK"){m.sendResponse(m.createResponse(501,"Not Implemented"))}}}}}}}};this.receivedRegisterResponse=function(l,m){console.debug("\n["+new Date().toUTCString()+"] sipAdapter.receivedRegisterResponse() ua="+l);if(m.response!=408){console.log("Clearing registration response timer");clearTimeout(this.registerResponseTimer)}var k,q,r,n,o,p;if(m.isfinal()){if(m.is2xx()){if(this.session.sessionStatus===SessionStatus.CONNECTING||this.refreshInProgress){if(!this.savedCallId){if(m.hasItem("call-id")){this.savedCallId=m.getItem("call-id").value;console.debug("Saving initial register call id = "+this.savedCallId)}}if(this.refreshInProgress){this.refreshInProgress=false;console.debug("Register refresh completed successfully");if(this.session.sessionStatus!=SessionStatus.CONNECTED){console.debug("Setting session status to connected");this.setSessionStatus(SessionStatus.CONNECTED)}}else{this.setSessionStatus(SessionStatus.CONNECTED)}if(m.hasItem("expires").value){q=parseInt(m.getItem("expires").value)}else{p=m.getItem("contact");if(p instanceof Array){q=this.sessionExpires;for(o=0;o<p.length;o+=1){if(p[o]["+sip.instance"]===this.instanceId){q=parseInt(p[o].expires);break}}}else{q=parseInt(p.expires)}}console.debug("i_expires = "+q);if(q>0){if(q>1200){r=q-600}else{r=q/2}if(this.config.providerConfig.registerRefreshTime>0){r=this.config.providerConfig.registerRefreshTime}console.debug("refresh_time = "+r);var s=this;this.refresh_timer=setTimeout(function(){s.register_refresh()},r*1000)}else{console.debug("invalid i_expires = "+q);return}}else{if(this.session.sessionStatus===SessionStatus.CONNECTED){this.setSessionStatus(SessionStatus.DISCONNECTED);this.ws.close()}else{console.warn("Session.receivedRegisterResponse() Ignore SIP REGISTER response (session status = "+this.session.sessionStatus+")")}}if(this.session.mdsp.isFeatureEnabled()){this.processMDSPContactHeaders(m)}}else{console.debug("Session.receivedRegisterResponse() failed response = "+m.response+" "+m.responsetext);if(m.response==423){n=m.getItem("min-expires").value;this.sessionExpires=n;console.debug("Re-trying register with expires = "+n);this.register();return}if(m.response==408){if(this.timeouts_allowed>0){this.session.timeouts_allowed--;return}}if(m.response==403){if(this.token.authtype==="SSO-Auth"){console.debug("receive 403 response and authtype is SSO Auth, set sessionStatus to AUTHENTICATING");this.setSessionStatus(SessionStatus.AUTHENTICATING);return}}if(this.session.sessionStatus===SessionStatus.AUTHENTICATING){console.debug("sessionStatus == SessionStatus.AUTHENTICATING, don't set SessionError.AUTHENTICATION_FAILED")}else{this.setSessionStatus(SessionStatus.DISCONNECTED,SessionError.AUTHENTICATION_FAILED)}}}};this.processMDSPContactHeaders=function(n){console.debug("sipAdapter.processMDSPContactHeaders()\n");var p;var k;var l;var v;var x;var m=false;var t=n.getItem("contact");var r=[];if((t instanceof Array)==false){r.push(t)}else{console.debug("array of Contact Headers found.\n");r=t}for(p=0;p<r.length;++p){k="";l="";v="";x=false;if(r[p].value.displayName!=undefined){console.debug("contact["+p+"].displayName = "+r[p].value.displayName);v=r[p].value.displayName}if(r[p]["pub-gruu"]!=undefined){k=this.getGruuFromPubGruu(r[p]["pub-gruu"]);l=this.getSipUriFromPubGruu(r[p]["pub-gruu"]);console.debug("contact["+p+"].pub-gruu = "+r[p]["pub-gruu"]);this.session.mdsp.setGRUUsupport(true)}else{if(r[p]["+sip.instance"]!=undefined){var o=r[p]["+sip.instance"];console.debug("contact["+p+"].+sip.instance = "+o);if((r[p].value.uri.scheme!=undefined)&&(r[p].value.uri.user!=undefined)&&(r[p].value.uri.host!=undefined)){var y=r[p].value.uri.scheme;var w=r[p].value.uri.user;var q=r[p].value.uri.host;l=y+":"+w+"@"+q;if(r[p].value.uri.port!=undefined){l=l+":"+r[p].value.uri.port.toString()}console.debug("contact["+p+"].(constructed sipUri) = "+l)}k=o.substring(1,o.length-1);console.debug("contact["+p+"].(constructed gruu) = "+k);this.session.mdsp.setGRUUsupport(false)}else{console.debug("contact["+p+"] bears neither pub-gruu nor +sip.instance.\n");continue}}if((r[p]["+g.gsma.rcs.ipcall"]!=undefined)||((r[p].mobility!=undefined)&&(r[p].mobility=="fixed"))){x=true}if(this.session.mdsp.addContact(k,l,v,x)){m=true}}if(m){setTimeout(this.session.mdsp.subscribeToMDSPContactDialogs.bind(this.session.mdsp),2000);this.session.mdsp.onContactsUpdate()}};this.getGruuFromPubGruu=function(k){k=k.split(";gr=");if(k.length!=2){console.debug('Invalid pub-gruu received.  Unable to extract GRUU. pub-gruu="'+k+'"');return("GRUU-Unknown")}return(k[1])};this.getSipUriFromPubGruu=function(k){k=k.split(";gr=");if(k.length!=2){console.debug('Invalid pub-gruu received.  Unable to extract sip-uri. pub-gruu="'+k+'"');return("sip-uri-Unknown")}return(k[0])};this.sendSubscribeDialog=function(m){console.debug("sendSubscribeDialog(), sipUri = <"+m+">");var l,k,n;l=new sip.UserAgent(this.stack);l.remoteParty=new sip.Address(m);l.localParty=new sip.Address(this.localAOR);k=l.createRequest("SUBSCRIBE");n=this.createContactHeader("SUBSCRIBE");k.setItem("Contact",n);k.setItem("Event",new sip.Header("dialog","Event"));k.setItem("Supported",new sip.Header("gruu","Supported"));k.setItem("User-Agent",new sip.Header(this.userAgent,"User-Agent"));k.setItem("Expires",new sip.Header("3600","Expires"));l.sendRequest(k)};this.receivedSubscribeDialogResponse=function(l,k){console.debug("Session.receivedSubscribeDialogResponse() response "+k.response)};this.receivedDialogNotify=function(m,n){var l=m.createResponse(200,"OK");var k=this.createContactHeader("200 OK");l.setItem("Contact",k);l.setItem("User-Agent",new sip.Header(this.userAgent,"User-Agent"));m.sendResponse(l);this.session.mdsp.onDialogNotify(n.body)};this.authenticate=function(l,m,k){console.debug("authenticate() username = "+this.token.id+", password = "+this.token.key+", authtype = "+this.token.authtype);if(this.token.authtype==="Token-Auth"){this.setSessionStatus(SessionStatus.AUTHENTICATING);return false}else{m.username=this.token.id;m.password=this.token.key;if(!(m.hasItem("algorithm"))){m.algorithm="MD5"}return true}};this.createServer=function(m,l,k){console.debug("createServer() create new UAS instance for method = "+m.method);return(m.method!=="CANCEL"?new sip.UserAgent(k,m):null)};this.dialogCreated=function(m,l,k){var o,n;o=m.callId;n=this.session.getCall(o);if(n!==null){if(l===n.uaCall){n.uaCall=m}}else{console.warn("Session.dialogCreated() A dialog has been created but it's not linked with any created Call instance")}};this.cancelled=function(l,o,k){console.debug("Session.cancelled()");var n,m;n=o.getItem("call-id").value;m=this.getCall(n);if(m!==null){m.cancelled(l,o,k)}else{console.warn("Session.canceled() A request has been canceled, but it's not linked with any created Call instance")}};this.sendDTMFSip=function(n,l){var p,o,k;console.debug("sendDTMFSip "+l);var m=n.session.config.providerConfig.dtmfDuration;console.debug("sendDTMFSip dtmfDuration: "+m);if(n.uaCall){if(typeof l!=="string"||l.length!==1){console.error("sendDTMFSip() Input must be a single DTMF character.");return}p="1234567890#*ABCDabcd";if(p.indexOf(l)<0){console.error('sendDTMFSip() Character "'+l+'" is not a DTMF tone, ignoring.');return}o=n.uaCall.createRequest("INFO");k=this.createContactHeader("INFO");o.setItem("Contact",k);if(this.userAgent){o.setItem("User-Agent",new sip.Header(this.userAgent,"User-Agent"))}o.setItem("Content-Type",new sip.Header("application/dtmf-relay","Content-Type"));body="Signal="+l+"\r\n";body=body+"Duration="+m+"\r\n";o.setBody(body);n.uaCall.sendRequest(o)}};this.resolve=function(o,n,r,l){console.debug("Entered resolve() host = "+o+" type = "+n);var k=this.config.uri.lastIndexOf("//");if(k>-1){k+=1}var q=this.config.uri.lastIndexOf(":");var p=this.config.uri.substring(k+1,q);console.debug("resolve() ip_address = "+p);dns_candidate=new Object();dns_candidate.address=p;var m=new Array();m[0]=dns_candidate;r(o,m)};this.sendPageModeChatMessage=function(s,p,r){var o,l,n,k,q,m;o=new sip.UserAgent(this.stack);if(p.length===1){o.remoteParty=new sip.Address(p[0])}else{o.remoteParty=new sip.Address(this.session.config.providerConfig.conferenceFactoryURI)}o.localParty=new sip.Address(this.localAOR);if(this.config.providerConfig.breaker){o.breaker=true}l=o.createRequest("MESSAGE");s.callId=l.getItem("call-id").value;n=new sip.Header((new sip.Address(this.localAOR)).uri.toString(),"Contact");n.setItem("gr",this.session.instanceId);l.setItem("User-Agent",new sip.Header(this.userAgent,"User-Agent"));if(p.length===1){l.setItem("Content-Type",new sip.Header("text/plain","Content-Type"));l.setBody(r)}else{k=new c();for(q=0;q<p.length;q+=1){k.addResource({uri:p[q]})}m=new b();m.addPart({contentType:"text/plain",data:r});m.addPart({contentType:"application/resource-lists+xml",contentDisposition:"recipient-list",data:k.toString()});l.setItem("Content-Type",new sip.Header("multipart/mixed;boundary="+m.getBoundary(),"Content-Type"));l.setItem("Require",new sip.Header("recipient-list-invite","Require"));l.setBody(m.toString())}o.sendRequest(l)};this.sendSmsMessage=function(v,s,k,t,u){console.info("sipAdapter.sendSmsMessage");var q,n,p,l,r,o;q=new sip.UserAgent(this.stack);if(s.length===1){q.remoteParty=new sip.Address(s[0])}else{q.remoteParty=new sip.Address(this.session.config.providerConfig.conferenceFactoryURI)}q.localParty=new sip.Address(this.localAOR);if(this.config.providerConfig.breaker){q.breaker=true}n=q.createRequest("MESSAGE");v.callId=n.getItem("call-id").value;p=new sip.Header((new sip.Address(this.localAOR)).uri.toString(),"Contact");p.setItem("gr",this.session.instanceId);n.setItem("User-Agent",new sip.Header(this.userAgent,"User-Agent"));var m="";m+="From: <"+this.localAOR+">\r\n";m+="To: <"+s[0]+">\r\n";m+="DateTime:"+t+"\r\n";m+="NS: imdn <urn:ietf:params:imdn>\r\n";m+="imdn.Message-ID:"+k+"\r\n";m+="imdn.Disposition-Notification: positive-delivery, negative-delivery\r\n";m+="Content-type: text/plain\r\n";m+="Content-Length:"+u.length+"\r\n\r\n";m+=u+"\r\n";console.info(m.length);if(s.length===1){n.setItem("Content-Type",new sip.Header("message/cpim","Content-Type"));n.setBody(m)}else{console.info("multiple dest")}q.sendRequest(n)};this.sendSmsIMDNMessage=function(y,v,k,p,x){console.info("sipAdapter.sendSmsIMDNMessage");var s,o,r,l,u,q;s=new sip.UserAgent(this.stack);if(v.length===1){s.remoteParty=new sip.Address(v[0])}else{s.remoteParty=new sip.Address(this.session.config.providerConfig.conferenceFactoryURI)}s.localParty=new sip.Address(this.localAOR);if(this.config.providerConfig.breaker){s.breaker=true}o=s.createRequest("MESSAGE");y.callId=o.getItem("call-id").value;r=new sip.Header((new sip.Address(this.localAOR)).uri.toString(),"Contact");r.setItem("gr",this.session.instanceId);o.setItem("User-Agent",new sip.Header(this.userAgent,"User-Agent"));var m=this.localAOR.indexOf(":");var t="";if(m>=0){t="im:"+this.localAOR.substr(m+1)}else{t="im:"+this.localAOR}var w='<?xml version="1.0" encoding="UTF-8"?>\r\n<imdn xmlns="urn:ietf:params:xml:ns:imdn">\r\n<message-id>'+k+"</message-id>\r\n<datetime>"+x+"</datetime>\r\n<recipient-uri>"+t+"</recipient-uri>\r\n<original-recipient-uri>"+t+"</original-recipient-uri>\r\n<delivery-notification>\r\n<status><"+p+"/></status>\r\n</delivery-notification>\r\n</imdn>\r\n";var n="";n+="From: <"+this.localAOR+">\r\n";n+="To: <"+v[0]+">\r\n";n+="NS: imdn <urn:ietf:params:imdn>\r\n";n+="imdn.Message-ID:"+k+"\r\n";n+="Content-type: message/imdn+xml\r\n";n+="Content-Disposition: notification\r\n";n+="Content-Length:"+w.length+"\r\n\r\n";n+=w+"\r\n";console.info(n.length);if(v.length===1){o.setItem("Content-Type",new sip.Header("message/cpim","Content-Type"));o.setBody(n)}else{console.info("multiple dest")}s.sendRequest(o)};this.sendUpdatePresence=function(o,n,l,r){var q,p,k,m;clearTimeout(this.presenceRefreshTimer);if(n&&this.presencePendingUpdates.length>0){return}if(r&&!this.presenceEtag){return}if(o===true){console.info("sendUpdatePresence() Use a default online presence XML");o='<?xml version="1.0" encoding="UTF-8"?>\r\n<presence xmlns="urn:ietf:params:xml:ns:pidf" entity="'+this.localAOR+'">\r\n\t<tuple id="orca1">\r\n\t\t<status>\r\n\t\t\t<basic>open</basic>\r\n\t\t</status>\r\n\t\t<contact priority="0.8">'+this.localAOR+'</contact>\r\n\t\t<note xml:lang="en">Logged in with Orca ALU</note>\r\n\t\t<timestamp>'+(new Date()).toISOString()+"</timestamp>\r\n\t</tuple>\r\n</presence>\r\n"}else{if(o===false){console.info("sendUpdatePresence() Use a default offline presence XML");o='<?xml version="1.0" encoding="UTF-8"?>\r\n<presence xmlns="urn:ietf:params:xml:ns:pidf" entity="'+this.localAOR+'">\r\n\t<tuple id="orca1">\r\n\t\t<status>\r\n\t\t\t<basic>closed</basic>\r\n\t\t</status>\r\n\t\t<contact priority="0.8">'+this.localAOR+'</contact>\r\n\t\t<note xml:lang="en">Logged in with Orca ALU</note>\r\n\t\t<timestamp>'+(new Date()).toISOString()+"</timestamp>\r\n\t</tuple>\r\n</presence>\r\n"}}this.presencePendingUpdates.push(o);if(!l&&this.presencePendingUpdates.length>1){return}q=new sip.UserAgent(this.stack);q.remoteParty=new sip.Address(this.localAOR);q.localParty=new sip.Address(this.localAOR);p=q.createRequest("PUBLISH");k=new sip.Header((new sip.Address(this.localAOR)).uri.toString(),"Contact");k.value.uri.param.gr=this.session.mdsp.myOwnGruu;p.setItem("Contact",k);p.setItem("Event",new sip.Header("presence","Event"));p.setItem("User-Agent",new sip.Header(this.userAgent,"User-Agent"));p.setItem("Content-Type",new sip.Header((""+o).toLowerCase().indexOf("pidf-diff")>-1?"application/pidf-diff+xml":"application/pidf+xml","Content-Type"));if(this.presenceEtag){p.setItem("SIP-If-Match",new sip.Header(this.presenceEtag,"SIP-If-Match"))}if(o){p.setBody(o)}if(!n&&this.presenceEtag){this.presenceEtag=undefined}if(r){p.setItem("Expires",new sip.Header("0","Expires"))}else{if(this.presenceExpires>0){p.setItem("Expires",new sip.Header(""+this.presenceExpires,"Expires"))}}q.sendRequest(p)};this.receivedUpdatePresenceResponse=function(n,m){console.debug("Session.receivedUpdatePresenceResponse() response "+m.response);var p=this.presencePendingUpdates.shift(),l=this,o,k=0;if(p===undefined){console.warn("receivedUpdatePresenceResponse() Original request not found");p=""}if(m.is2xx()){o=m.getItem("SIP-ETag");if(o){this.presenceEtag=o.value}else{this.presenceEtag=undefined}o=m.getItem("Expires");if(o){k=parseInt(o.value);if(k>0){this.presenceExpires=k}}if(k>0&&this.presencePendingUpdates.length===0){this.presenceRefreshTimer=setTimeout(function(){l.sendUpdatePresence("",true)},((k>1200)?(k-600):(k/2))*1000)}this.session.onUpdatePresenceSuccess({name:SessionStatus.UPDATEPRESENCESUCCESS,content:p})}else{if(this.presencePendingUpdates.length===0){if(m.response===412&&this.presenceEtag!=undefined){this.presenceEtag=undefined;this.sendUpdatePresence(p,true);return}if(m.response===423){this.presenceExpires=parseInt(m.getItem("Min-Expires").value);this.sendUpdatePresence(p,true);return}}this.session.onUpdatePresenceFail({name:SessionStatus.UPDATEPRESENCEFAIL,content:p})}if(this.presencePendingUpdates.length>0){this.sendUpdatePresence(this.presencePendingUpdates[0],false,true)}};this.sendSubscribePresence=function(o,l){var n,m,k;n=new sip.UserAgent(this.stack);n.remoteParty=new sip.Address(o);n.localParty=new sip.Address(this.localAOR);m=n.createRequest("SUBSCRIBE");k=new sip.Header((new sip.Address(this.localAOR)).uri.toString(),"Contact");m.setItem("Contact",k);m.setItem("Event",new sip.Header("presence","Event"));m.setItem("Accept",new sip.Header("application/rlmi+xml, application/pidf+xml, application/pidf-diff+xml","Accept"));m.setItem("Supported",new sip.Header("eventlist","Supported"));m.setItem("User-Agent",new sip.Header(this.userAgent,"User-Agent"));if(l!=undefined){m.setItem("Expires",new sip.Header(""+l,"Expires"))}else{m.setItem("Expires",new sip.Header(""+this.presenceExpires,"Expires"))}n.sendRequest(m)};this.receivedSubscribePresenceResponse=function(l,o){console.debug("Session.receivedSubscribePresenceResponse() response "+o.response);var n=0;var s=o.getItem("Expires");if(s){n=parseInt(s.value)}var k,q,r,p,m;q=o.getItem("From").value.uri.toString();r=o.getItem("To").value.uri.toString();p=o.getItem("Call-ID").value;m=o.getItem("CSeq").value;console.log("receivedSubscribePresenceResponse(). from: "+q+", to: "+r+", callId: "+p+", cSeq: "+m);k={responseCode:o.responseText,from:q,to:r,callId:p,cSeq:m,expires:n};if(o.is2xx()){if(n>0){this.session.onSubscribePresenceSuccess(k)}else{this.session.onGetPresenceSuccess(k)}}else{if(n>0){this.session.onSubscribePresenceFailed(k)}else{this.session.onGetPresenceFailed(k)}}};this.receivedPresenceNotify=function(m,t){var w,x,u,o;w=t.getItem("From").value.uri.toString();x=t.getItem("To").value.uri.toString();u=t.getItem("Call-ID").value;o=t.getItem("CSeq").value;var q=this.session.getPresenceSubscription(w,u,o);if(!q){console.warn("receivedPresenceNotify() no subscribe found");m.sendResponse(m.createResponse(481,"Subscription does not exist"))}else{var s=m.createResponse(200,"OK");contact=new sip.Header((new sip.Address(this.localAOR)).uri.toString(),"Contact");s.setItem("Contact",contact);s.setItem("User-Agent",new sip.Header(this.userAgent,"User-Agent"));m.sendResponse(s);var l,p,k,y=null,v,n;p=t.getItem("Subscription-State").value;var k=parseInt(t.getItem("Content-Length").value);if(k>0){var r=t.getItem("Content-Type");if(r){y=r.value;v=r.type;n=r.boundary}}l={from:w,to:x,callId:u,cSeq:o,subscriptionState:p,contentLength:k,contentType:y,contentType_type:v,boundary:n};this.session.onPresenceNotify(t.body,l)}};this.createAndSendInviteRequest=function(s,q,l){console.debug("Call.createAndSendInviteRequest()");var m,o,k,r,n;if(s.pullCallInfo!=undefined){q.length=0;q.push(s.session.mdsp.getToUriForPull(s.pullCallInfo))}if(s.uaCall===null){s.uaCall=new sip.UserAgent(this.stack);if(q.length===1){s.uaCall.remoteParty=new sip.Address(q[0])}else{s.uaCall.remoteParty=new sip.Address(this.session.config.providerConfig.conferenceFactoryURI)}s.uaCall.localParty=new sip.Address(this.localAOR);if(this.config.providerConfig.breaker){s.uaCall.breaker=true}}if(s.restoredCall){s.uaCall.stack=this.stack}m=s.uaCall.createRequest("INVITE");if(s.pullCallInfo!=undefined){m.uri.user=s.session.mdsp.getRequestUriUserForPull()}s.callId=m.getItem("call-id").value;o=this.createContactHeader("INVITE");m.setItem("Contact",o);m.setItem("User-Agent",new sip.Header(this.userAgent,"User-Agent"));if(l!==undefined){if(q.length===1){m.setItem("Content-Type",new sip.Header("application/sdp","Content-Type"));m.setBody(l)}else{k=new c();for(r=0;r<q.length;r+=1){k.addResource({uri:q[r]})}n=new b();n.addPart({contentType:"application/sdp",data:l});n.addPart({contentType:"application/resource-lists+xml",contentDisposition:"recipient-list",data:k.toString()});m.setItem("Content-Type",new sip.Header("multipart/mixed;boundary="+n.getBoundary(),"Content-Type"));m.setItem("Require",new sip.Header("recipient-list-invite","Require"));m.setBody(n.toString())}}if(s.pullCallInfo!=undefined){var p=s.session.mdsp.getReplacesUriForPull(s.pullCallInfo);m.setItem("Replaces",new sip.Header(p,"Replaces"))}s.uaCall.sendRequest(m)};this.sendInviteResponse=function(o,p,m,l){console.debug("sendInviteResponse()");if(!o.uaCall){console.error("uaCall is null");return}if(p!==200){o.uaCall.sendResponse(o.uaCall.createResponse(p,m));return}var n,k;n=o.uaCall.createResponse(200,"OK");k=this.createContactHeader("200 OK");n.setItem("Contact",k);n.setItem("Content-Type",new sip.Header("application/sdp","Content-Type"));n.setItem("User-Agent",new sip.Header(this.userAgent,"User-Agent"));if(l!==undefined){n.setItem("Content-Type",new sip.Header("application/sdp","Content-Type"));n.setBody(l)}o.uaCall.sendResponse(n)};this.sendPageModeChatMessageResponse=function(o,n,l){console.debug("sendMessageResponse()");if(!o){console.error("uaCall is null");return}if(n!==200){o.sendResponse(o.createResponse(n,l));return}var m,k;m=o.createResponse(200,"OK");k=new sip.Header((new sip.Address(this.localAOR)).uri.toString(),"Contact");k.value.uri.param.gr=this.session.mdsp.myOwnGruu;m.setItem("Contact",k);m.setItem("User-Agent",new sip.Header(this.userAgent,"User-Agent"));o.sendResponse(m)};this.sendSmsMessageResponse=function(o,n,l){console.debug("sendSmsMessageResponse()");if(!o){console.error("uaCall is null");return}if(n!==200){o.sendResponse(o.createResponse(n,l));return}var m,k;m=o.createResponse(200,"OK");k=new sip.Header((new sip.Address(this.localAOR)).uri.toString(),"Contact");k.value.uri.param.gr=this.session.mdsp.myOwnGruu;m.setItem("Contact",k);m.setItem("User-Agent",new sip.Header(this.userAgent,"User-Agent"));o.sendResponse(m)};this.sendSmsIMDNMessageResponse=function(o,n,l){console.debug("sendSmsIMDNMessageResponse()");if(!o){console.error("uaCall is null");return}if(n!==200){o.sendResponse(o.createResponse(n,l));return}var m,k;m=o.createResponse(200,"OK");k=new sip.Header((new sip.Address(this.localAOR)).uri.toString(),"Contact");k.value.uri.param.gr=this.session.mdsp.myOwnGruu;m.setItem("Contact",k);m.setItem("User-Agent",new sip.Header(this.userAgent,"User-Agent"));o.sendResponse(m)};this.getRouteHeader=function(l){var k=this.config.uri.split("/")[2].trim()+";transport="+this.transport;return new sip.Header("<sip:"+(l?l+"@":"")+k+";lr>","Route")};this.receivedInvite=function(m,n,o){console.debug("Call.receivedInvite");var k=n.first("From").value.uri.toString();var l={name:"invitation",callId:m.callId,from:k,sdp:n.body,uaCall:m,uaString:n.first("User-Agent").value};this.session.incomingSessionEvent(l)};this.receivedPageModeChatMessage=function(m,n){console.log("Call.received page mode chat message");var k=n.first("From").value.uri.toString();console.log("From: "+k);var l={name:"message",callId:m.callId,from:k,message:n.body,uaCall:m,uaString:n.first("User-Agent").value,contentType:n.getItem("Content-Type").value};this.session.incomingSessionEvent(l)};this.receivedSmsMessage=function(m,o){console.log("Call.receivedSmsMessage sms message");var k=o.first("From").value.uri.toString();var q=this.parseGetMessageBody(o.body);console.log("From: "+k);console.log("message: "+q);var n=this.parseGetMessageImdnID(m.request.body);var p=this.parseGetMessageDateTime(m.request.body);console.log("imdnMessageID: "+n);console.log("dateTime: "+p);var l={name:"message",callId:m.callId,from:k,message:q,uaCall:m,uaString:o.first("User-Agent").value,contentType:o.getItem("Content-Type").value,bodyContentType:"text/plain",imdnMessageID:n,dateTime:p};this.session.incomingSessionEvent(l)};this.receivedSmsIMDNMessage=function(m,n){console.log("Call.receivedSmsIMDNMessage sms imdn message");var k=n.first("From").value.uri.toString();console.log("From fromAddr: "+k);console.log("message: "+n.body);var p=this.parseGetMessageBody(n.body);var o=new Object();this.parseElemImdnMessage(p,o);console.log("xml messageId: "+o.messageId);console.log("xml datetime: "+o.datetime);console.log("xml status: "+o.status);var l={name:"message",callId:m.callId,from:k,message:n.body,uaCall:m,uaString:n.first("User-Agent").value,contentType:n.getItem("Content-Type").value,bodyContentType:"message/imdn+xml",messageBody:p,imdnMessageID:o.messageId,dateTime:o.datetime,status:o.status};this.session.incomingSessionEvent(l)};this.parseElemImdnMessage=function(l,p){if(window.DOMParser){var r=new DOMParser();var o=r.parseFromString(l,"application/xml");var m=o.getElementsByTagName("message-id")[0].childNodes[0].nodeValue;var q=o.getElementsByTagName("datetime")[0].childNodes[0].nodeValue;var n=o.getElementsByTagName("status")[0];this.cleanWhitespace(n);var k="";if(n.childNodes[0] instanceof Element){console.info("childNode is element");k=o.getElementsByTagName("status")[0].childNodes[0].tagName}else{if(n.childNodes[0] instanceof Text){console.info("childNodes is text")}}p.messageId=m;p.datetime=q;p.status=k;console.log("xml messageId: "+m);console.log("xml datetime: "+q);console.log("xml status: "+k)}};this.cleanWhitespace=function(l){for(var k=0;k<l.childNodes.length;k++){var m=l.childNodes[k];if(m.nodeType==3&&!/\S/.test(m.nodeValue)){m.parentNode.removeChild(m)}}};this.parseGetMessageBody=function(m){var l=m.indexOf("\r\n\r\n");var k="";if(l>=0){k=m.substr(l+4)}return k};this.parseGetMessageFrom=function(p){var q=p.indexOf("From:");var m="";var r="";if(q>=0){m=p.substr(q);var l=m.indexOf("\r\n");var o=m.substring(5,l).trim();console.info("fromStr: "+o);var k=o.indexOf("<");var n=o.indexOf(">");if(k>=0){r=o.substring(k+1,n)}else{r=o}}return r};this.parseGetMessageContentType=function(m){var n=m.indexOf("Content-type:");var l="";var o="";if(n>=0){l=m.substr(n);var k=l.indexOf("\r\n");o=l.substring(13,k)}return o};this.parseGetMessageImdnID=function(n){var m=n.indexOf("imdn.Message-ID:");var l="";var o="";if(m>=0){l=n.substr(m);var k=l.indexOf("\r\n");o=l.substring(16,k)}return o};this.parseGetMessageDateTime=function(l){var n=l.indexOf("DateTime:");var m="";var o="";if(n>=0){m=l.substr(n);var k=m.indexOf("\r\n");o=m.substring(9,k)}return o};this.receivedAck=function(k,n){console.debug("Call.receivedAck()");var m;var l=this.session.getCall(k.callId);if(l){if(n.body!==undefined&&n.body!==null){m={name:"confirmed",sdp:n.body}}else{m={name:"confirmed"}}l.incomingCallSessionEvent(m)}};this.receivedInfo=function(k,l){console.debug("receivedInfo() auto respond");k.sendResponse(k.createResponse(200,"OK"))};this.receivedNotify=function(k,n){var l=this.session.getCall(k.callId);if(!l){console.warn("receivedNotify() no call found");k.sendResponse(k.createResponse(200,"OK"));return}k.sendResponse(k.createResponse(200,"OK"));var m=n.getItem("event").value;switch(m){case"refer":break;case"conference":break;default:console.debug("receivedNotify() event not supported: "+m);break}};this.receivedBye=function(k,m){console.debug("Call.receivedBye()");var l=this.session.getCall(k.callId);if(!l){console.warn("receivedBye() no call found");return}if(l.uaCall){l.terminatedCallSessionEvent({name:CallStatus.DISCONNECTED});k.sendResponse(k.createResponse(200,"OK"))}};this.receivedInviteResponse=function(o,n,m){console.debug("Call.receivedInviteResponse() response "+m.response);var p,l,k;if(m.is1xx()){if(m.response!==100){console.debug("Call.receivedInviteResponse() Progressing [response = "+m.response+", text = "+m.responsetext+"]");if(m.response>=180){p={name:CallStatus.CONNECTING};o.ringingCallSessionEvent(p)}}return}if(!m.is2xx()){p={name:CallStatus.REJECTED};o.rejectedCallSessionEvent(p);return}p={name:CallStatus.CONNECTED};p.sdp=m.body;o.acceptedCallSessionEvent(p)};this.receivedPageModeMessageResponse=function(l,k){console.debug("Call.receivedPageModeMessageResponse() response "+k.response);event={callId:l.callId};if(!k.is2xx()){this.session.onPageModeChatMessageFailed(event)}else{this.session.onPageModeChatMessageSent(event)}};this.receivedSmsMessageResponse=function(l,k){console.debug("Call.receivedSmsMessageResponse() response "+k.response);var m=this.parseGetMessageImdnID(l.request.body);var n=this.parseGetMessageDateTime(l.request.body);var p=k.getItem("From").value.uri.toString();var o=k.getItem("To").value.uri.toString();console.log("imdnMessageID: "+m);console.log("dateTime: "+n);console.log("from: "+p);event={callId:l.callId,from:p,imdnMessageID:m,dateTime:n};if(!k.is2xx()){this.session.onSmsMessageFailed(event)}else{this.session.onSmsMessageSent(event)}};this.receivedSmsIMDNMessageResponse=function(l,k){console.debug("Call.receivedSmsIMDNMessageResponse() response "+k.response);var p=k.getItem("From").value.uri.toString();var o=k.getItem("To").value.uri.toString();console.log("from: "+p);var n=this.parseGetMessageBody(l.request.body);var m=new Object();this.parseElemImdnMessage(n,m);console.log("imdnMessageID: "+m.messageId);console.log("dateTime: "+m.datetime);console.log("status: "+m.status);event={callId:l.callId,from:p,imdnMessageID:m.messageId,dateTime:m.datetime,status:m.status};if(!k.is2xx()){this.session.onSmsIMDNMessageFailed(event)}else{this.session.onSmsIMDNMessageSent(event)}};this.receivedByeResponse=function(m,l,k){console.debug("receivedByeResponse()");var n={name:CallStatus.DISCONNECTED};m.terminatedCallSessionEvent(n)};this.doRefer=function(l,n,o){console.debug("doRefer() uri="+n+", isAdded="+o);if(l.uaCall===null){return}var m=l.uaCall.createRequest("REFER");var k=this.createContactHeader("REFER");m.setItem("Contact",k);if(this.userAgent){m.setItem("User-Agent",new sip.Header(this.userAgent,"User-Agent"))}if(o===true){m.setItem("Refer-To",new sip.Header(n,"Refer-To"))}else{m.setItem("Refer-To",new sip.Header("<"+n+";method=BYE>","Refer-To"))}l.uaCall.sendRequest(m)};this.doPush=function(l,k,m){this.doRefer(l,"<"+k+";gr="+m+">",true)};this.cancelled=function(k){console.debug("Call.cancelled()");var l=this.session.getCall(k.callId);if(l&&l.uaCall&&l.uaCall.servers[0]&&k===l.uaCall.servers[0].app){l.incomingCallSessionEvent({name:"canceled"})}else{console.warn("Call.canceled() Invalid User Agent for cancel")}};this.cancel=function(k){console.debug("Call.cancel()");if(k&&k.uaCall){k.uaCall.sendCancel()}else{console.warn("Call.cancel() user agent is not instancied")}};this.bye=function(k){console.debug("bye()");if(k&&k.uaCall){var l=k.uaCall.createRequest("BYE");k.uaCall.sendRequest(l)}else{console.warn("Call.bye() user agent is not instancied")}}}function c(f){var i="to",h="cc",e="bcc",g=[];this.parse=function(l){var k,o,n,p,m,j;if(window.DOMParser){p=new DOMParser();m=p.parseFromString(l,"text/xml");j=m.getElementsByTagName("entry");for(k=0;k<j.length;k+=1){o=false;if(j[k].getAttribute("cp:anonymize")==="true"){o=true}if(o!==true){n={uri:j[k].getAttribute("uri"),copyControl:j[k].getAttribute("cp:copyControl"),anonymous:o};g.push(n)}}}};this.addResource=function(j){if(j.copyControl===undefined){j.copyControl="to"}if(j.anonymous===undefined){j.anonymous=false}g.push(j)};this.getResources=function(){return g};this.delResource=function(l){var j,k;for(j=0;j<g.length;j+=1){k=g[j].uri;if(l.uri===k){g.splice(j,1);return}}};this.toString=function(){var k="",j=this.toXML();if(j.xml){k=j.xml}else{k=(new XMLSerializer()).serializeToString(j)}return k};this.toXML=function(){var m,r,j,q,p,k,n,o,l;m='<?xml version="1.0" encoding="UTF-8"?>';m=m+'<resource-lists xmlns="urn:ietf:params:xml:ns:resource-lists" xmlns:cp="urn:ietf:params:xml:ns:copyControl">';m=m+"<list>";m=m+"</list>";m=m+"</resource-lists>";if(window.DOMParser){j=new DOMParser();r=j.parseFromString(m,"text/xml")}else{r=new ActiveXObject("Microsoft.XMLDOM");r.async=false;r.loadXML(m)}for(q=0;q<g.length;q+=1){p=r.createElement("entry");k=document.createAttribute("uri");k.value=g[q].uri;p.setAttributeNode(k);n=document.createAttribute("cp:copyControl");n.value=g[q].copyControl;p.setAttributeNode(n);if(g[q].anonymous===true){o=document.createAttribute("cp:anonymize");o.value="true";p.setAttributeNode(o)}l=r.getElementsByTagName("list")[0];l.appendChild(p)}return r};if(f!==undefined){this.parse(f)}}function b(){var f,e=[];this.createBoundary=function(){var j="0123456789ABCDEFGHIJKLMNOPQRSTUVWXTZabcdefghiklmnopqrstuvwxyz",k=16,l="",h,g;for(h=0;h<k;h+=1){g=Math.floor(Math.random()*j.length);l+=j.substring(g,g+1)}return l};this.getBoundary=function(){return f};this.toString=function(){var h,g;h="";if(e.length!==0){h="--"+f+"\r\n";for(g=0;g<e.length;g+=1){h=h+"Content-Type: "+e[g].contentType;if(e[g].contentDisposition!==undefined){h=h+"\r\nContent-Disposition: "+e[g].contentDisposition}h=h+"\r\n\r\n";h=h+e[g].data;if(g===e.length-1){h=h+"\r\n--"+f+"--\r\n"}else{h=h+"\r\n--"+f+"\r\n"}}}return h};this.addPart=function(g){var h;if(g.contentType===undefined){h=new Error();h.message="Content-Type not defined";throw h}if(g.data===undefined){h=new Error();h.message="data not defined";throw h}e.push(g)};f=this.createBoundary()}function a(f,g,e){this.messageId=f;this.datetime=g;this.status=e}orcaALU.SipAdapter=d}());

// orca/restAdapter.js
(function(){function b(f,e,d,c,h){var g=null;this.userId=e;this.session=h;this.config=c;this.token=d;this.ws=f;this.registerURL="/vvoip/v1/user001/registrations";this.callURL="/vvoip/v1/user001/sessions";this.updateToken=function(i){console.debug("restAdapter.updateToken");this.token.key=i};this.regResourceURL=null;this.setSessionStatus=function(i){console.debug("RestAdapter.setSessionStatus() session status: "+i);this.session.setSessionStatus(i)};this.createSession=function(){console.debug("RestAdapter.createSession()");this.sendRegister();this.setSessionStatus(SessionStatus.CONNECTING)};this.terminateSession=function(){console.debug("RestAdapter.terminateSession()");this.setSessionStatus(SessionStatus.DISCONNECTED);this.ws.close()};this.createCallSession=function(k,j,i,l){console.debug("RestAdapter.createCallSession() to "+j);if(j.length===1){this.createVvoipSession(k,j[0],"Anonymous",i)}else{if(j.length>1){console.error("not support conference now");if(k){k.terminatedCallSessionEvent({name:CallStatus.DISCONNECTED})}return}else{console.error("address unsupported. "+typeof(j))}}};this.acceptCallSession=function(j,i){console.debug("RestAdapter.acceptCallSession()");if(j.uaCall.isOfferless){this.answerOfferlessVvoipSession(j,i);j.uaCall.isOfferless=false}else{this.answerVvoipSession(j,i)}this.updateVvoipSessionStatus(j,"Connected");j.incomingCallSessionEvent({name:"confirmed"})};this.rejectCallSession=function(j,k,i){console.debug("RestAdapter.rejectCallSession()");this.terminateVvoipSessoin(j)};this.cancelCallSession=function(i){console.debug("RestAdapter.cancelCallSession()");this.terminateVvoipSessoin(i)};this.terminateCallSession=function(i){console.debug("RestAdapter.terminateCallSession()");this.terminateVvoipSessoin(i)};this.cleanCallSession=function(i){console.debug("RestAdapter.cleanCallSession()")};this.sendResponse=function(k,l,j,i){console.debug("RestAdapter.sendResponse: "+l);if(l===180){this.updateVvoipSessionStatus(k,"Ringing")}else{if(l===200){this.acceptCallSession(k,i)}else{this.terminateVvoipSessoin(k)}}};this.sendRegister=function(){var j={vvoipRegistration:{userId:e,token:d.id}};var i=new a(this.ws);i.send("POST",this.registerURL,JSON.stringify(j));this.request=i};this.sendActiveQuery=function(){if(!this.regResourceURL||this.regResourceURL.length<1){console.error("Empty regResourceURL!");return}var i=new a(this.ws);if(this.regResourceURL.indexOf("ws")>-1){this.regResourceURL=this.regResourceURL.replace(/ws.*:\/\//,"/")}i.send("GET",this.regResourceURL+"/notifications")};this.createVvoipSession=function(l,n,k,j){var m={vvoipSession:{tParticipantAddress:n,tParticipantName:k,offer:{sdp:j}}};var i=new a(this.ws);i.send("POST",this.callURL,JSON.stringify(m));l.uaCall=i;l.callId=1};this.answerVvoipSession=function(l,j){var k={vvoipAnswer:{sdp:j}};if(!l.uaCall){var i=new a(this.ws);l.uaCall=i}l.uaCall.send("PUT",l.uaCall.callResourceURL,JSON.stringify(k))};this.answerOfferlessVvoipSession=function(l,k){var i={vvoipOffer:{sdp:k}};if(!l.uaCall){var j=new a(this.ws);l.uaCall=j}l.uaCall.send("PUT",l.uaCall.callResourceURL,JSON.stringify(i))};this.updateVvoipSessionStatus=function(k,i){if(!k||!k.uaCall||!k.uaCall.callResourceURL){console.error("no call to update");if(k){k.terminatedCallSessionEvent({name:CallStatus.DISCONNECTED})}return}var j={vvoipSessionStatus:{status:i}};k.uaCall.send("PUT",k.uaCall.callResourceURL,JSON.stringify(j))};this.terminateVvoipSessoin=function(i){if(!i||!i.uaCall||!i.uaCall.callResourceURL){console.warn("no call to terminate");if(i){i.terminatedCallSessionEvent({name:CallStatus.DISCONNECTED})}return}i.uaCall.send("DELETE",i.uaCall.callResourceURL)};this.received=function(m){var j=m.match(/HTTP\/1.1 (\d{3}) (.*)/);if(!j||j.length<3){console.error("Unexpected response: "+m);return}console.debug("received response: "+j[1]+" "+j[2]);var k;var i=null;if(m.indexOf("\r\n\r\n")!==-1){i=m.substring(m.indexOf("\r\n\r\n")+2)}if(i&&i.trim().length>2){k=JSON.parse(i)}else{console.debug("Empty payload");k=null}if(m.indexOf("Connection:")!==-1){this.sendActiveQuery();if(!k){console.debug("Empty notification");return}this.notifyCallback(k)}else{if(!k){var l=this.session.getCall(1);if(l){l.terminatedCallSessionEvent({name:CallStatus.DISCONNECTED})}return}if(k.vvoipRegistration){this.regResourceURL=k.vvoipRegistration.resourceURL;this.sendActiveQuery()}else{if(k.vvoipSession){var l=this.session.getCall(1);if(l&&l.uaCall){l.uaCall.callResourceURL=k.vvoipSession.resourceURL}}else{console.log("response: "+i)}}}};this.notifyCallback=function(j){console.debug("received vvoip event notification: "+j);if(j.vvoipRegEventNotification){console.debug("received vvoipRegEventNotification");if(j.vvoipRegEventNotification.eventType==="RegSuccess"){this.setSessionStatus(SessionStatus.CONNECTED)}else{this.setSessionStatus(SessionStatus.DISCONNECTED)}return}else{if(j.vvoipSessionInvitationNotification){console.debug("received vvoipSessionInvitationNotification");var i=new a(this.ws);i.callResourceURL=j.vvoipSessionInvitationNotification.link.href;var m;if(j.vvoipSessionInvitationNotification.offer&&j.vvoipSessionInvitationNotification.offer.sdp){m={name:"invitation",callId:1,from:j.vvoipSessionInvitationNotification.originatorAddress,sdp:j.vvoipSessionInvitationNotification.offer.sdp,uaCall:i}}else{i.isOfferless=true;m={name:"invitation",callId:1,from:j.vvoipSessionInvitationNotification.originatorAddress,uaCall:i}}this.session.incomingSessionEvent(m);var k=this.session.getCall(1);if(k){k.uaCall=i}else{console.error("call is null")}return}}var l=this.session.getCall(1);if(!l||!l.uaCall){console.warn("no active call to receive call notification");return}if(j.vvoipEventNotification){if(j.vvoipEventNotification.eventType==="SessionEnded"){console.debug("received SessionEnded");l.terminatedCallSessionEvent({name:CallStatus.DISCONNECTED})}else{if(j.vvoipEventNotification.eventType==="Cancelled"){console.debug("received Cancelled");l.terminatedCallSessionEvent({name:CallStatus.CANCELED})}else{if(j.vvoipEventNotification.eventType==="Declined"){console.debug("received Declined");l.rejectedCallSessionEvent({name:CallStatus.REJECTED})}else{if(j.vvoipEventNotification.eventType==="Ringing"){console.debug("received Ringing");l.ringingCallSessionEvent({name:CallStatus.CONNECTING})}else{console.warn("received unknown vvoipEventNotification!")}}}}}else{if(j.vvoipAcceptanceNotification){console.debug("received vvoipAcceptanceNotification");var m={name:CallStatus.CONNECTED,sdp:j.vvoipAcceptanceNotification.answer.sdp};l.acceptedCallSessionEvent(m)}else{if(j.vvoipOfferNotification){console.debug("received vvoipOfferNotification");var m={name:"invitation",sdp:j.vvoipOfferNotification.offer.sdp};l.incomingCallSessionEvent(m)}else{if(j.vvoipAnswerNotification){console.debug("received vvoipAnswerNotification");var m={name:"confirmed",sdp:j.vvoipAnswerNotification.answer.sdp};l.incomingCallSessionEvent(m)}else{console.debug("received unknown notification!")}}}}}}function a(c){var d={Accept:"application/json","Content-Type":"application/json"};var e=d;this.callResourceURL=null;this.ws=c;this.request=null;this.method="";this.response=null;this.responseJson=null;this.status=null;this.statusText="";this.isOfferless=false;this.setRequestHeader=function(g,f){e[g]=f};this.send=function(j,f,i){if(j==="GET"||j==="DELETE"){i=null}this.method=j;headerStr="";for(var g in e){headerStr+=g+": "+e[g]+"\r\n"}text=j+" "+f+" HTTP/1.1\r\n";text+=headerStr;if(i!==null){text+="\r\n";text+=i}console.debug("ws send:\r\n"+text);this.ws.send(text)}}orcaALU.RestAdapter=b}());

/*
Refer to the original files below for licenses of those components:
	orca/msrp-stack/LICENSE.TXT
	orca/sip.js
*/